This file is a merged representation of the entire codebase, combined into a single document by Repomix.

<file_summary>
This section contains a summary of this file.

<purpose>
This file contains a packed representation of the entire repository's contents.
It is designed to be easily consumable by AI systems for analysis, code review,
or other automated processes.
</purpose>

<file_format>
The content is organized as follows:
1. This summary section
2. Repository information
3. Directory structure
4. Repository files (if enabled)
5. Multiple file entries, each consisting of:
  - File path as an attribute
  - Full contents of the file
</file_format>

<usage_guidelines>
- This file should be treated as read-only. Any changes should be made to the
  original repository files, not this packed version.
- When processing this file, use the file path to distinguish
  between different files in the repository.
- Be aware that this file may contain sensitive information. Handle it with
  the same level of security as you would the original repository.
</usage_guidelines>

<notes>
- Some files may have been excluded based on .gitignore rules and Repomix's configuration
- Binary files are not included in this packed representation. Please refer to the Repository Structure section for a complete list of file paths, including binary files
- Files matching patterns in .gitignore are excluded
- Files matching default ignore patterns are excluded
- Files are sorted by Git change count (files with more changes are at the bottom)
</notes>

</file_summary>

<directory_structure>
public/
  vite.svg
src/
  assets/
    react.svg
  components/
    blockchain/
      ChainStatus.tsx
      index.ts
      WalletConnect.tsx
    credentials/
      CredentialCard.tsx
      CredentialDetailModal.tsx
      CredentialsList.tsx
      index.ts
      IssueCredentialForm.tsx
      VerifyCredential.tsx
    did/
      CreateDIDForm.tsx
      CreateDIDModal.tsx
      DIDStatus.tsx
      index.ts
      InstitutionRegistration.tsx
    error/
      ErrorBoundary.tsx
    layout/
      Footer.tsx
      Header.tsx
      index.ts
      MainLayout.tsx
      NotificationBell.tsx
      Sidebar.tsx
    requests/
      CreateRequestForm.tsx
      RequestsList.tsx
      ReviewRequestModal.tsx
    ui/
      Badge.tsx
      Button.tsx
      Card.tsx
      index.ts
      Input.tsx
      Modal.tsx
      Spinner.tsx
  hooks/
    blockchain/
      useBalance.ts
      useBlockchain.ts
      usePolkadotApi.ts
  lib/
    blockchain/
      integration.ts
      queries.ts
      realQueries.ts
      transactions.ts
    utils/
      bn-shim.ts
      cn.ts
      constants.ts
      env.ts
  pages/
    AdminVerification.tsx
    CreateDIDPage.tsx
    Credentials.tsx
    Dashboard.tsx
    Home.tsx
    Institution.tsx
    InstitutionRequests.tsx
    Institutions.tsx
    IssueCredential.tsx
    IssuedCredentials.tsx
    MyRequests.tsx
    Settings.tsx
    Verify.tsx
  providers/
    PolkadotProvider.tsx
    WalletProvider.tsx
  store/
    credentialRequests.store.ts
    credentials.store.ts
    did.store.ts
    notifications.store.ts
    ui.store.ts
    wallet.store.ts
  types/
    credentialRequest.types.ts
  App.css
  App.tsx
  index.css
  main.tsx
  vite-env.d.ts
.env.example
.gitignore
check-files.sh
eslint.config.js
index.html
package.json
README.md
tsconfig.app.json
tsconfig.json
tsconfig.node.json
tsconfig.tsbuildinfo
vite.config.ts
</directory_structure>

<files>
This section contains the contents of the repository's files.

<file path="public/vite.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="31.88" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 257"><defs><linearGradient id="IconifyId1813088fe1fbc01fb466" x1="-.828%" x2="57.636%" y1="7.652%" y2="78.411%"><stop offset="0%" stop-color="#41D1FF"></stop><stop offset="100%" stop-color="#BD34FE"></stop></linearGradient><linearGradient id="IconifyId1813088fe1fbc01fb467" x1="43.376%" x2="50.316%" y1="2.242%" y2="89.03%"><stop offset="0%" stop-color="#FFEA83"></stop><stop offset="8.333%" stop-color="#FFDD35"></stop><stop offset="100%" stop-color="#FFA800"></stop></linearGradient></defs><path fill="url(#IconifyId1813088fe1fbc01fb466)" d="M255.153 37.938L134.897 252.976c-2.483 4.44-8.862 4.466-11.382.048L.875 37.958c-2.746-4.814 1.371-10.646 6.827-9.67l120.385 21.517a6.537 6.537 0 0 0 2.322-.004l117.867-21.483c5.438-.991 9.574 4.796 6.877 9.62Z"></path><path fill="url(#IconifyId1813088fe1fbc01fb467)" d="M185.432.063L96.44 17.501a3.268 3.268 0 0 0-2.634 3.014l-5.474 92.456a3.268 3.268 0 0 0 3.997 3.378l24.777-5.718c2.318-.535 4.413 1.507 3.936 3.838l-7.361 36.047c-.495 2.426 1.782 4.5 4.151 3.78l15.304-4.649c2.372-.72 4.652 1.36 4.15 3.788l-11.698 56.621c-.732 3.542 3.979 5.473 5.943 2.437l1.313-2.028l72.516-144.72c1.215-2.423-.88-5.186-3.54-4.672l-25.505 4.922c-2.396.462-4.435-1.77-3.759-4.114l16.646-57.705c.677-2.35-1.37-4.583-3.769-4.113Z"></path></svg>
</file>

<file path="src/assets/react.svg">
<svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" aria-hidden="true" role="img" class="iconify iconify--logos" width="35.93" height="32" preserveAspectRatio="xMidYMid meet" viewBox="0 0 256 228"><path fill="#00D8FF" d="M210.483 73.824a171.49 171.49 0 0 0-8.24-2.597c.465-1.9.893-3.777 1.273-5.621c6.238-30.281 2.16-54.676-11.769-62.708c-13.355-7.7-35.196.329-57.254 19.526a171.23 171.23 0 0 0-6.375 5.848a155.866 155.866 0 0 0-4.241-3.917C100.759 3.829 77.587-4.822 63.673 3.233C50.33 10.957 46.379 33.89 51.995 62.588a170.974 170.974 0 0 0 1.892 8.48c-3.28.932-6.445 1.924-9.474 2.98C17.309 83.498 0 98.307 0 113.668c0 15.865 18.582 31.778 46.812 41.427a145.52 145.52 0 0 0 6.921 2.165a167.467 167.467 0 0 0-2.01 9.138c-5.354 28.2-1.173 50.591 12.134 58.266c13.744 7.926 36.812-.22 59.273-19.855a145.567 145.567 0 0 0 5.342-4.923a168.064 168.064 0 0 0 6.92 6.314c21.758 18.722 43.246 26.282 56.54 18.586c13.731-7.949 18.194-32.003 12.4-61.268a145.016 145.016 0 0 0-1.535-6.842c1.62-.48 3.21-.974 4.76-1.488c29.348-9.723 48.443-25.443 48.443-41.52c0-15.417-17.868-30.326-45.517-39.844Zm-6.365 70.984c-1.4.463-2.836.91-4.3 1.345c-3.24-10.257-7.612-21.163-12.963-32.432c5.106-11 9.31-21.767 12.459-31.957c2.619.758 5.16 1.557 7.61 2.4c23.69 8.156 38.14 20.213 38.14 29.504c0 9.896-15.606 22.743-40.946 31.14Zm-10.514 20.834c2.562 12.94 2.927 24.64 1.23 33.787c-1.524 8.219-4.59 13.698-8.382 15.893c-8.067 4.67-25.32-1.4-43.927-17.412a156.726 156.726 0 0 1-6.437-5.87c7.214-7.889 14.423-17.06 21.459-27.246c12.376-1.098 24.068-2.894 34.671-5.345a134.17 134.17 0 0 1 1.386 6.193ZM87.276 214.515c-7.882 2.783-14.16 2.863-17.955.675c-8.075-4.657-11.432-22.636-6.853-46.752a156.923 156.923 0 0 1 1.869-8.499c10.486 2.32 22.093 3.988 34.498 4.994c7.084 9.967 14.501 19.128 21.976 27.15a134.668 134.668 0 0 1-4.877 4.492c-9.933 8.682-19.886 14.842-28.658 17.94ZM50.35 144.747c-12.483-4.267-22.792-9.812-29.858-15.863c-6.35-5.437-9.555-10.836-9.555-15.216c0-9.322 13.897-21.212 37.076-29.293c2.813-.98 5.757-1.905 8.812-2.773c3.204 10.42 7.406 21.315 12.477 32.332c-5.137 11.18-9.399 22.249-12.634 32.792a134.718 134.718 0 0 1-6.318-1.979Zm12.378-84.26c-4.811-24.587-1.616-43.134 6.425-47.789c8.564-4.958 27.502 2.111 47.463 19.835a144.318 144.318 0 0 1 3.841 3.545c-7.438 7.987-14.787 17.08-21.808 26.988c-12.04 1.116-23.565 2.908-34.161 5.309a160.342 160.342 0 0 1-1.76-7.887Zm110.427 27.268a347.8 347.8 0 0 0-7.785-12.803c8.168 1.033 15.994 2.404 23.343 4.08c-2.206 7.072-4.956 14.465-8.193 22.045a381.151 381.151 0 0 0-7.365-13.322Zm-45.032-43.861c5.044 5.465 10.096 11.566 15.065 18.186a322.04 322.04 0 0 0-30.257-.006c4.974-6.559 10.069-12.652 15.192-18.18ZM82.802 87.83a323.167 323.167 0 0 0-7.227 13.238c-3.184-7.553-5.909-14.98-8.134-22.152c7.304-1.634 15.093-2.97 23.209-3.984a321.524 321.524 0 0 0-7.848 12.897Zm8.081 65.352c-8.385-.936-16.291-2.203-23.593-3.793c2.26-7.3 5.045-14.885 8.298-22.6a321.187 321.187 0 0 0 7.257 13.246c2.594 4.48 5.28 8.868 8.038 13.147Zm37.542 31.03c-5.184-5.592-10.354-11.779-15.403-18.433c4.902.192 9.899.29 14.978.29c5.218 0 10.376-.117 15.453-.343c-4.985 6.774-10.018 12.97-15.028 18.486Zm52.198-57.817c3.422 7.8 6.306 15.345 8.596 22.52c-7.422 1.694-15.436 3.058-23.88 4.071a382.417 382.417 0 0 0 7.859-13.026a347.403 347.403 0 0 0 7.425-13.565Zm-16.898 8.101a358.557 358.557 0 0 1-12.281 19.815a329.4 329.4 0 0 1-23.444.823c-7.967 0-15.716-.248-23.178-.732a310.202 310.202 0 0 1-12.513-19.846h.001a307.41 307.41 0 0 1-10.923-20.627a310.278 310.278 0 0 1 10.89-20.637l-.001.001a307.318 307.318 0 0 1 12.413-19.761c7.613-.576 15.42-.876 23.31-.876H128c7.926 0 15.743.303 23.354.883a329.357 329.357 0 0 1 12.335 19.695a358.489 358.489 0 0 1 11.036 20.54a329.472 329.472 0 0 1-11 20.722Zm22.56-122.124c8.572 4.944 11.906 24.881 6.52 51.026c-.344 1.668-.73 3.367-1.15 5.09c-10.622-2.452-22.155-4.275-34.23-5.408c-7.034-10.017-14.323-19.124-21.64-27.008a160.789 160.789 0 0 1 5.888-5.4c18.9-16.447 36.564-22.941 44.612-18.3ZM128 90.808c12.625 0 22.86 10.235 22.86 22.86s-10.235 22.86-22.86 22.86s-22.86-10.235-22.86-22.86s10.235-22.86 22.86-22.86Z"></path></svg>
</file>

<file path="src/components/blockchain/ChainStatus.tsx">
// src/components/blockchain/ChainStatus.tsx
import { Circle, Loader2 } from 'lucide-react';
import { usePolkadotApi } from '@/hooks/blockchain/usePolkadotApi';

export default function ChainStatus() {
  const { isConnected, isReady, blockNumber, chainName, error } = usePolkadotApi();

  // Show loading state
  if (!isReady && !error) {
    return (
      <div className="flex items-center space-x-2 text-sm">
        <Loader2 className="h-3 w-3 animate-spin text-yellow-500" />
        <span className="text-muted-foreground hidden lg:inline">
          Connecting...
        </span>
      </div>
    );
  }

  // Show error state
  if (error) {
    return (
      <div className="flex items-center space-x-2 text-sm">
        <Circle className="h-2 w-2 fill-red-500 text-red-500" />
        <span className="text-muted-foreground hidden lg:inline">
          Offline
        </span>
      </div>
    );
  }

  // Show connected state
  return (
    <div className="flex items-center space-x-2 text-sm">
      <Circle className="h-2 w-2 fill-green-500 text-green-500 animate-pulse" />
      <span className="text-muted-foreground hidden lg:inline">
        {chainName}
      </span>
      {blockNumber > 0 && (
        <span className="text-xs text-muted-foreground hidden xl:inline">
          #{blockNumber.toLocaleString()}
        </span>
      )}
    </div>
  );
}
</file>

<file path="src/components/blockchain/index.ts">
export { default as WalletConnect } from './WalletConnect';
export { default as ChainStatus } from './ChainStatus';
</file>

<file path="src/components/blockchain/WalletConnect.tsx">
import { useState } from 'react';
import { Wallet, ChevronDown, Copy, LogOut, ExternalLink } from 'lucide-react';
import { Button } from '../ui/Button';
import { useWalletStore } from '@/store/wallet.store';
import { useWalletContext } from '@/providers/WalletProvider';
import { toast } from 'sonner';

export default function WalletConnect() {
  const { isConnected, account, disconnectWallet } = useWalletStore();
  const { enableWallet } = useWalletContext();
  const [showDropdown, setShowDropdown] = useState(false);

  const handleConnect = async () => {
    try {
      await enableWallet();
    } catch (error) {
      console.error('Failed to connect wallet:', error);
    }
  };

  const copyAddress = () => {
    if (account?.address) {
      navigator.clipboard.writeText(account.address);
      toast.success('Address copied to clipboard');
      setShowDropdown(false);
    }
  };

  const viewOnExplorer = () => {
    if (account?.address) {
      // Update this URL based on your network
      window.open(`https://polkadot.js.org/apps/#/accounts/${account.address}`, '_blank');
      setShowDropdown(false);
    }
  };

  if (!isConnected) {
    return (
      <Button onClick={handleConnect} size="sm">
        <Wallet className="h-4 w-4 mr-2" />
        Connect Wallet
      </Button>
    );
  }

  return (
    <div className="relative">
      <Button
        variant="outline"
        size="sm"
        onClick={() => setShowDropdown(!showDropdown)}
        className="flex items-center"
      >
        <div className="h-6 w-6 rounded-full bg-gradient-to-br from-primary to-purple-600 mr-2 flex items-center justify-center text-xs text-white font-bold">
          {account?.name?.charAt(0)?.toUpperCase() || '?'}
        </div>
        <span className="hidden sm:inline">
          {account?.name || `${account?.address.slice(0, 6)}...${account?.address.slice(-4)}`}
        </span>
        <ChevronDown className="h-4 w-4 ml-2" />
      </Button>

      {showDropdown && (
        <>
          {/* Backdrop */}
          <div 
            className="fixed inset-0 z-40" 
            onClick={() => setShowDropdown(false)}
          />
          
          {/* Dropdown */}
          <div className="absolute right-0 mt-2 w-64 rounded-md shadow-lg bg-card border border-border z-50">
            <div className="py-1">
              {/* Account Info */}
              <div className="px-4 py-3 border-b border-border">
                <div className="flex items-center space-x-2 mb-2">
                  <div className="h-8 w-8 rounded-full bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center text-sm text-white font-bold">
                    {account?.name?.charAt(0)?.toUpperCase() || '?'}
                  </div>
                  <div className="flex-1 min-w-0">
                    <p className="text-sm font-medium truncate">{account?.name || 'Account'}</p>
                    {account?.source && (
                      <p className="text-xs text-muted-foreground capitalize">{account.source}</p>
                    )}
                  </div>
                </div>
                <p className="text-xs text-muted-foreground font-mono break-all">
                  {account?.address}
                </p>
              </div>

              {/* Actions */}
              <button
                onClick={copyAddress}
                className="flex items-center w-full text-left px-4 py-2 text-sm hover:bg-accent transition-colors"
              >
                <Copy className="h-4 w-4 mr-2" />
                Copy Address
              </button>

              <button
                onClick={viewOnExplorer}
                className="flex items-center w-full text-left px-4 py-2 text-sm hover:bg-accent transition-colors"
              >
                <ExternalLink className="h-4 w-4 mr-2" />
                View on Explorer
              </button>

              <div className="border-t border-border my-1" />

              <button
                onClick={() => {
                  disconnectWallet();
                  setShowDropdown(false);
                  toast.success('Wallet disconnected');
                }}
                className="flex items-center w-full text-left px-4 py-2 text-sm text-destructive hover:bg-accent transition-colors"
              >
                <LogOut className="h-4 w-4 mr-2" />
                Disconnect
              </button>
            </div>
          </div>
        </>
      )}
    </div>
  );
}
</file>

<file path="src/components/credentials/CredentialCard.tsx">
// src/components/credentials/CredentialCard.tsx
import { useState } from 'react';
import { 
  Award, 
  Building2, 
  Calendar, 
  FileText, 
  ExternalLink,
  Download,
  Share2,
  Eye,
  AlertCircle,
  CheckCircle2,
  XCircle
} from 'lucide-react';
import { Card, CardHeader, CardContent } from '../ui/Card';
import { Button } from '../ui/Button';
import { Badge } from '../ui/Badge';
import { cn } from '@/lib/utils/cn';

export interface Credential {
  id: string;
  holder: string;
  issuer: string;
  issuerName?: string;
  credentialHash: string;
  credentialType: string;
  degreeName?: string;
  fieldOfStudy?: string;
  issuedAt: number;
  expiresAt?: number;
  revoked: boolean;
  metadata?: string;
}

interface CredentialCardProps {
  credential: Credential;
  onViewDetails?: () => void;
  onVerify?: () => void;
  onShare?: () => void;
  onDownload?: () => void;
}

export default function CredentialCard({ 
  credential, 
  onViewDetails,
  onVerify,
  onShare,
  onDownload 
}: CredentialCardProps) {
  const [isHovered, setIsHovered] = useState(false);

  // Determine credential status
  const getStatus = () => {
    if (credential.revoked) {
      return {
        label: 'Revoked',
        variant: 'error' as const,
        icon: XCircle,
        color: 'text-red-600'
      };
    }
    
    if (credential.expiresAt && credential.expiresAt < Date.now()) {
      return {
        label: 'Expired',
        variant: 'warning' as const,
        icon: AlertCircle,
        color: 'text-yellow-600'
      };
    }
    
    return {
      label: 'Active',
      variant: 'success' as const,
      icon: CheckCircle2,
      color: 'text-green-600'
    };
  };

  const status = getStatus();
  const StatusIcon = status.icon;

  // Format dates
  const formatDate = (timestamp: number) => {
    return new Date(timestamp).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };

  // Get credential type color
  const getTypeColor = (type: string) => {
    const colors: Record<string, string> = {
      "Bachelor's Degree": 'bg-blue-100 text-blue-800 dark:bg-blue-900/20 dark:text-blue-400',
      "Master's Degree": 'bg-purple-100 text-purple-800 dark:bg-purple-900/20 dark:text-purple-400',
      "Doctorate (PhD)": 'bg-indigo-100 text-indigo-800 dark:bg-indigo-900/20 dark:text-indigo-400',
      "Certificate": 'bg-green-100 text-green-800 dark:bg-green-900/20 dark:text-green-400',
      "Transcript": 'bg-orange-100 text-orange-800 dark:bg-orange-900/20 dark:text-orange-400',
      "Professional Certification": 'bg-pink-100 text-pink-800 dark:bg-pink-900/20 dark:text-pink-400',
    };
    return colors[type] || 'bg-gray-100 text-gray-800 dark:bg-gray-900/20 dark:text-gray-400';
  };

  return (
    <Card 
      className={cn(
        "transition-all duration-200 cursor-pointer hover:shadow-lg",
        credential.revoked && "opacity-60 border-red-200 dark:border-red-900",
        isHovered && "scale-[1.02]"
      )}
      onMouseEnter={() => setIsHovered(true)}
      onMouseLeave={() => setIsHovered(false)}
    >
      {/* Header */}
      <CardHeader className="pb-3">
        <div className="flex items-start justify-between">
          <div className="flex items-center space-x-3 flex-1 min-w-0">
            <div className="h-12 w-12 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
              <Award className="h-6 w-6 text-primary" />
            </div>
            <div className="flex-1 min-w-0">
              <div className="flex items-center space-x-2 mb-1">
                <Badge className={getTypeColor(credential.credentialType)}>
                  {credential.credentialType}
                </Badge>
                <Badge variant={status.variant}>
                  <StatusIcon className="h-3 w-3 mr-1" />
                  {status.label}
                </Badge>
              </div>
              <h3 className="font-semibold text-lg truncate">
                {credential.degreeName || 'Academic Credential'}
              </h3>
              {credential.fieldOfStudy && (
                <p className="text-sm text-muted-foreground truncate">
                  {credential.fieldOfStudy}
                </p>
              )}
            </div>
          </div>
        </div>
      </CardHeader>

      {/* Content */}
      <CardContent className="space-y-4">
        {/* Issuer Info */}
        <div className="flex items-center space-x-2 text-sm">
          <Building2 className="h-4 w-4 text-muted-foreground flex-shrink-0" />
          <span className="text-muted-foreground">Issued by:</span>
          <span className="font-medium truncate">
            {credential.issuerName || `${credential.issuer.slice(0, 8)}...${credential.issuer.slice(-6)}`}
          </span>
        </div>

        {/* Date Info */}
        <div className="grid grid-cols-2 gap-3 text-sm">
          <div className="flex items-center space-x-2">
            <Calendar className="h-4 w-4 text-muted-foreground flex-shrink-0" />
            <div>
              <p className="text-xs text-muted-foreground">Issued</p>
              <p className="font-medium">{formatDate(credential.issuedAt)}</p>
            </div>
          </div>
          {credential.expiresAt && (
            <div className="flex items-center space-x-2">
              <Calendar className="h-4 w-4 text-muted-foreground flex-shrink-0" />
              <div>
                <p className="text-xs text-muted-foreground">Expires</p>
                <p className="font-medium">{formatDate(credential.expiresAt)}</p>
              </div>
            </div>
          )}
        </div>

        {/* Credential Hash Preview */}
        <div className="flex items-center space-x-2 text-xs">
          <FileText className="h-3 w-3 text-muted-foreground flex-shrink-0" />
          <span className="text-muted-foreground">Hash:</span>
          <code className="font-mono text-xs bg-muted px-2 py-0.5 rounded truncate">
            {credential.credentialHash.slice(0, 12)}...{credential.credentialHash.slice(-8)}
          </code>
        </div>

        {/* Revoked Message */}
        {credential.revoked && (
          <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3">
            <div className="flex items-start space-x-2">
              <AlertCircle className="h-4 w-4 text-red-600 dark:text-red-500 flex-shrink-0 mt-0.5" />
              <div className="text-xs">
                <p className="font-semibold text-red-800 dark:text-red-400">Credential Revoked</p>
                <p className="text-red-700 dark:text-red-300 mt-1">
                  This credential has been revoked and is no longer valid.
                </p>
              </div>
            </div>
          </div>
        )}

        {/* Actions */}
        <div className="grid grid-cols-2 sm:grid-cols-4 gap-2 pt-3 border-t border-border">
          <Button
            variant="outline"
            size="sm"
            onClick={onViewDetails}
            className="text-xs"
          >
            <Eye className="h-3 w-3 mr-1" />
            View
          </Button>
          <Button
            variant="outline"
            size="sm"
            onClick={onVerify}
            className="text-xs"
          >
            <CheckCircle2 className="h-3 w-3 mr-1" />
            Verify
          </Button>
          <Button
            variant="outline"
            size="sm"
            onClick={onShare}
            className="text-xs"
          >
            <Share2 className="h-3 w-3 mr-1" />
            Share
          </Button>
          <Button
            variant="outline"
            size="sm"
            onClick={onDownload}
            className="text-xs"
          >
            <Download className="h-3 w-3 mr-1" />
            Export
          </Button>
        </div>
      </CardContent>
    </Card>
  );
}
</file>

<file path="src/components/credentials/CredentialDetailModal.tsx">
// src/components/credentials/CredentialDetailModal.tsx
import { 
    X, 
    Award, 
    Building2, 
    User, 
    Calendar, 
    FileText, 
    Hash, 
    ExternalLink,
    Copy,
    Download,
    Share2,
    CheckCircle2,
    AlertCircle,
    QrCode
  } from 'lucide-react';
  import { Modal } from '../ui/Modal';
  import { Button } from '../ui/Button';
  import { Badge } from '../ui/Badge';
  import { toast } from 'sonner';
  import type { Credential } from './CredentialCard';
  
  interface CredentialDetailModalProps {
    isOpen: boolean;
    onClose: () => void;
    credential: Credential | null;
  }
  
  export default function CredentialDetailModal({ 
    isOpen, 
    onClose, 
    credential 
  }: CredentialDetailModalProps) {
    if (!credential) return null;
  
    const formatDate = (timestamp: number) => {
      return new Date(timestamp).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      });
    };
  
    const copyToClipboard = (text: string, label: string) => {
      navigator.clipboard.writeText(text);
      toast.success(`${label} copied to clipboard`);
    };
  
    const handleShare = () => {
      const shareUrl = `${window.location.origin}/verify?hash=${credential.credentialHash}`;
      copyToClipboard(shareUrl, 'Share link');
    };
  
    const handleDownload = () => {
      const data = {
        id: credential.id,
        type: credential.credentialType,
        degreeName: credential.degreeName,
        fieldOfStudy: credential.fieldOfStudy,
        holder: credential.holder,
        issuer: credential.issuer,
        issuerName: credential.issuerName,
        credentialHash: credential.credentialHash,
        issuedAt: credential.issuedAt,
        expiresAt: credential.expiresAt,
        revoked: credential.revoked,
        metadata: credential.metadata,
        verificationUrl: `${window.location.origin}/verify?hash=${credential.credentialHash}`,
      };
  
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `credential-${credential.id}.json`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
      
      toast.success('Credential exported');
    };
  
    const getStatus = () => {
      if (credential.revoked) {
        return { label: 'Revoked', variant: 'error' as const, icon: AlertCircle };
      }
      if (credential.expiresAt && credential.expiresAt < Date.now()) {
        return { label: 'Expired', variant: 'warning' as const, icon: AlertCircle };
      }
      return { label: 'Active', variant: 'success' as const, icon: CheckCircle2 };
    };
  
    const status = getStatus();
    const StatusIcon = status.icon;
  
    return (
      <Modal isOpen={isOpen} onClose={onClose} className="max-w-3xl">
        <div className="relative">
          {/* Header */}
          <div className="flex items-start justify-between p-6 border-b border-border">
            <div className="flex items-center space-x-4 flex-1">
              <div className="h-16 w-16 rounded-xl bg-gradient-to-br from-primary to-purple-600 flex items-center justify-center">
                <Award className="h-8 w-8 text-white" />
              </div>
              <div className="flex-1">
                <div className="flex items-center space-x-2 mb-2">
                  <h2 className="text-2xl font-bold">
                    {credential.degreeName || 'Academic Credential'}
                  </h2>
                </div>
                <div className="flex items-center space-x-2">
                  <Badge variant={status.variant}>
                    <StatusIcon className="h-3 w-3 mr-1" />
                    {status.label}
                  </Badge>
                  <Badge variant="outline">{credential.credentialType}</Badge>
                </div>
              </div>
            </div>
            <Button
              variant="ghost"
              size="icon"
              onClick={onClose}
              className="rounded-full"
            >
              <X className="h-5 w-5" />
            </Button>
          </div>
  
          {/* Content */}
          <div className="p-6 space-y-6 max-h-[70vh] overflow-y-auto">
            {/* Credential Details */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
              {/* Left Column */}
              <div className="space-y-4">
                {/* Field of Study */}
                {credential.fieldOfStudy && (
                  <div>
                    <label className="text-sm font-semibold text-muted-foreground">
                      Field of Study
                    </label>
                    <p className="text-base font-medium mt-1">{credential.fieldOfStudy}</p>
                  </div>
                )}
  
                {/* Holder */}
                <div>
                  <label className="text-sm font-semibold text-muted-foreground flex items-center">
                    <User className="h-3 w-3 mr-1" />
                    Credential Holder
                  </label>
                  <div className="flex items-center space-x-2 mt-1">
                    <code className="text-xs font-mono bg-muted px-2 py-1 rounded flex-1 truncate">
                      {credential.holder}
                    </code>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-7 w-7"
                      onClick={() => copyToClipboard(credential.holder, 'Holder address')}
                    >
                      <Copy className="h-3 w-3" />
                    </Button>
                  </div>
                </div>
  
                {/* Issuer */}
                <div>
                  <label className="text-sm font-semibold text-muted-foreground flex items-center">
                    <Building2 className="h-3 w-3 mr-1" />
                    Issued By
                  </label>
                  <p className="text-base font-medium mt-1">
                    {credential.issuerName || 'Unknown Institution'}
                  </p>
                  <div className="flex items-center space-x-2 mt-1">
                    <code className="text-xs font-mono bg-muted px-2 py-1 rounded flex-1 truncate">
                      {credential.issuer}
                    </code>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-7 w-7"
                      onClick={() => copyToClipboard(credential.issuer, 'Issuer address')}
                    >
                      <Copy className="h-3 w-3" />
                    </Button>
                  </div>
                </div>
              </div>
  
              {/* Right Column */}
              <div className="space-y-4">
                {/* Issue Date */}
                <div>
                  <label className="text-sm font-semibold text-muted-foreground flex items-center">
                    <Calendar className="h-3 w-3 mr-1" />
                    Issue Date
                  </label>
                  <p className="text-base font-medium mt-1">{formatDate(credential.issuedAt)}</p>
                </div>
  
                {/* Expiration Date */}
                {credential.expiresAt && (
                  <div>
                    <label className="text-sm font-semibold text-muted-foreground flex items-center">
                      <Calendar className="h-3 w-3 mr-1" />
                      Expiration Date
                    </label>
                    <p className="text-base font-medium mt-1">{formatDate(credential.expiresAt)}</p>
                  </div>
                )}
  
                {/* Credential ID */}
                <div>
                  <label className="text-sm font-semibold text-muted-foreground flex items-center">
                    <FileText className="h-3 w-3 mr-1" />
                    Credential ID
                  </label>
                  <div className="flex items-center space-x-2 mt-1">
                    <code className="text-xs font-mono bg-muted px-2 py-1 rounded flex-1 truncate">
                      {credential.id}
                    </code>
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-7 w-7"
                      onClick={() => copyToClipboard(credential.id, 'Credential ID')}
                    >
                      <Copy className="h-3 w-3" />
                    </Button>
                  </div>
                </div>
              </div>
            </div>
  
            {/* Credential Hash */}
            <div className="bg-accent rounded-lg p-4">
              <label className="text-sm font-semibold text-muted-foreground flex items-center mb-2">
                <Hash className="h-4 w-4 mr-1" />
                Credential Hash (Blake2)
              </label>
              <div className="flex items-center space-x-2">
                <code className="text-xs font-mono bg-background px-3 py-2 rounded flex-1 break-all">
                  {credential.credentialHash}
                </code>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => copyToClipboard(credential.credentialHash, 'Credential hash')}
                >
                  <Copy className="h-3 w-3 mr-1" />
                  Copy
                </Button>
              </div>
              <p className="text-xs text-muted-foreground mt-2">
                This cryptographic hash uniquely identifies your credential on the blockchain
              </p>
            </div>
  
            {/* Metadata */}
            {credential.metadata && (
              <div>
                <label className="text-sm font-semibold text-muted-foreground mb-2 block">
                  Additional Information
                </label>
                <div className="bg-muted rounded-lg p-4">
                  <p className="text-sm whitespace-pre-wrap">{credential.metadata}</p>
                </div>
              </div>
            )}
  
            {/* Revoked Warning */}
            {credential.revoked && (
              <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                <div className="flex items-start space-x-3">
                  <AlertCircle className="h-5 w-5 text-red-600 dark:text-red-500 flex-shrink-0 mt-0.5" />
                  <div>
                    <p className="font-semibold text-red-800 dark:text-red-400">
                      Credential Revoked
                    </p>
                    <p className="text-sm text-red-700 dark:text-red-300 mt-1">
                      This credential has been revoked by the issuing institution and is no longer valid.
                      It should not be used for verification purposes.
                    </p>
                  </div>
                </div>
              </div>
            )}
  
            {/* Verification Info */}
            <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
              <div className="flex items-start space-x-3">
                <CheckCircle2 className="h-5 w-5 text-blue-600 dark:text-blue-500 flex-shrink-0 mt-0.5" />
                <div className="flex-1">
                  <p className="font-semibold text-blue-800 dark:text-blue-400">
                    Blockchain Verified
                  </p>
                  <p className="text-sm text-blue-700 dark:text-blue-300 mt-1">
                    This credential is permanently recorded on the blockchain and can be verified by anyone.
                  </p>
                </div>
              </div>
            </div>
          </div>
  
          {/* Footer Actions */}
          <div className="flex flex-wrap gap-3 p-6 border-t border-border bg-accent/50">
            <Button onClick={handleShare} className="flex-1">
              <Share2 className="h-4 w-4 mr-2" />
              Share Credential
            </Button>
            <Button onClick={handleDownload} variant="outline" className="flex-1">
              <Download className="h-4 w-4 mr-2" />
              Export JSON
            </Button>
            <Button 
              variant="outline"
              onClick={() => window.open(`/verify?hash=${credential.credentialHash}`, '_blank')}
            >
              <ExternalLink className="h-4 w-4 mr-2" />
              Public Verification
            </Button>
          </div>
        </div>
      </Modal>
    );
  }
</file>

<file path="src/components/credentials/CredentialsList.tsx">
// src/components/credentials/CredentialsList.tsx
import { useState, useMemo } from 'react';
import { 
  Grid3x3, 
  List, 
  Search, 
  Filter,
  SortAsc,
  Award,
  Loader2
} from 'lucide-react';
import { Button } from '../ui/Button';
import { Input } from '../ui/Input';
import { Badge } from '../ui/Badge';
import CredentialCard, { Credential } from './CredentialCard';
import CredentialDetailModal from './CredentialDetailModal';
import { CREDENTIAL_TYPES, CREDENTIAL_STATUS } from '@/lib/utils/constants';

interface CredentialsListProps {
  credentials: Credential[];
  loading?: boolean;
  emptyMessage?: string;
}

type ViewMode = 'grid' | 'list';
type FilterStatus = 'all' | 'active' | 'revoked' | 'expired';
type SortOption = 'newest' | 'oldest' | 'name' | 'type';

export default function CredentialsList({ 
  credentials, 
  loading = false,
  emptyMessage = "No credentials yet"
}: CredentialsListProps) {
  const [viewMode, setViewMode] = useState<ViewMode>('grid');
  const [searchQuery, setSearchQuery] = useState('');
  const [filterStatus, setFilterStatus] = useState<FilterStatus>('all');
  const [filterType, setFilterType] = useState<string>('all');
  const [sortBy, setSortBy] = useState<SortOption>('newest');
  const [selectedCredential, setSelectedCredential] = useState<Credential | null>(null);
  const [showDetailModal, setShowDetailModal] = useState(false);

  // Filter and sort credentials
  const filteredCredentials = useMemo(() => {
    let result = [...credentials];

    // Search filter
    if (searchQuery) {
      result = result.filter(cred => 
        cred.degreeName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        cred.fieldOfStudy?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        cred.issuerName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
        cred.credentialType.toLowerCase().includes(searchQuery.toLowerCase())
      );
    }

    // Status filter
    if (filterStatus !== 'all') {
      result = result.filter(cred => {
        if (filterStatus === 'active') {
          return !cred.revoked && (!cred.expiresAt || cred.expiresAt > Date.now());
        }
        if (filterStatus === 'revoked') {
          return cred.revoked;
        }
        if (filterStatus === 'expired') {
          return !cred.revoked && cred.expiresAt && cred.expiresAt < Date.now();
        }
        return true;
      });
    }

    // Type filter
    if (filterType !== 'all') {
      result = result.filter(cred => cred.credentialType === filterType);
    }

    // Sort
    result.sort((a, b) => {
      switch (sortBy) {
        case 'newest':
          return b.issuedAt - a.issuedAt;
        case 'oldest':
          return a.issuedAt - b.issuedAt;
        case 'name':
          return (a.degreeName || '').localeCompare(b.degreeName || '');
        case 'type':
          return a.credentialType.localeCompare(b.credentialType);
        default:
          return 0;
      }
    });

    return result;
  }, [credentials, searchQuery, filterStatus, filterType, sortBy]);

  // Get credential counts by status
  const counts = useMemo(() => {
    return {
      total: credentials.length,
      active: credentials.filter(c => !c.revoked && (!c.expiresAt || c.expiresAt > Date.now())).length,
      revoked: credentials.filter(c => c.revoked).length,
      expired: credentials.filter(c => !c.revoked && c.expiresAt && c.expiresAt < Date.now()).length,
    };
  }, [credentials]);

  // Handle credential actions
  const handleViewDetails = (credential: Credential) => {
    setSelectedCredential(credential);
    setShowDetailModal(true);
  };

  const handleVerify = (credential: Credential) => {
    window.open(`/verify?hash=${credential.credentialHash}`, '_blank');
  };

  const handleShare = (credential: Credential) => {
    const shareUrl = `${window.location.origin}/verify?hash=${credential.credentialHash}`;
    navigator.clipboard.writeText(shareUrl);
    // Would show toast in real implementation
    alert('Share link copied to clipboard!');
  };

  const handleDownload = (credential: Credential) => {
    const data = {
      id: credential.id,
      type: credential.credentialType,
      degreeName: credential.degreeName,
      fieldOfStudy: credential.fieldOfStudy,
      holder: credential.holder,
      issuer: credential.issuer,
      credentialHash: credential.credentialHash,
      issuedAt: credential.issuedAt,
    };

    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `credential-${credential.id}.json`;
    a.click();
    URL.revokeObjectURL(url);
  };

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="text-center">
          <Loader2 className="h-8 w-8 animate-spin mx-auto mb-3 text-primary" />
          <p className="text-muted-foreground">Loading credentials...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Stats Bar */}
      <div className="grid grid-cols-2 sm:grid-cols-4 gap-4">
        <div className="bg-accent rounded-lg p-4">
          <p className="text-sm text-muted-foreground">Total</p>
          <p className="text-2xl font-bold">{counts.total}</p>
        </div>
        <div className="bg-green-50 dark:bg-green-900/20 rounded-lg p-4">
          <p className="text-sm text-green-700 dark:text-green-400">Active</p>
          <p className="text-2xl font-bold text-green-800 dark:text-green-300">{counts.active}</p>
        </div>
        <div className="bg-red-50 dark:bg-red-900/20 rounded-lg p-4">
          <p className="text-sm text-red-700 dark:text-red-400">Revoked</p>
          <p className="text-2xl font-bold text-red-800 dark:text-red-300">{counts.revoked}</p>
        </div>
        <div className="bg-yellow-50 dark:bg-yellow-900/20 rounded-lg p-4">
          <p className="text-sm text-yellow-700 dark:text-yellow-400">Expired</p>
          <p className="text-2xl font-bold text-yellow-800 dark:text-yellow-300">{counts.expired}</p>
        </div>
      </div>

      {/* Filters & Controls */}
      <div className="flex flex-col sm:flex-row gap-4">
        {/* Search */}
        <div className="flex-1">
          <div className="relative">
            <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
            <Input
              placeholder="Search credentials..."
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="pl-10"
            />
          </div>
        </div>

        {/* View Mode Toggle */}
        <div className="flex gap-2">
          <Button
            variant={viewMode === 'grid' ? 'default' : 'outline'}
            size="icon"
            onClick={() => setViewMode('grid')}
          >
            <Grid3x3 className="h-4 w-4" />
          </Button>
          <Button
            variant={viewMode === 'list' ? 'default' : 'outline'}
            size="icon"
            onClick={() => setViewMode('list')}
          >
            <List className="h-4 w-4" />
          </Button>
        </div>
      </div>

      {/* Filter Tabs */}
      <div className="flex flex-wrap gap-2">
        <Button
          variant={filterStatus === 'all' ? 'default' : 'outline'}
          size="sm"
          onClick={() => setFilterStatus('all')}
        >
          All ({counts.total})
        </Button>
        <Button
          variant={filterStatus === 'active' ? 'default' : 'outline'}
          size="sm"
          onClick={() => setFilterStatus('active')}
        >
          Active ({counts.active})
        </Button>
        <Button
          variant={filterStatus === 'revoked' ? 'default' : 'outline'}
          size="sm"
          onClick={() => setFilterStatus('revoked')}
        >
          Revoked ({counts.revoked})
        </Button>
        <Button
          variant={filterStatus === 'expired' ? 'default' : 'outline'}
          size="sm"
          onClick={() => setFilterStatus('expired')}
        >
          Expired ({counts.expired})
        </Button>

        <div className="ml-auto flex gap-2">
          {/* Type Filter */}
          <select
            value={filterType}
            onChange={(e) => setFilterType(e.target.value)}
            className="px-3 py-1.5 text-sm border border-input rounded-md bg-background"
          >
            <option value="all">All Types</option>
            {CREDENTIAL_TYPES.map(type => (
              <option key={type} value={type}>{type}</option>
            ))}
          </select>

          {/* Sort */}
          <select
            value={sortBy}
            onChange={(e) => setSortBy(e.target.value as SortOption)}
            className="px-3 py-1.5 text-sm border border-input rounded-md bg-background"
          >
            <option value="newest">Newest First</option>
            <option value="oldest">Oldest First</option>
            <option value="name">By Name</option>
            <option value="type">By Type</option>
          </select>
        </div>
      </div>

      {/* Results Count */}
      <div className="text-sm text-muted-foreground">
        Showing {filteredCredentials.length} of {credentials.length} credential{credentials.length !== 1 ? 's' : ''}
      </div>

      {/* Credentials Grid/List */}
      {filteredCredentials.length === 0 ? (
        <div className="text-center py-12">
          <Award className="h-12 w-12 mx-auto mb-3 text-muted-foreground opacity-50" />
          <p className="text-lg font-medium mb-1">
            {searchQuery || filterStatus !== 'all' || filterType !== 'all' 
              ? 'No credentials match your filters'
              : emptyMessage
            }
          </p>
          <p className="text-sm text-muted-foreground">
            {searchQuery || filterStatus !== 'all' || filterType !== 'all'
              ? 'Try adjusting your search or filters'
              : 'Credentials you receive will appear here'
            }
          </p>
        </div>
      ) : (
        <div className={
          viewMode === 'grid'
            ? 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6'
            : 'flex flex-col gap-4'
        }>
          {filteredCredentials.map((credential) => (
            <CredentialCard
              key={credential.id}
              credential={credential}
              onViewDetails={() => handleViewDetails(credential)}
              onVerify={() => handleVerify(credential)}
              onShare={() => handleShare(credential)}
              onDownload={() => handleDownload(credential)}
            />
          ))}
        </div>
      )}

      {/* Detail Modal */}
      <CredentialDetailModal
        isOpen={showDetailModal}
        onClose={() => setShowDetailModal(false)}
        credential={selectedCredential}
      />
    </div>
  );
}
</file>

<file path="src/components/credentials/index.ts">
export { default as IssueCredentialForm } from './IssueCredentialForm';
</file>

<file path="src/components/credentials/IssueCredentialForm.tsx">
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { 
  Award, 
  Search, 
  Upload, 
  FileText, 
  CheckCircle2, 
  Loader2,
  User,
  Calendar,
  Hash,
  ArrowLeft,
  ArrowRight,
  GraduationCap
} from 'lucide-react';
import { Button } from '../ui/Button';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '../ui/Card';
import { Input } from '../ui/Input';
import { Badge } from '../ui/Badge';
import { toast } from 'sonner';
import { CREDENTIAL_TYPES } from '@/lib/utils/constants';
import { useDIDStore } from '@/store/did.store';
import { useBlockchain } from '@/hooks/blockchain/useBlockchain';

// Form validation schema
const issueCredentialSchema = z.object({
  // Recipient
  recipientDID: z.string()
    .min(10, 'Please enter a valid DID address')
    .startsWith('5', 'DID address must start with 5'),
  
  // Credential Type
  credentialType: z.enum(CREDENTIAL_TYPES),
  customType: z.string().optional(),
  
  // Credential Details
  degreeName: z.string()
    .min(3, 'Degree name is required')
    .max(200, 'Degree name too long'),
  fieldOfStudy: z.string()
    .min(2, 'Field of study is required'),
  major: z.string().optional(),
  minor: z.string().optional(),
  
  // Dates
  graduationDate: z.string()
    .min(1, 'Graduation date is required'),
  issueDate: z.string()
    .min(1, 'Issue date is required'),
  expirationDate: z.string().optional(),
  
  // Academic Details
  gpa: z.string().optional(),
  honors: z.string().optional(),
  
  // Additional
  referenceNumber: z.string().optional(),
  notes: z.string()
    .max(512, 'Notes must be less than 512 characters')
    .optional(),
});

type IssueCredentialFormData = z.infer<typeof issueCredentialSchema>;

interface IssueCredentialFormProps {
  onSuccess?: (credentialId: string) => void;
  onCancel?: () => void;
}

export default function IssueCredentialForm({ onSuccess, onCancel }: IssueCredentialFormProps) {
  const [step, setStep] = useState<1 | 2 | 3 | 4 | 5>(1);
  const [uploadedDocument, setUploadedDocument] = useState<File | null>(null);
  const [documentHash, setDocumentHash] = useState<string>('');
  const [recipientInfo, setRecipientInfo] = useState<{
    name?: string;
    status: 'active' | 'inactive' | 'not_found';
  } | null>(null);
  const [isSearching, setIsSearching] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  
  const { institutionName, didAddress } = useDIDStore();
  const { queries, transactions, account, api, isReady } = useBlockchain();

  const { 
    register, 
    handleSubmit, 
    watch, 
    setValue,
    formState: { errors },
    trigger 
  } = useForm<IssueCredentialFormData>({
    resolver: zodResolver(issueCredentialSchema),
    defaultValues: {
      credentialType: "Bachelor's Degree",
      issueDate: new Date().toISOString().split('T')[0],
    },
  });

  const selectedCredentialType = watch('credentialType');
  const recipientDID = watch('recipientDID');

  // Search for recipient DID on blockchain
  const searchRecipient = async () => {
    if (!recipientDID || recipientDID.length < 10) {
      toast.error('Please enter a valid DID address');
      return;
    }

    if (!queries || !isReady) {
      toast.error('Blockchain not connected');
      return;
    }

    setIsSearching(true);
    
    try {
      console.log(' Searching for DID:', recipientDID);

      // Query blockchain for DID
      const didDoc = await queries.did.getDID(recipientDID);
      
      if (!didDoc) {
        setRecipientInfo({ status: 'not_found' });
        toast.error('DID not found on blockchain');
        return;
      }

      // Check if DID is active
      if (!didDoc.active) {
        setRecipientInfo({ status: 'inactive' });
        toast.warning('This DID is inactive');
        return;
      }

      console.log(' Found active DID:', didDoc);
      
      setRecipientInfo({
        name: recipientDID.slice(0, 8) + '...' + recipientDID.slice(-6), // Use truncated address as name
        status: 'active',
      });
      
      toast.success('Recipient found!', {
        description: 'DID is active and can receive credentials',
      });
    } catch (error: any) {
      console.error(' Failed to search DID:', error);
      setRecipientInfo({ status: 'not_found' });
      toast.error('Failed to verify DID', {
        description: error.message || 'Please check the address',
      });
    } finally {
      setIsSearching(false);
    }
  };

  // Handle document upload
  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    
    if (!file) return;
    
    // Validate file type
    if (file.type !== 'application/pdf') {
      toast.error('Only PDF files are allowed');
      return;
    }
    
    // Validate file size (10MB)
    if (file.size > 10 * 1024 * 1024) {
      toast.error('File size must be less than 10MB');
      return;
    }
    
    setUploadedDocument(file);
    
    // Generate hash
    try {
      const hash = await generateFileHash(file);
      setDocumentHash(hash);
      toast.success('Document uploaded successfully');
    } catch (error) {
      toast.error('Failed to generate document hash');
      setUploadedDocument(null);
    }
  };

  // Generate file hash using Blake2
  const generateFileHash = async (file: File): Promise<string> => {
    try {
      // Import Blake2 from Polkadot util-crypto
      const { blake2AsHex } = await import('@polkadot/util-crypto');
      
      // Read file as ArrayBuffer
      const arrayBuffer = await file.arrayBuffer();
      const uint8Array = new Uint8Array(arrayBuffer);
      
      // Generate Blake2-256 hash
      const hash = blake2AsHex(uint8Array, 256);
      
      console.log(' Generated Blake2 hash:', hash);
      
      return hash;
    } catch (error) {
      console.error('Failed to generate hash:', error);
      throw error;
    }
  };

  // Navigate steps
  const nextStep = async () => {
    let fieldsToValidate: (keyof IssueCredentialFormData)[] = [];
    
    if (step === 1) {
      if (!recipientInfo || recipientInfo.status !== 'active') {
        toast.error('Please search and verify the recipient first');
        return;
      }
    } else if (step === 2) {
      fieldsToValidate = ['credentialType', 'degreeName', 'fieldOfStudy'];
      if (selectedCredentialType === 'Other') {
        fieldsToValidate.push('customType');
      }
    } else if (step === 3) {
      fieldsToValidate = ['graduationDate', 'issueDate'];
    } else if (step === 4) {
      if (!uploadedDocument || !documentHash) {
        toast.error('Please upload a document');
        return;
      }
    }
    
    if (fieldsToValidate.length > 0) {
      const isValid = await trigger(fieldsToValidate);
      if (!isValid) return;
    }
    
    setStep((prev) => Math.min(prev + 1, 5) as 1 | 2 | 3 | 4 | 5);
  };

  const prevStep = () => {
    setStep((prev) => Math.max(prev - 1, 1) as 1 | 2 | 3 | 4 | 5);
  };

  // Submit credential to blockchain
  const onSubmit = async (data: IssueCredentialFormData) => {
    if (step !== 5) return;
    
    setIsSubmitting(true);
    
    try {
      if (!transactions || !account || !api) {
        throw new Error('Blockchain not connected');
      }

      console.log(' Issuing credential on blockchain...');

      // Prepare metadata as JSON
      const metadata = JSON.stringify({
        degreeName: data.degreeName,
        fieldOfStudy: data.fieldOfStudy,
        major: data.major,
        minor: data.minor,
        graduationDate: data.graduationDate,
        gpa: data.gpa,
        honors: data.honors,
        referenceNumber: data.referenceNumber,
        notes: data.notes,
      });

      // Convert expiration date to block number (if provided)
      let expiresAtBlock: number | null = null;
      if (data.expirationDate) {
        const currentBlock = await api.query.system.number();
        const expirationDate = new Date(data.expirationDate);
        const currentDate = new Date();
        const daysDiff = Math.ceil((expirationDate.getTime() - currentDate.getTime()) / (1000 * 60 * 60 * 24));
        // Assuming ~6 second blocks, roughly 14,400 blocks per day
        const blocksToAdd = daysDiff * 14400;
        expiresAtBlock = currentBlock.toNumber() + blocksToAdd;
      }

      // Show transaction progress
      const statusToast = toast.loading('Preparing transaction...');

      // Issue credential transaction
      const result = await transactions.credential.issueCredential(
        account,
        data.recipientDID,
        documentHash,
        data.credentialType,
        metadata,
        expiresAtBlock,
        (status) => {
          if (status.status === 'signing') {
            toast.loading('Waiting for signature...', { id: statusToast });
          } else if (status.status === 'submitting') {
            toast.loading('Submitting to blockchain...', { id: statusToast });
          } else if (status.status === 'inBlock') {
            toast.loading('Transaction in block...', { id: statusToast });
          } else if (status.status === 'finalized') {
            toast.dismiss(statusToast);
          } else if (status.status === 'error') {
            toast.error(status.message, { id: statusToast });
          }
        }
      );

      if (result.success) {
        console.log(' Credential issued successfully!');
        console.log('Block hash:', result.blockHash);
        console.log('Transaction hash:', result.transactionHash);

        toast.success('Credential issued successfully!', {
          description: `Transaction: ${result.transactionHash?.slice(0, 10)}...`,
          duration: 5000,
        });
        
        onSuccess?.(result.transactionHash || 'unknown');
      } else {
        throw new Error(result.error || 'Transaction failed');
      }
    } catch (error: any) {
      console.error(' Failed to issue credential:', error);
      
      let errorMessage = 'Failed to issue credential';
      if (error.message) {
        errorMessage = error.message;
      }
      
      toast.error(errorMessage, {
        description: 'Please check the console for details',
      });
    } finally {
      setIsSubmitting(false);
    }
  };

  // Step 1: Search Recipient
  const renderStep1 = () => (
    <div className="space-y-6">
      <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div className="flex items-start space-x-3">
          <User className="h-5 w-5 text-blue-600 dark:text-blue-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm">
            <p className="font-semibold text-blue-800 dark:text-blue-400">Find Recipient</p>
            <p className="text-blue-700 dark:text-blue-300 mt-1">
              Enter the recipient's DID address. They must have an active DID to receive credentials.
            </p>
          </div>
        </div>
      </div>

      <div>
        <label className="block text-sm font-semibold mb-2">
          Recipient DID Address *
        </label>
        <div className="flex space-x-2">
          <Input
            {...register('recipientDID')}
            placeholder="5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY"
            className={`flex-1 font-mono text-sm ${errors.recipientDID ? 'border-red-500' : ''}`}
          />
          <Button
            type="button"
            onClick={searchRecipient}
            disabled={isSearching || !isReady}
          >
            {isSearching ? (
              <Loader2 className="h-4 w-4 animate-spin" />
            ) : (
              <Search className="h-4 w-4" />
            )}
          </Button>
        </div>
        {errors.recipientDID && (
          <p className="text-sm text-red-600 mt-1">{errors.recipientDID.message}</p>
        )}
      </div>

      {/* Recipient Info */}
      {recipientInfo && (
        <Card className={
          recipientInfo.status === 'active' 
            ? 'border-green-500 bg-green-50 dark:bg-green-900/20' 
            : 'border-red-500 bg-red-50 dark:bg-red-900/20'
        }>
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div className="flex items-center space-x-3">
                {recipientInfo.status === 'active' ? (
                  <CheckCircle2 className="h-8 w-8 text-green-600" />
                ) : (
                  <User className="h-8 w-8 text-red-600" />
                )}
                <div>
                  {recipientInfo.status === 'active' ? (
                    <>
                      <p className="font-semibold text-green-900 dark:text-green-400">
                        {recipientInfo.name || 'Valid DID Found'}
                      </p>
                      <p className="text-sm text-green-700 dark:text-green-300">
                        Ready to receive credentials
                      </p>
                    </>
                  ) : (
                    <>
                      <p className="font-semibold text-red-900 dark:text-red-400">
                        DID Not Found
                      </p>
                      <p className="text-sm text-red-700 dark:text-red-300">
                        This DID does not exist or is inactive
                      </p>
                    </>
                  )}
                </div>
              </div>
              <Badge variant={recipientInfo.status === 'active' ? 'success' : 'error'}>
                {recipientInfo.status === 'active' ? 'Active' : 'Not Found'}
              </Badge>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );

  // Step 2: Credential Details
  const renderStep2 = () => (
    <div className="space-y-6">
      <div>
        <label className="block text-sm font-semibold mb-2">
          Credential Type *
        </label>
        <select
          {...register('credentialType')}
          className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
        >
          {CREDENTIAL_TYPES.map((type) => (
            <option key={type} value={type}>{type}</option>
          ))}
        </select>
      </div>

      {selectedCredentialType === 'Other' && (
        <div>
          <label className="block text-sm font-semibold mb-2">
            Custom Credential Type *
          </label>
          <Input
            {...register('customType')}
            placeholder="Enter credential type"
            className={errors.customType ? 'border-red-500' : ''}
          />
          {errors.customType && (
            <p className="text-sm text-red-600 mt-1">{errors.customType.message}</p>
          )}
        </div>
      )}

      <div>
        <label className="block text-sm font-semibold mb-2">
          Degree/Certificate Name *
        </label>
        <Input
          {...register('degreeName')}
          placeholder="e.g., Bachelor of Science in Computer Science"
          className={errors.degreeName ? 'border-red-500' : ''}
        />
        {errors.degreeName && (
          <p className="text-sm text-red-600 mt-1">{errors.degreeName.message}</p>
        )}
      </div>

      <div>
        <label className="block text-sm font-semibold mb-2">
          Field of Study *
        </label>
        <Input
          {...register('fieldOfStudy')}
          placeholder="e.g., Computer Science"
          className={errors.fieldOfStudy ? 'border-red-500' : ''}
        />
        {errors.fieldOfStudy && (
          <p className="text-sm text-red-600 mt-1">{errors.fieldOfStudy.message}</p>
        )}
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-semibold mb-2">
            Major (Optional)
          </label>
          <Input
            {...register('major')}
            placeholder="e.g., Software Engineering"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold mb-2">
            Minor (Optional)
          </label>
          <Input
            {...register('minor')}
            placeholder="e.g., Mathematics"
          />
        </div>
      </div>
    </div>
  );

  // Step 3: Academic Details
  const renderStep3 = () => (
    <div className="space-y-6">
      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-semibold mb-2">
            <Calendar className="inline h-4 w-4 mr-1" />
            Graduation Date *
          </label>
          <Input
            {...register('graduationDate')}
            type="date"
            className={errors.graduationDate ? 'border-red-500' : ''}
          />
          {errors.graduationDate && (
            <p className="text-sm text-red-600 mt-1">{errors.graduationDate.message}</p>
          )}
        </div>

        <div>
          <label className="block text-sm font-semibold mb-2">
            <Calendar className="inline h-4 w-4 mr-1" />
            Issue Date *
          </label>
          <Input
            {...register('issueDate')}
            type="date"
            className={errors.issueDate ? 'border-red-500' : ''}
          />
          {errors.issueDate && (
            <p className="text-sm text-red-600 mt-1">{errors.issueDate.message}</p>
          )}
        </div>
      </div>

      <div>
        <label className="block text-sm font-semibold mb-2">
          Expiration Date (Optional)
        </label>
        <Input
          {...register('expirationDate')}
          type="date"
        />
        <p className="text-xs text-muted-foreground mt-1">
          Leave empty if credential doesn't expire
        </p>
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-semibold mb-2">
            GPA (Optional)
          </label>
          <Input
            {...register('gpa')}
            placeholder="e.g., 3.85"
          />
        </div>

        <div>
          <label className="block text-sm font-semibold mb-2">
            Honors/Distinctions (Optional)
          </label>
          <Input
            {...register('honors')}
            placeholder="e.g., Summa Cum Laude"
          />
        </div>
      </div>

      <div>
        <label className="block text-sm font-semibold mb-2">
          Reference Number (Optional)
        </label>
        <Input
          {...register('referenceNumber')}
          placeholder="Internal reference or certificate number"
        />
      </div>
    </div>
  );

  // Step 4: Document Upload
  const renderStep4 = () => (
    <div className="space-y-6">
      <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div className="flex items-start space-x-3">
          <FileText className="h-5 w-5 text-blue-600 dark:text-blue-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm">
            <p className="font-semibold text-blue-800 dark:text-blue-400">Upload Credential Document</p>
            <p className="text-blue-700 dark:text-blue-300 mt-1">
              Upload the official PDF document. A cryptographic hash will be generated and stored on-chain.
            </p>
          </div>
        </div>
      </div>

      {!uploadedDocument ? (
        <div>
          <label className="block text-sm font-semibold mb-2">
            Credential Document (PDF) *
          </label>
          <div className="border-2 border-dashed border-border rounded-lg p-8 text-center hover:border-primary transition-colors">
            <input
              type="file"
              accept=".pdf"
              onChange={handleFileUpload}
              className="hidden"
              id="credential-upload"
            />
            <label htmlFor="credential-upload" className="cursor-pointer">
              <Upload className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
              <p className="text-sm font-medium mb-1">
                Click to upload or drag and drop
              </p>
              <p className="text-xs text-muted-foreground">
                PDF only, up to 10MB
              </p>
            </label>
          </div>
        </div>
      ) : (
        <Card className="border-green-500 bg-green-50 dark:bg-green-900/20">
          <CardContent className="pt-6">
            <div className="space-y-3">
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <FileText className="h-8 w-8 text-green-600" />
                  <div>
                    <p className="font-semibold">{uploadedDocument.name}</p>
                    <p className="text-sm text-muted-foreground">
                      {(uploadedDocument.size / 1024 / 1024).toFixed(2)} MB
                    </p>
                  </div>
                </div>
                <Button
                  variant="outline"
                  size="sm"
                  onClick={() => {
                    setUploadedDocument(null);
                    setDocumentHash('');
                  }}
                >
                  Remove
                </Button>
              </div>

              <div className="pt-3 border-t">
                <label className="text-xs font-semibold text-muted-foreground mb-1 block">
                  <Hash className="inline h-3 w-3 mr-1" />
                  Document Hash (Blake2)
                </label>
                <div className="flex items-center space-x-2">
                  <Input
                    value={documentHash}
                    readOnly
                    className="font-mono text-xs"
                  />
                  <Button
                    variant="outline"
                    size="sm"
                    onClick={() => {
                      navigator.clipboard.writeText(documentHash);
                      toast.success('Hash copied to clipboard');
                    }}
                  >
                    Copy
                  </Button>
                </div>
                <p className="text-xs text-muted-foreground mt-1">
                  This hash will be stored on the blockchain
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      )}

      <div>
        <label className="block text-sm font-semibold mb-2">
          Additional Notes (Optional)
        </label>
        <textarea
          {...register('notes')}
          placeholder="Any additional information about this credential..."
          className="flex min-h-[100px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
          maxLength={512}
        />
        {errors.notes && (
          <p className="text-sm text-red-600 mt-1">{errors.notes.message}</p>
        )}
      </div>
    </div>
  );

  // Step 5: Review & Submit
  const renderStep5 = () => {
    const formData = watch();
    
    return (
      <div className="space-y-6">
        <div className="bg-accent rounded-lg p-6 space-y-4">
          <h3 className="font-semibold text-lg mb-4">Review Credential</h3>
          
          {/* Recipient */}
          <div className="space-y-2">
            <p className="text-sm font-semibold text-muted-foreground">Recipient</p>
            <div className="bg-background rounded p-3">
              <p className="text-sm font-medium">{recipientInfo?.name || 'Recipient'}</p>
              <p className="text-xs font-mono text-muted-foreground mt-1">
                {formData.recipientDID}
              </p>
            </div>
          </div>

          {/* Credential Details */}
          <div className="space-y-2">
            <p className="text-sm font-semibold text-muted-foreground">Credential Details</p>
            <div className="bg-background rounded p-3 space-y-2">
              <div className="flex items-center justify-between">
                <span className="text-sm text-muted-foreground">Type:</span>
                <Badge>{formData.credentialType}</Badge>
              </div>
              <div className="flex justify-between">
                <span className="text-sm text-muted-foreground">Degree:</span>
                <span className="text-sm font-medium">{formData.degreeName}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-sm text-muted-foreground">Field:</span>
                <span className="text-sm">{formData.fieldOfStudy}</span>
              </div>
              {formData.major && (
                <div className="flex justify-between">
                  <span className="text-sm text-muted-foreground">Major:</span>
                  <span className="text-sm">{formData.major}</span>
                </div>
              )}
              {formData.gpa && (
                <div className="flex justify-between">
                  <span className="text-sm text-muted-foreground">GPA:</span>
                  <span className="text-sm">{formData.gpa}</span>
                </div>
              )}
              {formData.honors && (
                <div className="flex justify-between">
                  <span className="text-sm text-muted-foreground">Honors:</span>
                  <span className="text-sm">{formData.honors}</span>
                </div>
              )}
            </div>
          </div>

          {/* Dates */}
          <div className="space-y-2">
            <p className="text-sm font-semibold text-muted-foreground">Important Dates</p>
            <div className="bg-background rounded p-3 space-y-2 text-sm">
              <div className="flex justify-between">
                <span className="text-muted-foreground">Graduation:</span>
                <span>{new Date(formData.graduationDate).toLocaleDateString()}</span>
              </div>
              <div className="flex justify-between">
                <span className="text-muted-foreground">Issue Date:</span>
                <span>{new Date(formData.issueDate).toLocaleDateString()}</span>
              </div>
              {formData.expirationDate && (
                <div className="flex justify-between">
                  <span className="text-muted-foreground">Expires:</span>
                  <span>{new Date(formData.expirationDate).toLocaleDateString()}</span>
                </div>
              )}
            </div>
          </div>

          {/* Document */}
          <div className="space-y-2">
            <p className="text-sm font-semibold text-muted-foreground">Document</p>
            <div className="bg-background rounded p-3">
              <p className="text-sm">{uploadedDocument?.name}</p>
              <p className="text-xs font-mono text-muted-foreground mt-1 break-all">
                Hash: {documentHash}
              </p>
            </div>
          </div>

          {/* Issuer */}
          <div className="space-y-2">
            <p className="text-sm font-semibold text-muted-foreground">Issuer</p>
            <div className="bg-background rounded p-3">
              <p className="text-sm font-medium">{institutionName}</p>
              <p className="text-xs font-mono text-muted-foreground mt-1">
                {didAddress}
              </p>
            </div>
          </div>
        </div>

        <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
          <div className="flex items-start space-x-3">
            <CheckCircle2 className="h-5 w-5 text-green-600 dark:text-green-500 flex-shrink-0 mt-0.5" />
            <div className="text-sm">
              <p className="font-semibold text-green-800 dark:text-green-400">Ready to Issue</p>
              <p className="text-green-700 dark:text-green-300 mt-1">
                Once submitted, the credential will be permanently recorded on the blockchain 
                and sent to the recipient's DID.
              </p>
            </div>
          </div>
        </div>
      </div>
    );
  };

  return (
    <Card className="max-w-3xl mx-auto">
      <CardHeader>
        <CardTitle className="flex items-center space-x-2">
          <Award className="h-6 w-6" />
          <span>Issue Academic Credential</span>
        </CardTitle>
        <CardDescription>
          Issue a verifiable academic credential to a student
        </CardDescription>
        
        {/* Progress Indicator */}
        <div className="flex items-center space-x-2 mt-4">
          {[1, 2, 3, 4, 5].map((s) => (
            <div key={s} className="flex items-center flex-1">
              <div
                className={`h-2 flex-1 rounded-full transition-colors ${
                  s <= step ? 'bg-primary' : 'bg-muted'
                }`}
              />
              {s < 5 && <div className="w-2" />}
            </div>
          ))}
        </div>
        <div className="flex justify-between text-xs text-muted-foreground mt-2">
          <span>Recipient</span>
          <span>Details</span>
          <span>Academic</span>
          <span>Document</span>
          <span>Review</span>
        </div>
      </CardHeader>

      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          {/* Step Content */}
          {step === 1 && renderStep1()}
          {step === 2 && renderStep2()}
          {step === 3 && renderStep3()}
          {step === 4 && renderStep4()}
          {step === 5 && renderStep5()}

          {/* Navigation Buttons */}
          <div className="flex justify-between pt-6 border-t">
            <div>
              {step > 1 && (
                <Button
                  type="button"
                  variant="outline"
                  onClick={prevStep}
                  disabled={isSubmitting}
                >
                  <ArrowLeft className="h-4 w-4 mr-2" />
                  Previous
                </Button>
              )}
              {onCancel && step === 1 && (
                <Button
                  type="button"
                  variant="outline"
                  onClick={onCancel}
                  disabled={isSubmitting}
                >
                  Cancel
                </Button>
              )}
            </div>

            <div>
              {step < 5 ? (
                <Button
                  type="button"
                  onClick={nextStep}
                  disabled={isSearching || !isReady}
                >
                  Next
                  <ArrowRight className="h-4 w-4 ml-2" />
                </Button>
              ) : (
                <Button
                  type="submit"
                  disabled={isSubmitting || !isReady}
                >
                  {isSubmitting ? (
                    <>
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                      Issuing...
                    </>
                  ) : (
                    <>
                      <GraduationCap className="h-4 w-4 mr-2" />
                      Issue Credential
                    </>
                  )}
                </Button>
              )}
            </div>
          </div>
        </form>
      </CardContent>
    </Card>
  );
}
</file>

<file path="src/components/credentials/VerifyCredential.tsx">
// src/components/credentials/VerifyCredential.tsx
import { useState, useEffect } from 'react';
import { 
  Search, 
  Upload, 
  QrCode, 
  CheckCircle2, 
  XCircle, 
  AlertCircle,
  Loader2,
  FileText,
  Hash,
  Building2,
  Calendar,
  User,
  ExternalLink,
  Download,
  Shield,
  Award
} from 'lucide-react';
import { Button } from '../ui/Button';
import { Input } from '../ui/Input';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '../ui/Card';
import { Badge } from '../ui/Badge';
import { toast } from 'sonner';

interface VerificationResult {
  found: boolean;
  credential?: {
    id: string;
    holder: string;
    issuer: string;
    issuerName?: string;
    credentialHash: string;
    credentialType: string;
    degreeName?: string;
    fieldOfStudy?: string;
    issuedAt: number;
    expiresAt?: number;
    revoked: boolean;
    metadata?: string;
  };
  blockNumber?: number;
  timestamp?: number;
}

type VerificationMethod = 'hash' | 'file' | 'qr';

interface VerifyCredentialProps {
  initialHash?: string;
}

export default function VerifyCredential({ initialHash }: VerifyCredentialProps = {}) {
  const [method, setMethod] = useState<VerificationMethod>('hash');
  const [hashInput, setHashInput] = useState(initialHash || '');
  const [isVerifying, setIsVerifying] = useState(false);
  const [verificationResult, setVerificationResult] = useState<VerificationResult | null>(null);
  const [uploadedFile, setUploadedFile] = useState<File | null>(null);

  // Auto-verify if initial hash is provided
  useEffect(() => {
    if (initialHash && initialHash.length > 10) {
      verifyByHash(initialHash);
    }
  }, [initialHash]);

  // Verify credential by hash
  const verifyByHash = async (hash: string) => {
    if (!hash || hash.length < 10) {
      toast.error('Please enter a valid credential hash');
      return;
    }

    setIsVerifying(true);
    setVerificationResult(null);

    try {
      // TODO: Replace with actual blockchain query
      await new Promise(resolve => setTimeout(resolve, 1500));

      // Mock verification result
      const mockResult: VerificationResult = {
        found: true,
        credential: {
          id: 'cred_' + Math.random().toString(36).substr(2, 9),
          holder: '5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY',
          issuer: '5FHneW46xGXgs5mUiveU4sbTyGBzmstUspZC92UhjJM694ty',
          issuerName: 'Massachusetts Institute of Technology',
          credentialHash: hash,
          credentialType: "Bachelor's Degree",
          degreeName: 'Bachelor of Science in Computer Science',
          fieldOfStudy: 'Computer Science',
          issuedAt: Date.now() - 365 * 24 * 60 * 60 * 1000,
          revoked: false,
          metadata: 'Graduated with honors. GPA: 3.85',
        },
        blockNumber: 12345678,
        timestamp: Date.now() - 365 * 24 * 60 * 60 * 1000,
      };

      setVerificationResult(mockResult);
      toast.success('Credential verified successfully');
    } catch (error) {
      console.error('Verification failed:', error);
      setVerificationResult({ found: false });
      toast.error('Verification failed');
    } finally {
      setIsVerifying(false);
    }
  };

  // Handle file upload
  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (!file) return;

    if (!file.type.includes('json') && !file.type.includes('pdf')) {
      toast.error('Please upload a JSON or PDF file');
      return;
    }

    setUploadedFile(file);

    try {
      const text = await file.text();
      const data = JSON.parse(text);
      
      if (data.credentialHash) {
        setHashInput(data.credentialHash);
        await verifyByHash(data.credentialHash);
      } else {
        toast.error('No credential hash found in file');
      }
    } catch (error) {
      toast.error('Failed to read file');
    }
  };

  // Handle form submit
  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    verifyByHash(hashInput);
  };

  // Format date
  const formatDate = (timestamp: number) => {
    return new Date(timestamp).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric',
    });
  };

  // Get verification status
  const getVerificationStatus = () => {
    if (!verificationResult) return null;

    if (!verificationResult.found) {
      return {
        icon: XCircle,
        title: 'Credential Not Found',
        description: 'This credential does not exist in the blockchain',
        color: 'text-red-600',
        bgColor: 'bg-red-50 dark:bg-red-900/20',
        borderColor: 'border-red-200 dark:border-red-800',
      };
    }

    const cred = verificationResult.credential!;

    if (cred.revoked) {
      return {
        icon: AlertCircle,
        title: 'Credential Revoked',
        description: 'This credential has been revoked and is no longer valid',
        color: 'text-orange-600',
        bgColor: 'bg-orange-50 dark:bg-orange-900/20',
        borderColor: 'border-orange-200 dark:border-orange-800',
      };
    }

    if (cred.expiresAt && cred.expiresAt < Date.now()) {
      return {
        icon: AlertCircle,
        title: 'Credential Expired',
        description: 'This credential has expired',
        color: 'text-yellow-600',
        bgColor: 'bg-yellow-50 dark:bg-yellow-900/20',
        borderColor: 'border-yellow-200 dark:border-yellow-800',
      };
    }

    return {
      icon: CheckCircle2,
      title: 'Valid Credential',
      description: 'This credential is authentic and active',
      color: 'text-green-600',
      bgColor: 'bg-green-50 dark:bg-green-900/20',
      borderColor: 'border-green-200 dark:border-green-800',
    };
  };

  const status = getVerificationStatus();

  return (
    <div className="space-y-8">
      {/* Verification Methods */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center">
            <Shield className="h-6 w-6 mr-2 text-primary" />
            Verify Academic Credential
          </CardTitle>
          <CardDescription>
            Enter a credential hash, upload a credential file, or scan a QR code to verify authenticity
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Method Tabs */}
          <div className="flex space-x-2 border-b border-border">
            <button
              onClick={() => setMethod('hash')}
              className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                method === 'hash'
                  ? 'border-primary text-primary'
                  : 'border-transparent text-muted-foreground hover:text-foreground'
              }`}
            >
              <Hash className="inline h-4 w-4 mr-1" />
              Hash Input
            </button>
            <button
              onClick={() => setMethod('file')}
              className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                method === 'file'
                  ? 'border-primary text-primary'
                  : 'border-transparent text-muted-foreground hover:text-foreground'
              }`}
            >
              <Upload className="inline h-4 w-4 mr-1" />
              File Upload
            </button>
            <button
              onClick={() => setMethod('qr')}
              className={`px-4 py-2 text-sm font-medium border-b-2 transition-colors ${
                method === 'qr'
                  ? 'border-primary text-primary'
                  : 'border-transparent text-muted-foreground hover:text-foreground'
              }`}
            >
              <QrCode className="inline h-4 w-4 mr-1" />
              QR Code
            </button>
          </div>

          {/* Hash Input Method */}
          {method === 'hash' && (
            <form onSubmit={handleSubmit} className="space-y-4">
              <div>
                <label className="block text-sm font-semibold mb-2">
                  Credential Hash
                </label>
                <div className="flex space-x-2">
                  <Input
                    type="text"
                    placeholder="Enter credential hash (0x...)"
                    value={hashInput}
                    onChange={(e) => setHashInput(e.target.value)}
                    className="flex-1 font-mono text-sm"
                  />
                  <Button
                    type="submit"
                    disabled={isVerifying || !hashInput}
                  >
                    {isVerifying ? (
                      <>
                        <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                        Verifying...
                      </>
                    ) : (
                      <>
                        <Search className="h-4 w-4 mr-2" />
                        Verify
                      </>
                    )}
                  </Button>
                </div>
                <p className="text-xs text-muted-foreground mt-2">
                  The credential hash is a unique identifier stored on the blockchain
                </p>
              </div>
            </form>
          )}

          {/* File Upload Method */}
          {method === 'file' && (
            <div className="space-y-4">
              <div>
                <label className="block text-sm font-semibold mb-2">
                  Upload Credential File
                </label>
                <div className="border-2 border-dashed border-border rounded-lg p-8 text-center hover:border-primary transition-colors">
                  <input
                    type="file"
                    accept=".json,.pdf"
                    onChange={handleFileUpload}
                    className="hidden"
                    id="credential-file-upload"
                  />
                  <label htmlFor="credential-file-upload" className="cursor-pointer">
                    <Upload className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
                    <p className="text-sm font-medium mb-1">
                      Click to upload or drag and drop
                    </p>
                    <p className="text-xs text-muted-foreground">
                      JSON or PDF files only
                    </p>
                  </label>
                </div>
                {uploadedFile && (
                  <div className="flex items-center space-x-2 mt-3 text-sm">
                    <FileText className="h-4 w-4 text-primary" />
                    <span>{uploadedFile.name}</span>
                    <button
                      onClick={() => setUploadedFile(null)}
                      className="text-red-600 hover:underline ml-auto"
                    >
                      Remove
                    </button>
                  </div>
                )}
              </div>
            </div>
          )}

          {/* QR Code Method */}
          {method === 'qr' && (
            <div className="space-y-4">
              <div className="border-2 border-dashed border-border rounded-lg p-8 text-center">
                <QrCode className="h-16 w-16 mx-auto text-muted-foreground mb-4" />
                <p className="text-sm font-medium mb-2">
                  QR Code Scanner
                </p>
                <p className="text-xs text-muted-foreground mb-4">
                  Scan a credential QR code to verify
                </p>
                <Button variant="outline" disabled>
                  <QrCode className="h-4 w-4 mr-2" />
                  Open Camera (Coming Soon)
                </Button>
              </div>
            </div>
          )}
        </CardContent>
      </Card>

      {/* Verification Result */}
      {verificationResult && status && (
        <Card className={`${status.borderColor} border-2`}>
          <CardContent className="pt-6">
            <div className={`${status.bgColor} rounded-lg p-6 space-y-6`}>
              {/* Status Header */}
              <div className="flex items-center space-x-4">
                <div className={`h-16 w-16 rounded-full ${status.bgColor} flex items-center justify-center`}>
                  <status.icon className={`h-8 w-8 ${status.color}`} />
                </div>
                <div className="flex-1">
                  <h3 className={`text-2xl font-bold ${status.color}`}>
                    {status.title}
                  </h3>
                  <p className="text-sm text-muted-foreground mt-1">
                    {status.description}
                  </p>
                </div>
              </div>

              {/* Credential Details (if found) */}
              {verificationResult.found && verificationResult.credential && (
                <div className="space-y-6 pt-6 border-t border-border">
                  {/* Main Info */}
                  <div className="bg-background rounded-lg p-6 space-y-4">
                    <div className="flex items-start justify-between">
                      <div className="flex-1">
                        <div className="flex items-center space-x-2 mb-3">
                          <Badge variant="outline" className="text-sm">
                            {verificationResult.credential.credentialType}
                          </Badge>
                          {verificationResult.credential.revoked ? (
                            <Badge variant="error">Revoked</Badge>
                          ) : verificationResult.credential.expiresAt && verificationResult.credential.expiresAt < Date.now() ? (
                            <Badge variant="warning">Expired</Badge>
                          ) : (
                            <Badge variant="success">Active</Badge>
                          )}
                        </div>
                        <h4 className="text-xl font-bold mb-2">
                          {verificationResult.credential.degreeName || 'Academic Credential'}
                        </h4>
                        {verificationResult.credential.fieldOfStudy && (
                          <p className="text-muted-foreground">
                            {verificationResult.credential.fieldOfStudy}
                          </p>
                        )}
                      </div>
                      <Award className="h-12 w-12 text-primary opacity-20" />
                    </div>

                    {/* Details Grid */}
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6 pt-4 border-t">
                      {/* Issuer */}
                      <div>
                        <label className="text-sm font-semibold text-muted-foreground flex items-center mb-2">
                          <Building2 className="h-3 w-3 mr-1" />
                          Issued By
                        </label>
                        <p className="font-medium">
                          {verificationResult.credential.issuerName || 'Unknown Institution'}
                        </p>
                        <code className="text-xs font-mono text-muted-foreground block mt-1 truncate">
                          {verificationResult.credential.issuer}
                        </code>
                      </div>

                      {/* Holder */}
                      <div>
                        <label className="text-sm font-semibold text-muted-foreground flex items-center mb-2">
                          <User className="h-3 w-3 mr-1" />
                          Credential Holder
                        </label>
                        <code className="text-xs font-mono block truncate">
                          {verificationResult.credential.holder}
                        </code>
                      </div>

                      {/* Issue Date */}
                      <div>
                        <label className="text-sm font-semibold text-muted-foreground flex items-center mb-2">
                          <Calendar className="h-3 w-3 mr-1" />
                          Issue Date
                        </label>
                        <p className="font-medium">
                          {formatDate(verificationResult.credential.issuedAt)}
                        </p>
                      </div>

                      {/* Expiration Date */}
                      {verificationResult.credential.expiresAt && (
                        <div>
                          <label className="text-sm font-semibold text-muted-foreground flex items-center mb-2">
                            <Calendar className="h-3 w-3 mr-1" />
                            Expiration Date
                          </label>
                          <p className="font-medium">
                            {formatDate(verificationResult.credential.expiresAt)}
                          </p>
                        </div>
                      )}
                    </div>

                    {/* Metadata */}
                    {verificationResult.credential.metadata && (
                      <div className="pt-4 border-t">
                        <label className="text-sm font-semibold text-muted-foreground mb-2 block">
                          Additional Information
                        </label>
                        <p className="text-sm">{verificationResult.credential.metadata}</p>
                      </div>
                    )}

                    {/* Credential Hash */}
                    <div className="pt-4 border-t">
                      <label className="text-sm font-semibold text-muted-foreground flex items-center mb-2">
                        <Hash className="h-3 w-3 mr-1" />
                        Credential Hash
                      </label>
                      <code className="text-xs font-mono bg-muted px-3 py-2 rounded block break-all">
                        {verificationResult.credential.credentialHash}
                      </code>
                    </div>
                  </div>

                  {/* Blockchain Info */}
                  <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                    <div className="flex items-start space-x-3">
                      <Shield className="h-5 w-5 text-blue-600 dark:text-blue-500 flex-shrink-0 mt-0.5" />
                      <div>
                        <p className="font-semibold text-blue-800 dark:text-blue-400">
                          Blockchain Verified
                        </p>
                        <p className="text-sm text-blue-700 dark:text-blue-300 mt-1">
                          This credential is permanently recorded on the blockchain.
                          {verificationResult.blockNumber && (
                            <> Verified at block #{verificationResult.blockNumber.toLocaleString()}</>
                          )}
                        </p>
                      </div>
                    </div>
                  </div>

                  {/* Actions */}
                  <div className="flex flex-wrap gap-3">
                    <Button
                      variant="outline"
                      onClick={() => {
                        const data = JSON.stringify(verificationResult.credential, null, 2);
                        const blob = new Blob([data], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'verification-report.json';
                        a.click();
                        URL.revokeObjectURL(url);
                      }}
                    >
                      <Download className="h-4 w-4 mr-2" />
                      Download Report
                    </Button>
                    <Button
                      variant="outline"
                      onClick={() => {
                        window.print();
                      }}
                    >
                      <FileText className="h-4 w-4 mr-2" />
                      Print
                    </Button>
                  </div>
                </div>
              )}

              {/* Not Found Message */}
              {!verificationResult.found && (
                <div className="space-y-4">
                  <div className="text-center py-6">
                    <p className="text-muted-foreground">
                      No credential found with this hash. Possible reasons:
                    </p>
                    <ul className="text-sm text-muted-foreground mt-4 space-y-2 text-left max-w-md mx-auto">
                      <li className="flex items-start">
                        <span className="mr-2"></span>
                        <span>The credential has not been issued yet</span>
                      </li>
                      <li className="flex items-start">
                        <span className="mr-2"></span>
                        <span>The hash is incorrect or incomplete</span>
                      </li>
                      <li className="flex items-start">
                        <span className="mr-2"></span>
                        <span>The credential was issued on a different network</span>
                      </li>
                    </ul>
                  </div>
                </div>
              )}
            </div>
          </CardContent>
        </Card>
      )}

      {/* Info Section */}
      {!verificationResult && (
        <Card>
          <CardHeader>
            <CardTitle className="text-lg">How Verification Works</CardTitle>
          </CardHeader>
          <CardContent className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
              <div>
                <div className="h-12 w-12 rounded-lg bg-primary/10 flex items-center justify-center mb-3">
                  <Shield className="h-6 w-6 text-primary" />
                </div>
                <h4 className="font-semibold mb-2">Blockchain Security</h4>
                <p className="text-sm text-muted-foreground">
                  All credentials are cryptographically secured and stored on the blockchain, making them tamper-proof.
                </p>
              </div>
              <div>
                <div className="h-12 w-12 rounded-lg bg-primary/10 flex items-center justify-center mb-3">
                  <CheckCircle2 className="h-6 w-6 text-primary" />
                </div>
                <h4 className="font-semibold mb-2">Instant Verification</h4>
                <p className="text-sm text-muted-foreground">
                  Verify any credential in seconds without needing to contact the issuing institution.
                </p>
              </div>
              <div>
                <div className="h-12 w-12 rounded-lg bg-primary/10 flex items-center justify-center mb-3">
                  <ExternalLink className="h-6 w-6 text-primary" />
                </div>
                <h4 className="font-semibold mb-2">Public Access</h4>
                <p className="text-sm text-muted-foreground">
                  Anyone can verify credentials without creating an account or connecting a wallet.
                </p>
              </div>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
</file>

<file path="src/components/did/CreateDIDForm.tsx">
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { Key, Copy, Download, Eye, EyeOff, AlertTriangle, CheckCircle2, Loader2, RefreshCw } from 'lucide-react';
import { Button } from '../ui/Button';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '../ui/Card';
import { Input } from '../ui/Input';
import { Badge } from '../ui/Badge';
import { toast } from 'sonner';
import { mnemonicGenerate, mnemonicToMiniSecret, naclKeypairFromSeed } from '@polkadot/util-crypto';
import { u8aToHex } from '@polkadot/util';
import { Keyring } from '@polkadot/keyring';
import { useBlockchain } from '@/hooks/blockchain/useBlockchain';
import { useWalletStore } from '@/store/wallet.store';
import { useDIDStore } from '@/store/did.store';

// Form validation schema
const createDIDSchema = z.object({
  keyType: z.enum(['Ed25519', 'Sr25519', 'ECDSA']),
  backupConfirmed: z.boolean().refine(val => val === true, {
    message: 'You must confirm that you have backed up your keys',
  }),
});

type CreateDIDFormData = z.infer<typeof createDIDSchema>;

// Key types with descriptions
const KEY_TYPES = [
  {
    value: 'Ed25519',
    name: 'Ed25519',
    description: 'Recommended - Fast and secure',
    recommended: true,
  },
  {
    value: 'Sr25519',
    name: 'Sr25519',
    description: 'Substrate native - More features',
    recommended: false,
  },
  {
    value: 'ECDSA',
    name: 'ECDSA',
    description: 'Ethereum compatible',
    recommended: false,
  },
] as const;

interface CreateDIDFormProps {
  onSuccess?: (did: string) => void;
  onCancel?: () => void;
}

export default function CreateDIDForm({ onSuccess, onCancel }: CreateDIDFormProps) {
  const [step, setStep] = useState<'select' | 'generate' | 'backup' | 'confirm' | 'submit'>('select');
  const [generatedKeys, setGeneratedKeys] = useState<{
    publicKey: string;
    mnemonic: string;
    address: string;
  } | null>(null);
  const [showMnemonic, setShowMnemonic] = useState(false);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [transactionStatus, setTransactionStatus] = useState('');

  const { account } = useWalletStore();
  const { transactions, isReady } = useBlockchain();
  const { setDID } = useDIDStore();

  const { register, handleSubmit, watch, formState: { errors } } = useForm<CreateDIDFormData>({
    resolver: zodResolver(createDIDSchema),
    defaultValues: {
      keyType: 'Ed25519',
      backupConfirmed: false,
    },
  });

  const selectedKeyType = watch('keyType');

  // Generate keys with real Polkadot keypair
  const generateKeys = async () => {
    try {
      setStep('generate');
      
      // Generate a random 12-word mnemonic
      const mnemonic = mnemonicGenerate(12);
      
      await new Promise(resolve => setTimeout(resolve, 500));
      
      // Create keyring with the selected key type
      const keyring = new Keyring({ 
        type: selectedKeyType.toLowerCase() as 'ed25519' | 'sr25519' | 'ecdsa' 
      });
      
      // Create keypair from mnemonic
      const pair = keyring.addFromMnemonic(mnemonic);
      
      const keys = {
        publicKey: u8aToHex(pair.publicKey),
        mnemonic: mnemonic,
        address: pair.address,
      };
      
      console.log('Generated keys:', {
        address: keys.address,
        publicKey: keys.publicKey,
        keyType: selectedKeyType,
      });
      
      setGeneratedKeys(keys);
      setStep('backup');
      toast.success('Keys generated successfully');
    } catch (error) {
      console.error('Failed to generate keys:', error);
      toast.error('Failed to generate keys');
      setStep('select');
    }
  };

  // Regenerate keys
  const regenerateKeys = async () => {
    toast.info('Generating new keys...');
    await generateKeys();
  };

  // Copy to clipboard
  const copyToClipboard = (text: string, label: string) => {
    navigator.clipboard.writeText(text);
    toast.success(`${label} copied to clipboard`);
  };

  // Download backup file
  const downloadBackup = () => {
    if (!generatedKeys) return;
    
    const backup = {
      publicKey: generatedKeys.publicKey,
      mnemonic: generatedKeys.mnemonic,
      address: generatedKeys.address,
      keyType: selectedKeyType,
      createdAt: new Date().toISOString(),
      warning: 'KEEP THIS FILE SECURE! Anyone with this information can control your DID.',
    };
    
    const blob = new Blob([JSON.stringify(backup, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `did-backup-${Date.now()}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    toast.success('Backup file downloaded');
  };

  // Submit DID creation to blockchain
  const onSubmit = async (data: CreateDIDFormData) => {
    if (!generatedKeys || !account || !transactions || !isReady) {
      toast.error('Wallet not connected or blockchain not ready');
      return;
    }
    
    setIsSubmitting(true);
    
    try {
      console.log(' Submitting DID creation to blockchain...');
      
      // Convert hex public key to Uint8Array
      const publicKeyHex = generatedKeys.publicKey.startsWith('0x') 
        ? generatedKeys.publicKey.slice(2) 
        : generatedKeys.publicKey;
      
      const publicKeyBytes = new Uint8Array(
        publicKeyHex.match(/.{1,2}/g)!.map(byte => parseInt(byte, 16))
      );

      console.log(' Transaction details:', {
        from: account.address,
        publicKey: generatedKeys.publicKey,
        keyType: data.keyType,
      });

      // Call the blockchain transaction with status updates
      const result = await transactions.did.createDID(
        account,
        publicKeyBytes,
        data.keyType,
        (status) => {
          console.log('Transaction status:', status);
          setTransactionStatus(status.message);
          
          if (status.status === 'signing') {
            toast.info('Please sign the transaction in your wallet');
          } else if (status.status === 'inBlock') {
            toast.info('Transaction included in block');
          }
        }
      );

      if (result.success) {
        console.log(' DID created successfully!', result);
        
        // Update DID store
        setDID(generatedKeys.address, [{
          id: 'primary_key',
          keyType: data.keyType,
          publicKey: generatedKeys.publicKey,
          addedAt: Date.now(),
        }]);
        
        toast.success('DID created successfully!', {
          description: `Block: ${result.blockHash?.slice(0, 10)}...`,
        });
        
        onSuccess?.(generatedKeys.address);
      } else {
        throw new Error(result.error || 'Transaction failed');
      }
    } catch (error: any) {
      console.error(' Failed to create DID:', error);
      
      let errorMessage = 'Failed to create DID';
      
      if (error.message?.includes('1010')) {
        errorMessage = 'Insufficient balance for transaction fee';
      } else if (error.message?.includes('rejected')) {
        errorMessage = 'Transaction was rejected';
      } else if (error.message?.includes('DidAlreadyExists')) {
        errorMessage = 'DID already exists for this account';
      } else if (error.message) {
        errorMessage = error.message;
      }
      
      toast.error(errorMessage, {
        description: 'Please check your balance and try again',
      });
    } finally {
      setIsSubmitting(false);
      setTransactionStatus('');
    }
  };

  // Step 1: Select Key Type
  if (step === 'select') {
    return (
      <Card className="max-w-2xl mx-auto">
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <Key className="h-6 w-6" />
            <span>Create Your DID</span>
          </CardTitle>
          <CardDescription>
            Choose a key type for your decentralized identifier
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* Connection Check */}
          {!account && (
            <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
              <div className="flex items-start space-x-3">
                <AlertTriangle className="h-5 w-5 text-yellow-600 dark:text-yellow-500 flex-shrink-0 mt-0.5" />
                <div className="text-sm">
                  <p className="font-semibold text-yellow-800 dark:text-yellow-400">Wallet Not Connected</p>
                  <p className="text-yellow-700 dark:text-yellow-300 mt-1">
                    Please connect your wallet first to create a DID.
                  </p>
                </div>
              </div>
            </div>
          )}

          {!isReady && (
            <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
              <div className="flex items-start space-x-3">
                <Loader2 className="h-5 w-5 animate-spin text-blue-600 dark:text-blue-500 flex-shrink-0 mt-0.5" />
                <div className="text-sm">
                  <p className="font-semibold text-blue-800 dark:text-blue-400">Connecting to Blockchain</p>
                  <p className="text-blue-700 dark:text-blue-300 mt-1">
                    Please wait while we connect to the blockchain...
                  </p>
                </div>
              </div>
            </div>
          )}

          <div className="space-y-3">
            {KEY_TYPES.map((type) => (
              <label
                key={type.value}
                className={`
                  flex items-start p-4 border-2 rounded-lg cursor-pointer transition-all
                  ${selectedKeyType === type.value 
                    ? 'border-primary bg-primary/5' 
                    : 'border-border hover:border-primary/50'
                  }
                `}
              >
                <input
                  type="radio"
                  value={type.value}
                  {...register('keyType')}
                  className="mt-1"
                />
                <div className="ml-3 flex-1">
                  <div className="flex items-center space-x-2">
                    <span className="font-semibold">{type.name}</span>
                    {type.recommended && (
                      <Badge variant="success" className="text-xs">Recommended</Badge>
                    )}
                  </div>
                  <p className="text-sm text-muted-foreground mt-1">{type.description}</p>
                </div>
              </label>
            ))}
          </div>

          <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
            <div className="flex items-start space-x-3">
              <AlertTriangle className="h-5 w-5 text-yellow-600 dark:text-yellow-500 flex-shrink-0 mt-0.5" />
              <div className="text-sm">
                <p className="font-semibold text-yellow-800 dark:text-yellow-400">Important Security Notice</p>
                <p className="text-yellow-700 dark:text-yellow-300 mt-1">
                  You will receive a randomly generated recovery phrase. Write it down and store it safely. 
                  Anyone with this phrase can control your DID.
                </p>
              </div>
            </div>
          </div>

          <div className="flex justify-between">
            {onCancel && (
              <Button variant="outline" onClick={onCancel}>
                Cancel
              </Button>
            )}
            <Button 
              onClick={generateKeys} 
              className="ml-auto"
              disabled={!account || !isReady}
            >
              Continue
            </Button>
          </div>
        </CardContent>
      </Card>
    );
  }

  // Step 2: Generating (Loading)
  if (step === 'generate') {
    return (
      <Card className="max-w-2xl mx-auto">
        <CardContent className="py-12">
          <div className="text-center space-y-4">
            <Loader2 className="h-12 w-12 animate-spin mx-auto text-primary" />
            <h3 className="text-xl font-semibold">Generating Your Keys...</h3>
            <p className="text-muted-foreground">Creating a secure random seed phrase</p>
          </div>
        </CardContent>
      </Card>
    );
  }

  // Step 3 & 4: Backup Keys
  if (step === 'backup' || step === 'confirm') {
    return (
      <Card className="max-w-2xl mx-auto">
        <CardHeader>
          <CardTitle className="flex items-center space-x-2">
            <Key className="h-6 w-6" />
            <span>Backup Your Keys</span>
          </CardTitle>
          <CardDescription>
            Save these keys securely. You'll need them to recover your DID.
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-6">
          {/* DID Address */}
          <div>
            <label className="text-sm font-semibold mb-2 block">Your DID Address</label>
            <div className="flex items-center space-x-2">
              <Input 
                value={generatedKeys?.address || ''} 
                readOnly 
                className="font-mono text-sm"
              />
              <Button
                variant="outline"
                size="icon"
                onClick={() => copyToClipboard(generatedKeys?.address || '', 'Address')}
              >
                <Copy className="h-4 w-4" />
              </Button>
            </div>
          </div>

          {/* Public Key */}
          <div>
            <label className="text-sm font-semibold mb-2 block">Public Key</label>
            <div className="flex items-center space-x-2">
              <Input 
                value={generatedKeys?.publicKey || ''} 
                readOnly 
                className="font-mono text-sm"
              />
              <Button
                variant="outline"
                size="icon"
                onClick={() => copyToClipboard(generatedKeys?.publicKey || '', 'Public key')}
              >
                <Copy className="h-4 w-4" />
              </Button>
            </div>
          </div>

          {/* Recovery Phrase */}
          <div>
            <div className="flex items-center justify-between mb-2">
              <label className="text-sm font-semibold">
                Recovery Phrase (Mnemonic)
              </label>
              <Button
                variant="ghost"
                size="sm"
                onClick={regenerateKeys}
                className="text-xs"
              >
                <RefreshCw className="h-3 w-3 mr-1" />
                Generate New
              </Button>
            </div>
            <div className="space-y-2">
              <div className="relative">
                <Input 
                  value={generatedKeys?.mnemonic || ''} 
                  type={showMnemonic ? 'text' : 'password'}
                  readOnly 
                  className="font-mono text-sm pr-20"
                />
                <div className="absolute right-2 top-1/2 -translate-y-1/2 flex space-x-1">
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-8 w-8"
                    onClick={() => setShowMnemonic(!showMnemonic)}
                  >
                    {showMnemonic ? <EyeOff className="h-4 w-4" /> : <Eye className="h-4 w-4" />}
                  </Button>
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-8 w-8"
                    onClick={() => copyToClipboard(generatedKeys?.mnemonic || '', 'Recovery phrase')}
                  >
                    <Copy className="h-4 w-4" />
                  </Button>
                </div>
              </div>
              <p className="text-xs text-muted-foreground">
                This is a randomly generated 12-word phrase. Click "Generate New" to create a different one.
              </p>
            </div>
          </div>

          {/* Download Backup */}
          <Button
            variant="outline"
            className="w-full"
            onClick={downloadBackup}
          >
            <Download className="h-4 w-4 mr-2" />
            Download Backup File
          </Button>

          {/* Security Warning */}
          <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
            <div className="flex items-start space-x-3">
              <AlertTriangle className="h-5 w-5 text-red-600 dark:text-red-500 flex-shrink-0 mt-0.5" />
              <div className="text-sm">
                <p className="font-semibold text-red-800 dark:text-red-400">Critical Security Warning</p>
                <ul className="text-red-700 dark:text-red-300 mt-2 space-y-1 list-disc list-inside">
                  <li>Never share your recovery phrase with anyone</li>
                  <li>Store it in a secure location (password manager, safe, etc.)</li>
                  <li>If you lose it, you cannot recover your DID</li>
                  <li>Anyone with this phrase can control your DID</li>
                  <li>You can generate a new phrase if you're not satisfied with this one</li>
                </ul>
              </div>
            </div>
          </div>

          {/* Confirmation Checkbox */}
          <label className="flex items-start space-x-3 cursor-pointer">
            <input
              type="checkbox"
              {...register('backupConfirmed')}
              className="mt-1"
            />
            <span className="text-sm">
              I have securely backed up my recovery phrase and understand that I cannot recover 
              my DID without it. I accept full responsibility for keeping it safe.
            </span>
          </label>
          {errors.backupConfirmed && (
            <p className="text-sm text-red-600">{errors.backupConfirmed.message}</p>
          )}

          {/* Transaction Status */}
          {transactionStatus && (
            <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
              <div className="flex items-center space-x-3">
                <Loader2 className="h-5 w-5 animate-spin text-blue-600 dark:text-blue-500" />
                <p className="text-sm font-medium text-blue-800 dark:text-blue-400">
                  {transactionStatus}
                </p>
              </div>
            </div>
          )}

          {/* Actions */}
          <div className="flex justify-between pt-4">
            <Button 
              variant="outline" 
              onClick={() => {
                setStep('select');
                setGeneratedKeys(null);
              }}
              disabled={isSubmitting}
            >
              Start Over
            </Button>
            <Button
              onClick={handleSubmit(onSubmit)}
              disabled={isSubmitting || !isReady}
            >
              {isSubmitting ? (
                <>
                  <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                  Creating DID...
                </>
              ) : (
                <>
                  <CheckCircle2 className="h-4 w-4 mr-2" />
                  Create DID
                </>
              )}
            </Button>
          </div>
        </CardContent>
      </Card>
    );
  }

  return null;
}
</file>

<file path="src/components/did/CreateDIDModal.tsx">
import { Modal } from '../ui/Modal';
import CreateDIDForm from './CreateDIDForm';
import { useDIDStore } from '@/store/did.store';

interface CreateDIDModalProps {
  isOpen: boolean;
  onClose: () => void;
}

export default function CreateDIDModal({ isOpen, onClose }: CreateDIDModalProps) {
  const setDID = useDIDStore(state => state.setDID);

  const handleSuccess = (didAddress: string) => {
    // Update store with new DID
    setDID(didAddress, [{
      id: '1',
      keyType: 'Ed25519',
      publicKey: '0x...',
      addedAt: Date.now(),
    }]);
    
    // Close modal
    onClose();
  };

  return (
    <Modal
      isOpen={isOpen}
      onClose={onClose}
      className="max-w-3xl"
    >
      <CreateDIDForm 
        onSuccess={handleSuccess}
        onCancel={onClose}
      />
    </Modal>
  );
}
</file>

<file path="src/components/did/DIDStatus.tsx">
import { CheckCircle, Clock, AlertCircle, User } from 'lucide-react';
import { useDIDStore } from '@/store/did.store';
import { Badge } from '../ui/Badge';
import { DID_STATUS } from '@/lib/utils/constants';

export default function DIDStatus() {
  const { hasDID, status, isInstitution } = useDIDStore();

  const getStatusConfig = () => {
    switch (status) {
      case DID_STATUS.ACTIVE:
        return {
          icon: CheckCircle,
          text: 'Active',
          variant: 'success' as const,
          description: 'Your identity is active',
        };
      case DID_STATUS.INACTIVE:
        return {
          icon: AlertCircle,
          text: 'Inactive',
          variant: 'warning' as const,
          description: 'Your identity is deactivated',
        };
      case DID_STATUS.PENDING:
        return {
          icon: Clock,
          text: 'Pending',
          variant: 'warning' as const,
          description: 'Verification pending',
        };
      default:
        return {
          icon: User,
          text: 'No DID',
          variant: 'outline' as const,
          description: 'Create your DID to get started',
        };
    }
  };

  const config = getStatusConfig();
  const StatusIcon = config.icon;

  return (
    <div className="flex items-center space-x-3 p-3 rounded-lg bg-accent/50">
      <div className="h-10 w-10 rounded-full bg-primary/10 flex items-center justify-center">
        <StatusIcon className="h-5 w-5 text-primary" />
      </div>
      <div className="flex-1 min-w-0">
        <div className="flex items-center space-x-2">
          <p className="text-sm font-medium truncate">
            {hasDID ? 'Identity' : 'No Identity'}
          </p>
          <Badge variant={config.variant} className="text-xs">
            {config.text}
          </Badge>
        </div>
        <p className="text-xs text-muted-foreground truncate">
          {config.description}
        </p>
        {isInstitution && (
          <Badge variant="secondary" className="mt-1 text-xs">
            Institution
          </Badge>
        )}
      </div>
    </div>
  );
}
</file>

<file path="src/components/did/index.ts">
export { default as DIDStatus } from './DIDStatus';
export { default as CreateDIDForm } from './CreateDIDForm';
export { default as CreateDIDModal } from './CreateDIDModal';
export { default as InstitutionRegistration } from './InstitutionRegistration';
</file>

<file path="src/components/did/InstitutionRegistration.tsx">
// src/components/did/InstitutionRegistration.tsx - FIXED VERSION
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import { 
  Building2, 
  Upload, 
  FileText, 
  CheckCircle2, 
  Loader2, 
  AlertCircle,
  ArrowLeft,
  ArrowRight,
  Globe,
  Mail,
  Phone,
  MapPin
} from 'lucide-react';
import { Button } from '../ui/Button';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '../ui/Card';
import { Input } from '../ui/Input';
import { Badge } from '../ui/Badge';
import { toast } from 'sonner';
import { INSTITUTION_TYPES } from '@/lib/utils/constants';
import { useDIDStore } from '@/store/did.store';
import { useWalletStore } from '@/store/wallet.store';
import { useBlockchain } from '@/hooks/blockchain/useBlockchain';

// Form validation schema
const institutionSchema = z.object({
  name: z.string()
    .min(3, 'Institution name must be at least 3 characters')
    .max(100, 'Institution name must be less than 100 characters'),
  type: z.enum(INSTITUTION_TYPES),
  description: z.string()
    .max(500, 'Description must be less than 500 characters')
    .optional(),
  country: z.string().min(2, 'Please select a country'),
  website: z.string().url('Please enter a valid URL'),
  
  // Contact information
  contactName: z.string().min(2, 'Contact name is required'),
  contactEmail: z.string().email('Please enter a valid email'),
  contactPhone: z.string().min(5, 'Please enter a valid phone number'),
  address: z.string().min(10, 'Please enter a complete address'),
  
  // Legal
  termsAccepted: z.boolean().refine(val => val === true, {
    message: 'You must accept the terms and conditions',
  }),
});

type InstitutionFormData = z.infer<typeof institutionSchema>;

interface InstitutionRegistrationProps {
  onSuccess?: () => void;
  onCancel?: () => void;
}

export default function InstitutionRegistration({ onSuccess, onCancel }: InstitutionRegistrationProps) {
  const [step, setStep] = useState<1 | 2 | 3 | 4>(1);
  const [uploadedDocs, setUploadedDocs] = useState<File[]>([]);
  const [docHashes, setDocHashes] = useState<string[]>([]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const [txStatus, setTxStatus] = useState<string>('');
  
  const { didAddress } = useDIDStore();
  const { account } = useWalletStore();
  const { transactions, isReady } = useBlockchain();

  const { 
    register, 
    handleSubmit, 
    watch, 
    formState: { errors },
    trigger 
  } = useForm<InstitutionFormData>({
    resolver: zodResolver(institutionSchema),
    defaultValues: {
      type: 'University',
      termsAccepted: false,
    },
  });

  const selectedType = watch('type');

  // Handle document upload
  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    
    if (files.length === 0) return;
    
    // Validate file types (PDF only for verification docs)
    const validFiles = files.filter(file => file.type === 'application/pdf');
    
    if (validFiles.length !== files.length) {
      toast.error('Only PDF files are allowed');
      return;
    }
    
    setUploadedDocs(prev => [...prev, ...validFiles]);
    
    // Generate hashes for each file
    for (const file of validFiles) {
      const hash = await generateFileHash(file);
      setDocHashes(prev => [...prev, hash]);
    }
    
    toast.success(`${validFiles.length} document(s) uploaded`);
  };

  // Generate file hash (mock - replace with actual Blake2)
  const generateFileHash = async (file: File): Promise<string> => {
    // Mock hash generation
    return '0x' + Array(64).fill(0).map(() => 
      Math.floor(Math.random() * 16).toString(16)
    ).join('');
  };

  // Remove uploaded document
  const removeDocument = (index: number) => {
    setUploadedDocs(prev => prev.filter((_, i) => i !== index));
    setDocHashes(prev => prev.filter((_, i) => i !== index));
    toast.success('Document removed');
  };

  // Navigate steps
  const nextStep = async () => {
    let fieldsToValidate: (keyof InstitutionFormData)[] = [];
    
    if (step === 1) {
      fieldsToValidate = ['name', 'type', 'description', 'country', 'website'];
    } else if (step === 3) {
      fieldsToValidate = ['contactName', 'contactEmail', 'contactPhone', 'address'];
    }
    
    const isValid = await trigger(fieldsToValidate);
    if (isValid) {
      setStep((prev) => Math.min(prev + 1, 4) as 1 | 2 | 3 | 4);
    }
  };

  const prevStep = () => {
    setStep((prev) => Math.max(prev - 1, 1) as 1 | 2 | 3 | 4);
  };

  // Submit registration - FIXED VERSION
  const onSubmit = async (data: InstitutionFormData) => {
    if (step !== 4) return;
    
    if (!transactions || !isReady) {
      toast.error('Blockchain connection not ready');
      return;
    }

    if (!account) {
      toast.error('Please connect your wallet');
      return;
    }

    setIsSubmitting(true);
    
    try {
      console.log(' Registering institution on blockchain:', {
        name: data.name,
        did: didAddress,
      });

      // Submit transaction to blockchain
      const result = await transactions.did.registerInstitution(
        account,
        data.name,
        (status) => {
          setTxStatus(status.message);
          console.log('Transaction status:', status);
        }
      );

      if (result.success) {
        console.log(' Institution registered successfully');
        
        // Update local store AFTER successful blockchain transaction
        useDIDStore.getState().setInstitution(data.name);
        
        toast.success('Institution registration submitted!', {
          description: 'Your application is pending verification',
        });
        
        onSuccess?.();
      } else {
        throw new Error(result.error || 'Transaction failed');
      }
    } catch (error: any) {
      console.error(' Failed to register institution:', error);
      toast.error('Failed to register institution', {
        description: error.message || 'Please try again',
      });
    } finally {
      setIsSubmitting(false);
      setTxStatus('');
    }
  };

  // Step 1: Institution Information
  const renderStep1 = () => (
    <div className="space-y-6">
      <div>
        <label className="block text-sm font-semibold mb-2">
          Institution Name *
        </label>
        <Input
          {...register('name')}
          placeholder="e.g., University of Technology"
          className={errors.name ? 'border-red-500' : ''}
        />
        {errors.name && (
          <p className="text-sm text-red-600 mt-1">{errors.name.message}</p>
        )}
      </div>

      <div>
        <label className="block text-sm font-semibold mb-2">
          Institution Type *
        </label>
        <select
          {...register('type')}
          className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
        >
          {INSTITUTION_TYPES.map((type) => (
            <option key={type} value={type}>{type}</option>
          ))}
        </select>
      </div>

      <div>
        <label className="block text-sm font-semibold mb-2">
          Description (Optional)
        </label>
        <textarea
          {...register('description')}
          placeholder="Brief description of your institution..."
          className="flex min-h-[100px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
          maxLength={500}
        />
        {errors.description && (
          <p className="text-sm text-red-600 mt-1">{errors.description.message}</p>
        )}
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-semibold mb-2">
            Country *
          </label>
          <Input
            {...register('country')}
            placeholder="e.g., United States"
            className={errors.country ? 'border-red-500' : ''}
          />
          {errors.country && (
            <p className="text-sm text-red-600 mt-1">{errors.country.message}</p>
          )}
        </div>

        <div>
          <label className="block text-sm font-semibold mb-2">
            <Globe className="inline h-4 w-4 mr-1" />
            Website *
          </label>
          <Input
            {...register('website')}
            type="url"
            placeholder="https://example.edu"
            className={errors.website ? 'border-red-500' : ''}
          />
          {errors.website && (
            <p className="text-sm text-red-600 mt-1">{errors.website.message}</p>
          )}
        </div>
      </div>
    </div>
  );

  // Step 2: Verification Documents
  const renderStep2 = () => (
    <div className="space-y-6">
      <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div className="flex items-start space-x-3">
          <FileText className="h-5 w-5 text-blue-600 dark:text-blue-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm">
            <p className="font-semibold text-blue-800 dark:text-blue-400">Required Documents</p>
            <p className="text-blue-700 dark:text-blue-300 mt-1">
              Please upload official documents to verify your institution's legitimacy:
            </p>
            <ul className="list-disc list-inside mt-2 space-y-1 text-blue-700 dark:text-blue-300">
              <li>Accreditation certificate</li>
              <li>Business registration document</li>
              <li>Official letterhead or stamp</li>
            </ul>
          </div>
        </div>
      </div>

      {/* File Upload */}
      <div>
        <label className="block text-sm font-semibold mb-2">
          Upload Verification Documents (PDF only)
        </label>
        <div className="border-2 border-dashed border-border rounded-lg p-8 text-center hover:border-primary transition-colors">
          <input
            type="file"
            multiple
            accept=".pdf"
            onChange={handleFileUpload}
            className="hidden"
            id="file-upload"
          />
          <label htmlFor="file-upload" className="cursor-pointer">
            <Upload className="h-12 w-12 mx-auto text-muted-foreground mb-4" />
            <p className="text-sm font-medium mb-1">
              Click to upload or drag and drop
            </p>
            <p className="text-xs text-muted-foreground">
              PDF files only, up to 10MB each
            </p>
          </label>
        </div>
      </div>

      {/* Uploaded Documents */}
      {uploadedDocs.length > 0 && (
        <div className="space-y-3">
          <label className="block text-sm font-semibold">
            Uploaded Documents ({uploadedDocs.length})
          </label>
          {uploadedDocs.map((file, index) => (
            <div
              key={index}
              className="flex items-center justify-between p-3 bg-accent rounded-lg"
            >
              <div className="flex items-center space-x-3 flex-1 min-w-0">
                <FileText className="h-5 w-5 text-primary flex-shrink-0" />
                <div className="flex-1 min-w-0">
                  <p className="text-sm font-medium truncate">{file.name}</p>
                  <p className="text-xs text-muted-foreground font-mono truncate">
                    Hash: {docHashes[index]}
                  </p>
                </div>
              </div>
              <Button
                variant="ghost"
                size="sm"
                onClick={() => removeDocument(index)}
                className="flex-shrink-0"
              >
                Remove
              </Button>
            </div>
          ))}
        </div>
      )}

      {uploadedDocs.length === 0 && (
        <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
          <div className="flex items-start space-x-3">
            <AlertCircle className="h-5 w-5 text-yellow-600 dark:text-yellow-500 flex-shrink-0 mt-0.5" />
            <p className="text-sm text-yellow-700 dark:text-yellow-300">
              At least one verification document is recommended for faster approval
            </p>
          </div>
        </div>
      )}
    </div>
  );

  // Step 3: Contact Information
  const renderStep3 = () => (
    <div className="space-y-6">
      <div>
        <label className="block text-sm font-semibold mb-2">
          Primary Contact Name *
        </label>
        <Input
          {...register('contactName')}
          placeholder="Full name of primary contact"
          className={errors.contactName ? 'border-red-500' : ''}
        />
        {errors.contactName && (
          <p className="text-sm text-red-600 mt-1">{errors.contactName.message}</p>
        )}
      </div>

      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-semibold mb-2">
            <Mail className="inline h-4 w-4 mr-1" />
            Email Address *
          </label>
          <Input
            {...register('contactEmail')}
            type="email"
            placeholder="contact@institution.edu"
            className={errors.contactEmail ? 'border-red-500' : ''}
          />
          {errors.contactEmail && (
            <p className="text-sm text-red-600 mt-1">{errors.contactEmail.message}</p>
          )}
        </div>

        <div>
          <label className="block text-sm font-semibold mb-2">
            <Phone className="inline h-4 w-4 mr-1" />
            Phone Number *
          </label>
          <Input
            {...register('contactPhone')}
            type="tel"
            placeholder="+1 (555) 123-4567"
            className={errors.contactPhone ? 'border-red-500' : ''}
          />
          {errors.contactPhone && (
            <p className="text-sm text-red-600 mt-1">{errors.contactPhone.message}</p>
          )}
        </div>
      </div>

      <div>
        <label className="block text-sm font-semibold mb-2">
          <MapPin className="inline h-4 w-4 mr-1" />
          Official Address *
        </label>
        <textarea
          {...register('address')}
          placeholder="Complete institutional address including street, city, state/province, postal code"
          className="flex min-h-[100px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
        />
        {errors.address && (
          <p className="text-sm text-red-600 mt-1">{errors.address.message}</p>
        )}
      </div>
    </div>
  );

  // Step 4: Review & Submit
  const renderStep4 = () => {
    const formData = watch();
    
    return (
      <div className="space-y-6">
        <div className="bg-accent rounded-lg p-6 space-y-4">
          <h3 className="font-semibold text-lg mb-4">Review Your Information</h3>
          
          {/* Institution Info */}
          <div className="space-y-2">
            <p className="text-sm font-semibold text-muted-foreground">Institution Details</p>
            <div className="bg-background rounded p-3 space-y-1">
              <p className="font-medium">{formData.name}</p>
              <p className="text-sm text-muted-foreground">{formData.type}</p>
              {formData.description && (
                <p className="text-sm mt-2">{formData.description}</p>
              )}
              <div className="flex items-center space-x-4 mt-2 text-sm">
                <span className="flex items-center">
                  <MapPin className="h-3 w-3 mr-1" />
                  {formData.country}
                </span>
                <span className="flex items-center">
                  <Globe className="h-3 w-3 mr-1" />
                  {formData.website}
                </span>
              </div>
            </div>
          </div>

          {/* Documents */}
          <div className="space-y-2">
            <p className="text-sm font-semibold text-muted-foreground">Verification Documents</p>
            <div className="bg-background rounded p-3">
              <p className="text-sm">{uploadedDocs.length} document(s) uploaded</p>
              {docHashes.length > 0 && (
                <p className="text-xs text-muted-foreground mt-1">
                  Document hashes will be stored on-chain
                </p>
              )}
            </div>
          </div>

          {/* Contact */}
          <div className="space-y-2">
            <p className="text-sm font-semibold text-muted-foreground">Contact Information</p>
            <div className="bg-background rounded p-3 space-y-1 text-sm">
              <p className="font-medium">{formData.contactName}</p>
              <p className="flex items-center text-muted-foreground">
                <Mail className="h-3 w-3 mr-2" />
                {formData.contactEmail}
              </p>
              <p className="flex items-center text-muted-foreground">
                <Phone className="h-3 w-3 mr-2" />
                {formData.contactPhone}
              </p>
              <p className="flex items-center text-muted-foreground mt-2">
                <MapPin className="h-3 w-3 mr-2" />
                {formData.address}
              </p>
            </div>
          </div>
        </div>

        {/* Terms */}
        <label className="flex items-start space-x-3 cursor-pointer">
          <input
            type="checkbox"
            {...register('termsAccepted')}
            className="mt-1"
          />
          <span className="text-sm">
            I certify that all information provided is accurate and that I have the authority 
            to represent this institution. I agree to the{' '}
            <a href="#" className="text-primary hover:underline">Terms of Service</a>
            {' '}and{' '}
            <a href="#" className="text-primary hover:underline">Privacy Policy</a>.
          </span>
        </label>
        {errors.termsAccepted && (
          <p className="text-sm text-red-600">{errors.termsAccepted.message}</p>
        )}

        {/* Transaction Status */}
        {isSubmitting && txStatus && (
          <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <div className="flex items-center space-x-3">
              <Loader2 className="h-5 w-5 text-blue-600 animate-spin flex-shrink-0" />
              <div className="text-sm">
                <p className="font-semibold text-blue-800 dark:text-blue-400">
                  {txStatus}
                </p>
                <p className="text-blue-700 dark:text-blue-300 mt-1">
                  Please wait while we submit your registration to the blockchain...
                </p>
              </div>
            </div>
          </div>
        )}

        <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
          <div className="flex items-start space-x-3">
            <CheckCircle2 className="h-5 w-5 text-green-600 dark:text-green-500 flex-shrink-0 mt-0.5" />
            <div className="text-sm">
              <p className="font-semibold text-green-800 dark:text-green-400">Next Steps</p>
              <p className="text-green-700 dark:text-green-300 mt-1">
                After submission, your application will be reviewed. This typically takes 3-5 business days. 
                You'll receive an email notification when your institution is verified.
              </p>
            </div>
          </div>
        </div>
      </div>
    );
  };

  return (
    <Card className="max-w-3xl mx-auto">
      <CardHeader>
        <CardTitle className="flex items-center space-x-2">
          <Building2 className="h-6 w-6" />
          <span>Register as Institution</span>
        </CardTitle>
        <CardDescription>
          Complete the registration process to start issuing credentials
        </CardDescription>
        
        {/* Progress Indicator */}
        <div className="flex items-center space-x-2 mt-4">
          {[1, 2, 3, 4].map((s) => (
            <div key={s} className="flex items-center flex-1">
              <div
                className={`h-2 flex-1 rounded-full transition-colors ${
                  s <= step ? 'bg-primary' : 'bg-muted'
                }`}
              />
              {s < 4 && <div className="w-2" />}
            </div>
          ))}
        </div>
        <div className="flex justify-between text-xs text-muted-foreground mt-2">
          <span>Info</span>
          <span>Documents</span>
          <span>Contact</span>
          <span>Review</span>
        </div>
      </CardHeader>

      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          {/* Step Content */}
          {step === 1 && renderStep1()}
          {step === 2 && renderStep2()}
          {step === 3 && renderStep3()}
          {step === 4 && renderStep4()}

          {/* Navigation Buttons */}
          <div className="flex justify-between pt-6 border-t">
            <div>
              {step > 1 && (
                <Button
                  type="button"
                  variant="outline"
                  onClick={prevStep}
                  disabled={isSubmitting}
                >
                  <ArrowLeft className="h-4 w-4 mr-2" />
                  Previous
                </Button>
              )}
              {onCancel && step === 1 && (
                <Button
                  type="button"
                  variant="outline"
                  onClick={onCancel}
                  disabled={isSubmitting}
                >
                  Cancel
                </Button>
              )}
            </div>

            <div>
              {step < 4 ? (
                <Button
                  type="button"
                  onClick={nextStep}
                  disabled={isSubmitting}
                >
                  Next
                  <ArrowRight className="h-4 w-4 ml-2" />
                </Button>
              ) : (
                <Button
                  type="submit"
                  disabled={isSubmitting || !isReady}
                >
                  {isSubmitting ? (
                    <>
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                      Submitting...
                    </>
                  ) : (
                    <>
                      <CheckCircle2 className="h-4 w-4 mr-2" />
                      Submit Registration
                    </>
                  )}
                </Button>
              )}
            </div>
          </div>
        </form>
      </CardContent>
    </Card>
  );
}
</file>

<file path="src/components/error/ErrorBoundary.tsx">
// src/components/error/ErrorBoundary.tsx
import { Component, ErrorInfo, ReactNode } from 'react';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/Card';
import { Button } from '@/components/ui/Button';
import { AlertTriangle, RefreshCw, Home } from 'lucide-react';

interface Props {
  children?: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
  errorInfo?: ErrorInfo;
}

export class ErrorBoundary extends Component<Props, State> {
  public state: State = {
    hasError: false
  };

  public static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  public componentDidCatch(error: Error, errorInfo: ErrorInfo) {
    console.error('Uncaught error:', error, errorInfo);
    this.setState({ error, errorInfo });
  }

  private handleReset = () => {
    this.setState({ hasError: false, error: undefined, errorInfo: undefined });
    window.location.href = '/';
  };

  private handleReload = () => {
    window.location.reload();
  };

  public render() {
    if (this.state.hasError) {
      return (
        <div className="min-h-screen flex items-center justify-center bg-background p-4">
          <Card className="max-w-2xl w-full">
            <CardHeader>
              <div className="flex items-center space-x-2 text-destructive mb-2">
                <AlertTriangle className="h-6 w-6" />
                <CardTitle>Application Error</CardTitle>
              </div>
              <CardDescription>
                Something went wrong. Please try refreshing the page or returning home.
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              {this.state.error && (
                <div className="bg-destructive/10 border border-destructive/20 rounded-lg p-4">
                  <p className="font-semibold text-sm mb-2">Error Message:</p>
                  <pre className="text-xs overflow-x-auto bg-background p-2 rounded">
                    {this.state.error.message}
                  </pre>
                </div>
              )}
              
              {this.state.errorInfo && (
                <details className="text-sm">
                  <summary className="cursor-pointer font-semibold mb-2 text-muted-foreground hover:text-foreground">
                    Stack Trace (click to expand)
                  </summary>
                  <pre className="text-xs overflow-x-auto bg-muted p-4 rounded mt-2">
                    {this.state.errorInfo.componentStack}
                  </pre>
                </details>
              )}
              
              <div className="flex flex-col sm:flex-row gap-3">
                <Button onClick={this.handleReset} className="flex-1">
                  <Home className="h-4 w-4 mr-2" />
                  Go to Home
                </Button>
                <Button 
                  variant="outline" 
                  onClick={this.handleReload}
                  className="flex-1"
                >
                  <RefreshCw className="h-4 w-4 mr-2" />
                  Reload Page
                </Button>
              </div>

              <div className="text-xs text-muted-foreground text-center pt-4 border-t">
                If this problem persists, please contact support or check the browser console for more details.
              </div>
            </CardContent>
          </Card>
        </div>
      );
    }

    return this.props.children;
  }
}

export default ErrorBoundary;
</file>

<file path="src/components/layout/Footer.tsx">
import { Link } from 'react-router-dom';
import { Github, Twitter, Book } from 'lucide-react';

export default function Footer() {
  return (
    <footer className="border-t border-border bg-background">
      <div className="container mx-auto px-4 py-6">
        <div className="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 className="font-semibold text-sm mb-3">About</h3>
            <p className="text-sm text-muted-foreground">
              Decentralized academic credential verification built on Polkadot.
            </p>
          </div>

          <div>
            <h3 className="font-semibold text-sm mb-3">Quick Links</h3>
            <ul className="space-y-2 text-sm">
              <li>
                <Link to="/dashboard" className="text-muted-foreground hover:text-foreground transition-colors">
                  Dashboard
                </Link>
              </li>
              <li>
                <Link to="/verify" className="text-muted-foreground hover:text-foreground transition-colors">
                  Verify Credential
                </Link>
              </li>
              <li>
                <Link to="/institutions" className="text-muted-foreground hover:text-foreground transition-colors">
                  Institutions
                </Link>
              </li>
            </ul>
          </div>

          <div>
            <h3 className="font-semibold text-sm mb-3">Resources</h3>
            <ul className="space-y-2 text-sm">
              <li>
                <a 
                  href="https://docs.example.com" 
                  target="_blank" 
                  rel="noopener noreferrer"
                  className="text-muted-foreground hover:text-foreground transition-colors inline-flex items-center"
                >
                  <Book className="h-4 w-4 mr-1" />
                  Documentation
                </a>
              </li>
              <li>
                <a href="#" className="text-muted-foreground hover:text-foreground transition-colors">
                  Privacy Policy
                </a>
              </li>
              <li>
                <a href="#" className="text-muted-foreground hover:text-foreground transition-colors">
                  Terms of Service
                </a>
              </li>
            </ul>
          </div>

          <div>
            <h3 className="font-semibold text-sm mb-3">Community</h3>
            <div className="flex space-x-4">
              <a 
                href="https://github.com/Princeby/academic-verification" 
                target="_blank" 
                rel="noopener noreferrer"
                className="text-muted-foreground hover:text-foreground transition-colors"
              >
                <Github className="h-5 w-5" />
              </a>
              <a 
                href="https://twitter.com" 
                target="_blank" 
                rel="noopener noreferrer"
                className="text-muted-foreground hover:text-foreground transition-colors"
              >
                <Twitter className="h-5 w-5" />
              </a>
            </div>
          </div>
        </div>

        <div className="mt-8 pt-6 border-t border-border flex flex-col sm:flex-row justify-between items-center text-sm text-muted-foreground">
          <p> 2025 Academic Verify. All rights reserved.</p>
          <div className="flex items-center space-x-4 mt-4 sm:mt-0">
            <span>v1.0.0</span>
            <span></span>
            <span className="flex items-center">
              <span className="h-2 w-2 rounded-full bg-green-500 mr-2"></span>
              All systems operational
            </span>
          </div>
        </div>
      </div>
    </footer>
  );
}
</file>

<file path="src/components/layout/Header.tsx">
// src/components/layout/Header.tsx (Updated)
import { Link } from 'react-router-dom';
import { Menu, X } from 'lucide-react';
import { useState } from 'react';
import WalletConnect from '../blockchain/WalletConnect';
import ChainStatus from '../blockchain/ChainStatus';
import NotificationBell from './NotificationBell';
import { Button } from '../ui/Button';

export default function Header() {
  const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

  return (
    <header className="sticky top-0 z-50 w-full border-b border-border bg-background/95 backdrop-blur supports-[backdrop-filter]:bg-background/60">
      <div className="container mx-auto px-4">
        <div className="flex h-16 items-center justify-between">
          {/* Logo */}
          <Link to="/" className="flex items-center space-x-2">
            <div className="h-8 w-8 rounded-lg bg-primary flex items-center justify-center">
              <span className="text-primary-foreground font-bold text-lg">AV</span>
            </div>
            <span className="font-bold text-lg hidden sm:inline-block">
              Academic Verify
            </span>
          </Link>

          {/* Desktop Navigation */}
          <nav className="hidden md:flex items-center space-x-6">
            <Link 
              to="/dashboard" 
              className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors"
            >
              Dashboard
            </Link>
            <Link 
              to="/credentials" 
              className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors"
            >
              Credentials
            </Link>
            <Link 
              to="/my-requests" 
              className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors"
            >
              My Requests
            </Link>
            <Link 
              to="/institutions" 
              className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors"
            >
              Institutions
            </Link>
            <Link 
              to="/verify" 
              className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors"
            >
              Verify
            </Link>
          </nav>

          {/* Right side actions */}
          <div className="flex items-center space-x-3">
            {/* Chain Status */}
            <div className="hidden sm:block">
              <ChainStatus />
            </div>

            {/* Notification Bell */}
            <NotificationBell />

            {/* Wallet Connect */}
            <WalletConnect />

            {/* Mobile menu button */}
            <Button
              variant="ghost"
              size="icon"
              className="md:hidden"
              onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
            >
              {mobileMenuOpen ? (
                <X className="h-5 w-5" />
              ) : (
                <Menu className="h-5 w-5" />
              )}
            </Button>
          </div>
        </div>

        {/* Mobile Navigation */}
        {mobileMenuOpen && (
          <div className="md:hidden py-4 border-t border-border">
            <nav className="flex flex-col space-y-3">
              <Link 
                to="/dashboard" 
                className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors py-2"
                onClick={() => setMobileMenuOpen(false)}
              >
                Dashboard
              </Link>
              <Link 
                to="/credentials" 
                className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors py-2"
                onClick={() => setMobileMenuOpen(false)}
              >
                Credentials
              </Link>
              <Link 
                to="/my-requests" 
                className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors py-2"
                onClick={() => setMobileMenuOpen(false)}
              >
                My Requests
              </Link>
              <Link 
                to="/institutions" 
                className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors py-2"
                onClick={() => setMobileMenuOpen(false)}
              >
                Institutions
              </Link>
              <Link 
                to="/verify" 
                className="text-sm font-medium text-muted-foreground hover:text-foreground transition-colors py-2"
                onClick={() => setMobileMenuOpen(false)}
              >
                Verify
              </Link>
              <div className="pt-2">
                <ChainStatus />
              </div>
            </nav>
          </div>
        )}
      </div>
    </header>
  );
}
</file>

<file path="src/components/layout/index.ts">
export { default as MainLayout } from './MainLayout';
export { default as Header } from './Header';
export { default as Sidebar } from './Sidebar';
export { default as Footer } from './Footer';
</file>

<file path="src/components/layout/MainLayout.tsx">
import { ReactNode } from 'react';
import Header from './Header';
import Footer from './Footer';
import Sidebar from './Sidebar';

interface MainLayoutProps {
  children: ReactNode;
}

export default function MainLayout({ children }: MainLayoutProps) {
  return (
    <div className="min-h-screen flex flex-col bg-background">
      <Header />
      
      <div className="flex flex-1">
        <aside className="hidden lg:block w-64 border-r border-border">
          <Sidebar />
        </aside>
        
        <main className="flex-1 overflow-x-hidden">
          <div className="container mx-auto px-4 py-6 md:px-6 lg:px-8">
            {children}
          </div>
        </main>
      </div>
      
      <Footer />
    </div>
  );
}
</file>

<file path="src/components/layout/NotificationBell.tsx">
// src/components/layout/NotificationBell.tsx
import { useState } from 'react';
import { Bell, Check, X, ExternalLink } from 'lucide-react';
import { Button } from '@/components/ui/Button';
import { Badge } from '@/components/ui/Badge';
import { useNotificationsStore } from '@/store/notifications.store';
import { useNavigate } from 'react-router-dom';
import { cn } from '@/lib/utils/cn';

const notificationIcons = {
  request_received: '',
  request_approved: '',
  request_rejected: '',
  credential_issued: '',
  credential_revoked: '',
  endorsement_received: '',
  system: '',
};

export default function NotificationBell() {
  const [isOpen, setIsOpen] = useState(false);
  const navigate = useNavigate();
  const { 
    notifications, 
    unreadCount, 
    markAsRead, 
    markAllAsRead, 
    removeNotification 
  } = useNotificationsStore();

  const formatTime = (timestamp: number) => {
    const now = Date.now();
    const diff = now - timestamp;
    
    const minutes = Math.floor(diff / 60000);
    const hours = Math.floor(diff / 3600000);
    const days = Math.floor(diff / 86400000);
    
    if (minutes < 1) return 'Just now';
    if (minutes < 60) return `${minutes}m ago`;
    if (hours < 24) return `${hours}h ago`;
    return `${days}d ago`;
  };

  const handleNotificationClick = (notification: any) => {
    markAsRead(notification.id);
    if (notification.actionUrl) {
      navigate(notification.actionUrl);
      setIsOpen(false);
    }
  };

  return (
    <div className="relative">
      {/* Bell Button */}
      <button
        onClick={() => setIsOpen(!isOpen)}
        className="relative p-2 rounded-lg hover:bg-accent transition-colors"
      >
        <Bell className="h-5 w-5" />
        {unreadCount > 0 && (
          <span className="absolute top-1 right-1 h-4 w-4 bg-red-500 text-white text-xs font-bold rounded-full flex items-center justify-center">
            {unreadCount > 9 ? '9+' : unreadCount}
          </span>
        )}
      </button>

      {/* Dropdown Panel */}
      {isOpen && (
        <>
          {/* Backdrop */}
          <div 
            className="fixed inset-0 z-40" 
            onClick={() => setIsOpen(false)}
          />
          
          {/* Notification Panel */}
          <div className="absolute right-0 mt-2 w-96 max-h-[32rem] overflow-hidden bg-card border border-border rounded-lg shadow-lg z-50">
            {/* Header */}
            <div className="p-4 border-b border-border flex items-center justify-between bg-accent/50">
              <div>
                <h3 className="font-semibold">Notifications</h3>
                {unreadCount > 0 && (
                  <p className="text-xs text-muted-foreground">
                    {unreadCount} unread
                  </p>
                )}
              </div>
              {unreadCount > 0 && (
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={markAllAsRead}
                  className="text-xs"
                >
                  <Check className="h-3 w-3 mr-1" />
                  Mark all read
                </Button>
              )}
            </div>

            {/* Notifications List */}
            <div className="max-h-96 overflow-y-auto">
              {notifications.length === 0 ? (
                <div className="p-8 text-center text-muted-foreground">
                  <Bell className="h-12 w-12 mx-auto mb-3 opacity-50" />
                  <p className="text-sm">No notifications yet</p>
                  <p className="text-xs mt-1">You'll be notified of important updates here</p>
                </div>
              ) : (
                <div className="divide-y divide-border">
                  {notifications.map((notification) => (
                    <div
                      key={notification.id}
                      className={cn(
                        "p-4 transition-colors cursor-pointer hover:bg-accent/50",
                        !notification.read && "bg-primary/5"
                      )}
                      onClick={() => handleNotificationClick(notification)}
                    >
                      <div className="flex items-start gap-3">
                        {/* Icon */}
                        <div className="text-2xl flex-shrink-0">
                          {notificationIcons[notification.type]}
                        </div>

                        {/* Content */}
                        <div className="flex-1 min-w-0">
                          <div className="flex items-start justify-between gap-2 mb-1">
                            <p className="font-medium text-sm truncate">
                              {notification.title}
                            </p>
                            {!notification.read && (
                              <div className="h-2 w-2 rounded-full bg-primary flex-shrink-0 mt-1" />
                            )}
                          </div>
                          <p className="text-sm text-muted-foreground line-clamp-2">
                            {notification.message}
                          </p>
                          <div className="flex items-center justify-between mt-2">
                            <p className="text-xs text-muted-foreground">
                              {formatTime(notification.createdAt)}
                            </p>
                            {notification.actionUrl && (
                              <ExternalLink className="h-3 w-3 text-muted-foreground" />
                            )}
                          </div>
                        </div>

                        {/* Remove Button */}
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            removeNotification(notification.id);
                          }}
                          className="p-1 hover:bg-accent rounded transition-colors flex-shrink-0"
                        >
                          <X className="h-3 w-3" />
                        </button>
                      </div>
                    </div>
                  ))}
                </div>
              )}
            </div>

            {/* Footer */}
            {notifications.length > 0 && (
              <div className="p-3 border-t border-border bg-accent/50">
                <Button
                  variant="ghost"
                  size="sm"
                  onClick={() => {
                    useNotificationsStore.getState().clearAll();
                    setIsOpen(false);
                  }}
                  className="w-full text-xs"
                >
                  Clear All Notifications
                </Button>
              </div>
            )}
          </div>
        </>
      )}
    </div>
  );
}
</file>

<file path="src/components/layout/Sidebar.tsx">
// import { useState } from 'react';
// import { Link, useLocation } from 'react-router-dom';
// import { 
//   LayoutDashboard, 
//   Award, 
//   Building2, 
//   CheckCircle, 
//   Users,
//   FileText,
//   Settings,
//   Plus
// } from 'lucide-react';
// import { cn } from '@/lib/utils/cn';
// import { Button } from '../ui/Button';
// import DIDStatus from '../did/DIDStatus';
// import CreateDIDModal from '../did/CreateDIDModal';
// import { useDIDStore } from '@/store/did.store';

// const navigationItems = [
//   {
//     title: 'Dashboard',
//     href: '/dashboard',
//     icon: LayoutDashboard,
//   },
//   {
//     title: 'My Credentials',
//     href: '/credentials',
//     icon: Award,
//   },
//   {
//     title: 'Institutions',
//     href: '/institutions',
//     icon: Building2,
//   },
//   {
//     title: 'Verify',
//     href: '/verify',
//     icon: CheckCircle,
//   },
// ];

// const institutionItems = [
//   {
//     title: 'Institution Profile',
//     href: '/institution',
//     icon: Building2,
//   },
//   {
//     title: 'Issued Credentials',
//     href: '/institution/issued',
//     icon: FileText,
//   },
//   {
//     title: 'Endorsements',
//     href: '/institution/endorsements',
//     icon: Users,
//   },
// ];

// export default function Sidebar() {
//   const location = useLocation();
//   const [showCreateDIDModal, setShowCreateDIDModal] = useState(false);
//   const { hasDID, isInstitution } = useDIDStore();

//   return (
//     <>
//       <div className="flex flex-col h-full py-6 px-3">
//         {/* User Profile Section */}
//         <div className="mb-6 px-3">
//           <DIDStatus />
//         </div>

//         {/* Quick Actions */}
//         {!hasDID && (
//           <div className="mb-6 px-3 space-y-2">
//             <Button 
//               className="w-full justify-start" 
//               size="sm"
//               onClick={() => setShowCreateDIDModal(true)}
//             >
//               <Plus className="h-4 w-4 mr-2" />
//               Create DID
//             </Button>
//           </div>
//         )}

//         {/* Main Navigation */}
//         <nav className="flex-1 space-y-1">
//           <div className="px-3 text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2">
//             Main Menu
//           </div>
//           {navigationItems.map((item) => {
//             const Icon = item.icon;
//             const isActive = location.pathname === item.href;
            
//             return (
//               <Link
//                 key={item.href}
//                 to={item.href}
//                 className={cn(
//                   "flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-colors",
//                   isActive
//                     ? "bg-primary text-primary-foreground"
//                     : "text-muted-foreground hover:bg-accent hover:text-accent-foreground"
//                 )}
//               >
//                 <Icon className="h-5 w-5 mr-3" />
//                 {item.title}
//               </Link>
//             );
//           })}

//           {/* Institution Section (conditional) */}
//           {isInstitution && (
//             <>
//               <div className="px-3 text-xs font-semibold text-muted-foreground uppercase tracking-wider mt-6 mb-2">
//                 Institution
//               </div>
//               {institutionItems.map((item) => {
//                 const Icon = item.icon;
//                 const isActive = location.pathname === item.href;
                
//                 return (
//                   <Link
//                     key={item.href}
//                     to={item.href}
//                     className={cn(
//                       "flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-colors",
//                       isActive
//                         ? "bg-primary text-primary-foreground"
//                         : "text-muted-foreground hover:bg-accent hover:text-accent-foreground"
//                     )}
//                   >
//                     <Icon className="h-5 w-5 mr-3" />
//                     {item.title}
//                   </Link>
//                 );
//               })}
//             </>
//           )}
//         </nav>

//         {/* Settings */}
//         <div className="mt-auto pt-4 border-t border-border">
//           <Link
//             to="/settings"
//             className="flex items-center px-3 py-2 text-sm font-medium rounded-lg text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors"
//           >
//             <Settings className="h-5 w-5 mr-3" />
//             Settings
//           </Link>
//         </div>
//       </div>

//       {/* Create DID Modal */}
//       <CreateDIDModal 
//         isOpen={showCreateDIDModal}
//         onClose={() => setShowCreateDIDModal(false)}
//       />
//     </>
//   );
// }
import { useState } from 'react';
import { Link, useLocation } from 'react-router-dom';
import { 
  LayoutDashboard, 
  Award, 
  Building2, 
  CheckCircle, 
  Users,
  FileText,
  Settings,
  Plus,
  Shield
} from 'lucide-react';
import { cn } from '@/lib/utils/cn';
import { Button } from '../ui/Button';
import DIDStatus from '../did/DIDStatus';
import CreateDIDModal from '../did/CreateDIDModal';
import { useDIDStore } from '@/store/did.store';

const navigationItems = [
  {
    title: 'Dashboard',
    href: '/dashboard',
    icon: LayoutDashboard,
  },
  {
    title: 'My Credentials',
    href: '/credentials',
    icon: Award,
  },
  {
    title: 'My Requests',
    href: '/my-requests',
    icon: FileText,
  },
  {
    title: 'Institutions',
    href: '/institutions',
    icon: Building2,
  },
  {
    title: 'Verify',
    href: '/verify',
    icon: CheckCircle,
  },
];

const institutionItems = [
  {
    title: 'Institution Profile',
    href: '/institution',
    icon: Building2,
  },
  {
    title: 'Issue Credential',
    href: '/institution/issue',
    icon: Plus,
  },
  {
    title: 'Issued Credentials',
    href: '/institution/issued',
    icon: FileText,
  },
  {
    title: 'Requests',
    href: '/institution/requests',
    icon: Users,
  },
];

const adminItems = [
  {
    title: 'Verify Institutions',
    href: '/admin/verify-institutions',
    icon: Shield,
  },
];

export default function Sidebar() {
  const location = useLocation();
  const [showCreateDIDModal, setShowCreateDIDModal] = useState(false);
  const { hasDID, isInstitution } = useDIDStore();

  // Check if user should see admin section
  // For now, show admin to all verified institutions
  // You can add more specific logic here (e.g., check for admin role)
  const showAdminSection = isInstitution;

  return (
    <>
      <div className="flex flex-col h-full py-6 px-3">
        {/* User Profile Section */}
        <div className="mb-6 px-3">
          <DIDStatus />
        </div>

        {/* Quick Actions */}
        {!hasDID && (
          <div className="mb-6 px-3 space-y-2">
            <Button 
              className="w-full justify-start" 
              size="sm"
              onClick={() => setShowCreateDIDModal(true)}
            >
              <Plus className="h-4 w-4 mr-2" />
              Create DID
            </Button>
          </div>
        )}

        {/* Main Navigation */}
        <nav className="flex-1 space-y-1">
          <div className="px-3 text-xs font-semibold text-muted-foreground uppercase tracking-wider mb-2">
            Main Menu
          </div>
          {navigationItems.map((item) => {
            const Icon = item.icon;
            const isActive = location.pathname === item.href;
            
            return (
              <Link
                key={item.href}
                to={item.href}
                className={cn(
                  "flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-colors",
                  isActive
                    ? "bg-primary text-primary-foreground"
                    : "text-muted-foreground hover:bg-accent hover:text-accent-foreground"
                )}
              >
                <Icon className="h-5 w-5 mr-3" />
                {item.title}
              </Link>
            );
          })}

          {/* Institution Section (conditional) */}
          {isInstitution && (
            <>
              <div className="px-3 text-xs font-semibold text-muted-foreground uppercase tracking-wider mt-6 mb-2">
                Institution
              </div>
              {institutionItems.map((item) => {
                const Icon = item.icon;
                const isActive = location.pathname === item.href;
                
                return (
                  <Link
                    key={item.href}
                    to={item.href}
                    className={cn(
                      "flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-colors",
                      isActive
                        ? "bg-primary text-primary-foreground"
                        : "text-muted-foreground hover:bg-accent hover:text-accent-foreground"
                    )}
                  >
                    <Icon className="h-5 w-5 mr-3" />
                    {item.title}
                  </Link>
                );
              })}
            </>
          )}

          {/* Admin Section (conditional) */}
          {showAdminSection && (
            <>
              <div className="px-3 text-xs font-semibold text-muted-foreground uppercase tracking-wider mt-6 mb-2">
                <Shield className="inline h-3 w-3 mr-1" />
                Admin
              </div>
              {adminItems.map((item) => {
                const Icon = item.icon;
                const isActive = location.pathname === item.href;
                
                return (
                  <Link
                    key={item.href}
                    to={item.href}
                    className={cn(
                      "flex items-center px-3 py-2 text-sm font-medium rounded-lg transition-colors",
                      isActive
                        ? "bg-primary text-primary-foreground"
                        : "text-muted-foreground hover:bg-accent hover:text-accent-foreground"
                    )}
                  >
                    <Icon className="h-5 w-5 mr-3" />
                    {item.title}
                  </Link>
                );
              })}
            </>
          )}
        </nav>

        {/* Settings */}
        <div className="mt-auto pt-4 border-t border-border">
          <Link
            to="/settings"
            className="flex items-center px-3 py-2 text-sm font-medium rounded-lg text-muted-foreground hover:bg-accent hover:text-accent-foreground transition-colors"
          >
            <Settings className="h-5 w-5 mr-3" />
            Settings
          </Link>
        </div>
      </div>

      {/* Create DID Modal */}
      <CreateDIDModal 
        isOpen={showCreateDIDModal}
        onClose={() => setShowCreateDIDModal(false)}
      />
    </>
  );
}
</file>

<file path="src/components/requests/CreateRequestForm.tsx">
// src/components/requests/CreateRequestForm.tsx
import { useState } from 'react';
import { useForm } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { z } from 'zod';
import {
  Search,
  Building2,
  ArrowLeft,
  ArrowRight,
  FileText,
  Upload,
  Loader2,
  CheckCircle2,
  Calendar
} from 'lucide-react';
import { Button } from '../ui/Button';
import { Input } from '../ui/Input';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '../ui/Card';
import { Badge } from '../ui/Badge';
import { toast } from 'sonner';
import { CREDENTIAL_TYPES } from '@/lib/utils/constants';
import { useDIDStore } from '@/store/did.store';
import type { CreateRequestFormData } from '@/types/credentialRequest.types';

// Form validation schema
const requestSchema = z.object({
  institution: z.string().min(10, 'Please select a valid institution'),
  credentialType: z.enum(CREDENTIAL_TYPES),
  programName: z.string().min(3, 'Program name is required'),
  fieldOfStudy: z.string().min(2, 'Field of study is required'),
  startDate: z.string().min(1, 'Start date is required'),
  endDate: z.string().min(1, 'End date is required'),
  expectedGraduationDate: z.string().optional(),
  studentId: z.string().optional(),
  major: z.string().optional(),
  minor: z.string().optional(),
  expectedGPA: z.string().optional(),
  additionalNotes: z.string().max(500).optional(),
});

interface CreateRequestFormProps {
  onSuccess?: () => void;
  onCancel?: () => void;
}

export default function CreateRequestForm({ onSuccess, onCancel }: CreateRequestFormProps) {
  const [step, setStep] = useState<1 | 2 | 3 | 4>(1);
  const [searchQuery, setSearchQuery] = useState('');
  const [selectedInstitution, setSelectedInstitution] = useState<any>(null);
  const [uploadedDocs, setUploadedDocs] = useState<File[]>([]);
  const [isSubmitting, setIsSubmitting] = useState(false);
  const { didAddress } = useDIDStore();

  const {
    register,
    handleSubmit,
    watch,
    setValue,
    formState: { errors },
    trigger
  } = useForm<CreateRequestFormData>({
    resolver: zodResolver(requestSchema),
    defaultValues: {
      credentialType: "Bachelor's Degree",
    },
  });

  const selectedType = watch('credentialType');

  // Mock institution search
  const searchInstitutions = async () => {
    // TODO: Replace with blockchain query
    return [
      {
        did: '5GrwvaEF5zXb26Fz9rcQpDWS57CtERHpNehXCPcNoHGKutQY',
        name: 'Massachusetts Institute of Technology',
        type: 'University',
        verified: true,
      },
      {
        did: '5FHneW46xGXgs5mUiveU4sbTyGBzmstUspZC92UhjJM694ty',
        name: 'Stanford University',
        type: 'University',
        verified: true,
      },
    ];
  };

  const [institutions, setInstitutions] = useState<any[]>([]);
  const [searching, setSearching] = useState(false);

  const handleSearch = async () => {
    setSearching(true);
    const results = await searchInstitutions();
    setInstitutions(results);
    setSearching(false);
  };

  const selectInstitution = (institution: any) => {
    setSelectedInstitution(institution);
    setValue('institution', institution.did);
  };

  const handleFileUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const files = Array.from(e.target.files || []);
    setUploadedDocs(prev => [...prev, ...files]);
  };

  const nextStep = async () => {
    let fieldsToValidate: (keyof CreateRequestFormData)[] = [];

    if (step === 1) {
      if (!selectedInstitution) {
        toast.error('Please select an institution');
        return;
      }
    } else if (step === 2) {
      fieldsToValidate = ['credentialType', 'programName', 'fieldOfStudy'];
    } else if (step === 3) {
      fieldsToValidate = ['startDate', 'endDate'];
    }

    if (fieldsToValidate.length > 0) {
      const isValid = await trigger(fieldsToValidate);
      if (!isValid) return;
    }

    setStep((prev) => Math.min(prev + 1, 4) as 1 | 2 | 3 | 4);
  };

  const prevStep = () => {
    setStep((prev) => Math.max(prev - 1, 1) as 1 | 2 | 3 | 4);
  };

  const onSubmit = async (data: CreateRequestFormData) => {
    if (step !== 4) return;

    setIsSubmitting(true);

    try {
      // TODO: Submit to blockchain
      console.log('Submitting request:', data);
      await new Promise(resolve => setTimeout(resolve, 2000));

      toast.success('Request submitted successfully!');
      onSuccess?.();
    } catch (error) {
      console.error('Failed to submit request:', error);
      toast.error('Failed to submit request');
    } finally {
      setIsSubmitting(false);
    }
  };

  // Step 1: Select Institution
  const renderStep1 = () => (
    <div className="space-y-6">
      <div>
        <label className="block text-sm font-semibold mb-2">
          Search for Institution
        </label>
        <div className="flex space-x-2">
          <Input
            value={searchQuery}
            onChange={(e) => setSearchQuery(e.target.value)}
            placeholder="Search by name..."
            className="flex-1"
          />
          <Button onClick={handleSearch} disabled={searching}>
            {searching ? <Loader2 className="h-4 w-4 animate-spin" /> : <Search className="h-4 w-4" />}
          </Button>
        </div>
      </div>

      {institutions.length > 0 && (
        <div className="space-y-3">
          <p className="text-sm font-semibold">Select Institution</p>
          {institutions.map((inst) => (
            <button
              key={inst.did}
              onClick={() => selectInstitution(inst)}
              className={`w-full text-left p-4 border-2 rounded-lg transition-colors ${
                selectedInstitution?.did === inst.did
                  ? 'border-primary bg-primary/5'
                  : 'border-border hover:border-primary/50'
              }`}
            >
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-3">
                  <Building2 className="h-8 w-8 text-primary" />
                  <div>
                    <p className="font-semibold">{inst.name}</p>
                    <p className="text-sm text-muted-foreground">{inst.type}</p>
                  </div>
                </div>
                {inst.verified && <Badge variant="success">Verified</Badge>}
              </div>
            </button>
          ))}
        </div>
      )}

      {selectedInstitution && (
        <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
          <p className="text-sm font-semibold text-green-800 dark:text-green-400">
            Selected: {selectedInstitution.name}
          </p>
        </div>
      )}
    </div>
  );

  // Step 2: Credential Details
  const renderStep2 = () => (
    <div className="space-y-6">
      <div>
        <label className="block text-sm font-semibold mb-2">Credential Type *</label>
        <select
          {...register('credentialType')}
          className="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
        >
          {CREDENTIAL_TYPES.map((type) => (
            <option key={type} value={type}>{type}</option>
          ))}
        </select>
      </div>

      <div>
        <label className="block text-sm font-semibold mb-2">Program Name *</label>
        <Input
          {...register('programName')}
          placeholder="e.g., Bachelor of Science in Computer Science"
          className={errors.programName ? 'border-red-500' : ''}
        />
        {errors.programName && (
          <p className="text-sm text-red-600 mt-1">{errors.programName.message}</p>
        )}
      </div>

      <div>
        <label className="block text-sm font-semibold mb-2">Field of Study *</label>
        <Input
          {...register('fieldOfStudy')}
          placeholder="e.g., Computer Science"
          className={errors.fieldOfStudy ? 'border-red-500' : ''}
        />
        {errors.fieldOfStudy && (
          <p className="text-sm text-red-600 mt-1">{errors.fieldOfStudy.message}</p>
        )}
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-semibold mb-2">Major (Optional)</label>
          <Input {...register('major')} placeholder="e.g., Software Engineering" />
        </div>
        <div>
          <label className="block text-sm font-semibold mb-2">Minor (Optional)</label>
          <Input {...register('minor')} placeholder="e.g., Mathematics" />
        </div>
      </div>
    </div>
  );

  // Step 3: Academic Info
  const renderStep3 = () => (
    <div className="space-y-6">
      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-semibold mb-2">Start Date *</label>
          <Input
            {...register('startDate')}
            type="date"
            className={errors.startDate ? 'border-red-500' : ''}
          />
          {errors.startDate && (
            <p className="text-sm text-red-600 mt-1">{errors.startDate.message}</p>
          )}
        </div>
        <div>
          <label className="block text-sm font-semibold mb-2">End Date *</label>
          <Input
            {...register('endDate')}
            type="date"
            className={errors.endDate ? 'border-red-500' : ''}
          />
          {errors.endDate && (
            <p className="text-sm text-red-600 mt-1">{errors.endDate.message}</p>
          )}
        </div>
      </div>

      <div>
        <label className="block text-sm font-semibold mb-2">Student ID (Optional)</label>
        <Input {...register('studentId')} placeholder="Your student ID" />
      </div>

      <div className="grid grid-cols-2 gap-4">
        <div>
          <label className="block text-sm font-semibold mb-2">Expected GPA (Optional)</label>
          <Input {...register('expectedGPA')} placeholder="e.g., 3.85" />
        </div>
        <div>
          <label className="block text-sm font-semibold mb-2">Expected Graduation (Optional)</label>
          <Input {...register('expectedGraduationDate')} type="date" />
        </div>
      </div>
    </div>
  );

  // Step 4: Review
  const renderStep4 = () => {
    const formData = watch();
    return (
      <div className="space-y-4">
        <div className="bg-accent rounded-lg p-4">
          <h3 className="font-semibold mb-3">Review Your Request</h3>
          <div className="space-y-2 text-sm">
            <div className="flex justify-between">
              <span className="text-muted-foreground">Institution:</span>
              <span className="font-medium">{selectedInstitution?.name}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">Program:</span>
              <span className="font-medium">{formData.programName}</span>
            </div>
            <div className="flex justify-between">
              <span className="text-muted-foreground">Type:</span>
              <Badge>{formData.credentialType}</Badge>
            </div>
          </div>
        </div>

        <div>
          <label className="block text-sm font-semibold mb-2">Additional Notes (Optional)</label>
          <textarea
            {...register('additionalNotes')}
            placeholder="Any additional information..."
            className="flex min-h-[100px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
            maxLength={500}
          />
        </div>
      </div>
    );
  };

  return (
    <Card className="max-w-3xl mx-auto">
      <CardHeader>
        <CardTitle>Request Credential</CardTitle>
        <CardDescription>Submit a credential request to an institution</CardDescription>

        {/* Progress */}
        <div className="flex items-center space-x-2 mt-4">
          {[1, 2, 3, 4].map((s) => (
            <div key={s} className="flex items-center flex-1">
              <div
                className={`h-2 flex-1 rounded-full transition-colors ${
                  s <= step ? 'bg-primary' : 'bg-muted'
                }`}
              />
              {s < 4 && <div className="w-2" />}
            </div>
          ))}
        </div>
      </CardHeader>

      <CardContent>
        <form onSubmit={handleSubmit(onSubmit)} className="space-y-6">
          {step === 1 && renderStep1()}
          {step === 2 && renderStep2()}
          {step === 3 && renderStep3()}
          {step === 4 && renderStep4()}

          {/* Navigation */}
          <div className="flex justify-between pt-6 border-t">
            <div>
              {step > 1 && (
                <Button type="button" variant="outline" onClick={prevStep}>
                  <ArrowLeft className="h-4 w-4 mr-2" />
                  Previous
                </Button>
              )}
              {onCancel && step === 1 && (
                <Button type="button" variant="outline" onClick={onCancel}>
                  Cancel
                </Button>
              )}
            </div>

            <div>
              {step < 4 ? (
                <Button type="button" onClick={nextStep}>
                  Next
                  <ArrowRight className="h-4 w-4 ml-2" />
                </Button>
              ) : (
                <Button type="submit" disabled={isSubmitting}>
                  {isSubmitting ? (
                    <>
                      <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                      Submitting...
                    </>
                  ) : (
                    <>
                      <CheckCircle2 className="h-4 w-4 mr-2" />
                      Submit Request
                    </>
                  )}
                </Button>
              )}
            </div>
          </div>
        </form>
      </CardContent>
    </Card>
  );
}
</file>

<file path="src/components/requests/RequestsList.tsx">
// src/components/requests/RequestsList.tsx
import { useState } from 'react';
import { 
  Clock, 
  CheckCircle, 
  XCircle, 
  Award,
  Ban,
  Eye,
  MoreVertical,
  Calendar,
  Building2,
  User,
  FileText,
  Search,
  Filter
} from 'lucide-react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/Card';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { Badge } from '@/components/ui/Badge';
import type { CredentialRequest, RequestStatus } from '@/types/credentialRequest.types';
import { REQUEST_STATUS_CONFIG } from '@/types/credentialRequest.types';

interface RequestsListProps {
  requests: CredentialRequest[];
  loading?: boolean;
  emptyMessage?: string;
  viewMode: 'student' | 'institution';
  onViewDetails: (request: CredentialRequest) => void;
  onReview?: (request: CredentialRequest) => void;
}

export default function RequestsList({ 
  requests, 
  loading = false,
  emptyMessage = "No requests yet",
  viewMode,
  onViewDetails,
  onReview
}: RequestsListProps) {
  const [searchQuery, setSearchQuery] = useState('');
  const [statusFilter, setStatusFilter] = useState<RequestStatus | 'all'>('all');

  // Filter requests
  const filteredRequests = requests.filter(req => {
    const matchesSearch = !searchQuery || 
      req.programName.toLowerCase().includes(searchQuery.toLowerCase()) ||
      req.institutionName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      req.requesterName?.toLowerCase().includes(searchQuery.toLowerCase());
    
    const matchesStatus = statusFilter === 'all' || req.status === statusFilter;
    
    return matchesSearch && matchesStatus;
  });

  // Get counts
  const counts = {
    total: requests.length,
    pending: requests.filter(r => r.status === 'pending').length,
    approved: requests.filter(r => r.status === 'approved').length,
    rejected: requests.filter(r => r.status === 'rejected').length,
    fulfilled: requests.filter(r => r.status === 'fulfilled').length,
  };

  const formatDate = (timestamp: number) => {
    return new Date(timestamp).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'short',
      day: 'numeric'
    });
  };

  const getStatusIcon = (status: RequestStatus) => {
    const config = REQUEST_STATUS_CONFIG[status];
    const icons = {
      Clock,
      CheckCircle,
      XCircle,
      Award,
      Ban
    };
    return icons[config.icon as keyof typeof icons];
  };

  if (loading) {
    return (
      <Card>
        <CardContent className="py-12 text-center">
          <div className="animate-spin h-8 w-8 border-4 border-primary border-t-transparent rounded-full mx-auto mb-3" />
          <p className="text-muted-foreground">Loading requests...</p>
        </CardContent>
      </Card>
    );
  }

  return (
    <div className="space-y-4">
      {/* Stats Bar */}
      <div className="grid grid-cols-2 sm:grid-cols-5 gap-4">
        <Card>
          <CardContent className="pt-6">
            <div className="text-2xl font-bold">{counts.total}</div>
            <p className="text-sm text-muted-foreground">Total</p>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="text-2xl font-bold text-yellow-600">{counts.pending}</div>
            <p className="text-sm text-muted-foreground">Pending</p>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="text-2xl font-bold text-green-600">{counts.approved}</div>
            <p className="text-sm text-muted-foreground">Approved</p>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="text-2xl font-bold text-red-600">{counts.rejected}</div>
            <p className="text-sm text-muted-foreground">Rejected</p>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="text-2xl font-bold text-blue-600">{counts.fulfilled}</div>
            <p className="text-sm text-muted-foreground">Fulfilled</p>
          </CardContent>
        </Card>
      </div>

      {/* Filters */}
      <Card>
        <CardContent className="pt-6">
          <div className="flex flex-col sm:flex-row gap-4">
            <div className="flex-1">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder={`Search ${viewMode === 'student' ? 'by program or institution' : 'by student or program'}...`}
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="pl-10"
                />
              </div>
            </div>
            
            <div className="flex gap-2 flex-wrap">
              <Button
                variant={statusFilter === 'all' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setStatusFilter('all')}
              >
                All
              </Button>
              <Button
                variant={statusFilter === 'pending' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setStatusFilter('pending')}
              >
                Pending
              </Button>
              <Button
                variant={statusFilter === 'approved' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setStatusFilter('approved')}
              >
                Approved
              </Button>
              <Button
                variant={statusFilter === 'rejected' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setStatusFilter('rejected')}
              >
                Rejected
              </Button>
              <Button
                variant={statusFilter === 'fulfilled' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setStatusFilter('fulfilled')}
              >
                Fulfilled
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Requests List */}
      {filteredRequests.length === 0 ? (
        <Card>
          <CardContent className="py-12 text-center">
            <FileText className="h-12 w-12 mx-auto mb-3 text-muted-foreground opacity-50" />
            <p className="text-lg font-medium mb-1">
              {searchQuery || statusFilter !== 'all'
                ? 'No requests match your filters'
                : emptyMessage
              }
            </p>
            <p className="text-sm text-muted-foreground">
              {searchQuery || statusFilter !== 'all'
                ? 'Try adjusting your search or filters'
                : viewMode === 'student' 
                  ? 'Submit a request to get started'
                  : 'Requests from students will appear here'
              }
            </p>
          </CardContent>
        </Card>
      ) : (
        <div className="space-y-3">
          {filteredRequests.map((request) => {
            const StatusIcon = getStatusIcon(request.status);
            const statusConfig = REQUEST_STATUS_CONFIG[request.status];
            
            return (
              <Card key={request.id} className="hover:shadow-md transition-shadow">
                <CardContent className="pt-6">
                  <div className="flex items-start justify-between gap-4">
                    <div className="flex-1 min-w-0">
                      {/* Header */}
                      <div className="flex items-start gap-3 mb-3">
                        <div className="h-12 w-12 rounded-lg bg-primary/10 flex items-center justify-center flex-shrink-0">
                          <FileText className="h-6 w-6 text-primary" />
                        </div>
                        
                        <div className="flex-1 min-w-0">
                          <div className="flex items-center gap-2 mb-1">
                            <h3 className="font-semibold text-lg truncate">
                              {request.programName}
                            </h3>
                            <Badge 
                              variant={
                                request.status === 'approved' || request.status === 'fulfilled' 
                                  ? 'success' 
                                  : request.status === 'rejected' 
                                  ? 'error'
                                  : request.status === 'pending'
                                  ? 'warning'
                                  : 'outline'
                              }
                            >
                              <StatusIcon className="h-3 w-3 mr-1" />
                              {statusConfig.label}
                            </Badge>
                            <Badge variant="outline">{request.credentialType}</Badge>
                          </div>
                          
                          <p className="text-sm text-muted-foreground">
                            {request.fieldOfStudy}
                          </p>
                        </div>
                      </div>

                      {/* Details Grid */}
                      <div className="grid grid-cols-1 sm:grid-cols-2 gap-3 text-sm">
                        <div className="flex items-center text-muted-foreground">
                          {viewMode === 'student' ? (
                            <>
                              <Building2 className="h-3 w-3 mr-2 flex-shrink-0" />
                              <span className="truncate">{request.institutionName}</span>
                            </>
                          ) : (
                            <>
                              <User className="h-3 w-3 mr-2 flex-shrink-0" />
                              <span className="truncate">
                                {request.requesterName || `${request.requester.slice(0, 8)}...`}
                              </span>
                            </>
                          )}
                        </div>

                        <div className="flex items-center text-muted-foreground">
                          <Calendar className="h-3 w-3 mr-2 flex-shrink-0" />
                          <span>Submitted {formatDate(request.createdAt)}</span>
                        </div>

                        {request.studentId && (
                          <div className="flex items-center text-muted-foreground">
                            <span className="font-medium mr-2">ID:</span>
                            <span>{request.studentId}</span>
                          </div>
                        )}

                        {request.supportingDocuments && request.supportingDocuments.length > 0 && (
                          <div className="flex items-center text-muted-foreground">
                            <FileText className="h-3 w-3 mr-2 flex-shrink-0" />
                            <span>{request.supportingDocuments.length} document(s)</span>
                          </div>
                        )}
                      </div>

                      {/* Rejection Reason */}
                      {request.status === 'rejected' && request.rejectionReason && (
                        <div className="mt-3 bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded p-2">
                          <p className="text-xs font-semibold text-red-800 dark:text-red-400">
                            Rejection Reason:
                          </p>
                          <p className="text-xs text-red-700 dark:text-red-300 mt-1">
                            {request.rejectionReason}
                          </p>
                        </div>
                      )}
                    </div>

                    {/* Actions */}
                    <div className="flex flex-col gap-2">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => onViewDetails(request)}
                      >
                        <Eye className="h-3 w-3 mr-1" />
                        View
                      </Button>
                      
                      {viewMode === 'institution' && request.status === 'pending' && onReview && (
                        <Button
                          size="sm"
                          onClick={() => onReview(request)}
                        >
                          Review
                        </Button>
                      )}
                    </div>
                  </div>
                </CardContent>
              </Card>
            );
          })}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/components/requests/ReviewRequestModal.tsx">
// src/components/requests/ReviewRequestModal.tsx
import { useState } from 'react';
import { 
  CheckCircle, 
  XCircle, 
  FileText,
  Building2,
  User,
  Calendar,
  AlertCircle,
  Loader2
} from 'lucide-react';
import { Modal } from '@/components/ui/Modal';
import { Button } from '@/components/ui/Button';
import { Badge } from '@/components/ui/Badge';
import { toast } from 'sonner';
import type { CredentialRequest } from '@/types/credentialRequest.types';
import { useCredentialRequestsStore } from '@/store/credentialRequests.store';

interface ReviewRequestModalProps {
  isOpen: boolean;
  onClose: () => void;
  request: CredentialRequest | null;
}

export default function ReviewRequestModal({ 
  isOpen, 
  onClose, 
  request 
}: ReviewRequestModalProps) {
  const [action, setAction] = useState<'approve' | 'reject' | null>(null);
  const [rejectionReason, setRejectionReason] = useState('');
  const [processing, setProcessing] = useState(false);
  const { updateRequest } = useCredentialRequestsStore();

  if (!request) return null;

  const formatDate = (timestamp: number) => {
    return new Date(timestamp).toLocaleDateString('en-US', {
      year: 'numeric',
      month: 'long',
      day: 'numeric'
    });
  };

  const handleSubmitReview = async () => {
    if (!action) return;
    
    if (action === 'reject' && !rejectionReason.trim()) {
      toast.error('Please provide a reason for rejection');
      return;
    }

    setProcessing(true);

    try {
      // TODO: Submit to blockchain
      await new Promise(resolve => setTimeout(resolve, 2000));

      // Update local state
      updateRequest(request.id, {
        status: action === 'approve' ? 'approved' : 'rejected',
        reviewedAt: Date.now(),
        rejectionReason: action === 'reject' ? rejectionReason : undefined,
      });

      toast.success(
        action === 'approve' 
          ? 'Request approved successfully!' 
          : 'Request rejected',
        {
          description: action === 'approve' 
            ? 'You can now issue the credential'
            : 'The student has been notified'
        }
      );

      onClose();
    } catch (error) {
      console.error('Failed to review request:', error);
      toast.error('Failed to process review');
    } finally {
      setProcessing(false);
    }
  };

  return (
    <Modal isOpen={isOpen} onClose={onClose} className="max-w-3xl">
      <div className="p-6">
        {/* Header */}
        <div className="mb-6">
          <h2 className="text-2xl font-bold mb-2">Review Credential Request</h2>
          <p className="text-muted-foreground">
            Review the student's information and decide whether to approve or reject
          </p>
        </div>

        {/* Request Details */}
        <div className="space-y-6 mb-6">
          {/* Program Info */}
          <div className="bg-accent rounded-lg p-4">
            <div className="flex items-center gap-2 mb-3">
              <Badge variant="outline">{request.credentialType}</Badge>
              <h3 className="font-semibold text-lg">{request.programName}</h3>
            </div>
            <p className="text-muted-foreground">{request.fieldOfStudy}</p>
          </div>

          {/* Student Information */}
          <div>
            <label className="text-sm font-semibold text-muted-foreground mb-2 block">
              <User className="inline h-3 w-3 mr-1" />
              Student Information
            </label>
            <div className="bg-background border border-border rounded-lg p-4 space-y-2">
              <div className="flex justify-between text-sm">
                <span className="text-muted-foreground">Name:</span>
                <span className="font-medium">{request.requesterName || 'Not provided'}</span>
              </div>
              <div className="flex justify-between text-sm">
                <span className="text-muted-foreground">DID:</span>
                <code className="text-xs font-mono">
                  {request.requester}
                </code>
              </div>
              {request.studentId && (
                <div className="flex justify-between text-sm">
                  <span className="text-muted-foreground">Student ID:</span>
                  <span className="font-medium">{request.studentId}</span>
                </div>
              )}
            </div>
          </div>

          {/* Academic Details */}
          <div>
            <label className="text-sm font-semibold text-muted-foreground mb-2 block">
              Academic Information
            </label>
            <div className="grid grid-cols-2 gap-4">
              <div className="bg-background border border-border rounded-lg p-3">
                <p className="text-xs text-muted-foreground mb-1">Start Date</p>
                <p className="font-medium">{formatDate(new Date(request.startDate).getTime())}</p>
              </div>
              <div className="bg-background border border-border rounded-lg p-3">
                <p className="text-xs text-muted-foreground mb-1">End Date</p>
                <p className="font-medium">{formatDate(new Date(request.endDate).getTime())}</p>
              </div>
              {request.major && (
                <div className="bg-background border border-border rounded-lg p-3">
                  <p className="text-xs text-muted-foreground mb-1">Major</p>
                  <p className="font-medium">{request.major}</p>
                </div>
              )}
              {request.minor && (
                <div className="bg-background border border-border rounded-lg p-3">
                  <p className="text-xs text-muted-foreground mb-1">Minor</p>
                  <p className="font-medium">{request.minor}</p>
                </div>
              )}
              {request.expectedGPA && (
                <div className="bg-background border border-border rounded-lg p-3">
                  <p className="text-xs text-muted-foreground mb-1">Expected GPA</p>
                  <p className="font-medium">{request.expectedGPA}</p>
                </div>
              )}
              {request.expectedGraduationDate && (
                <div className="bg-background border border-border rounded-lg p-3">
                  <p className="text-xs text-muted-foreground mb-1">Expected Graduation</p>
                  <p className="font-medium">
                    {formatDate(new Date(request.expectedGraduationDate).getTime())}
                  </p>
                </div>
              )}
            </div>
          </div>

          {/* Supporting Documents */}
          {request.supportingDocuments && request.supportingDocuments.length > 0 && (
            <div>
              <label className="text-sm font-semibold text-muted-foreground mb-2 block">
                <FileText className="inline h-3 w-3 mr-1" />
                Supporting Documents
              </label>
              <div className="space-y-2">
                {request.supportingDocuments.map((hash, index) => (
                  <div key={hash} className="bg-background border border-border rounded-lg p-3">
                    <div className="flex items-center justify-between">
                      <div>
                        <p className="text-sm font-medium">Document {index + 1}</p>
                        <code className="text-xs text-muted-foreground">{hash}</code>
                      </div>
                      <Button variant="outline" size="sm">
                        View
                      </Button>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          )}

          {/* Additional Notes */}
          {request.additionalNotes && (
            <div>
              <label className="text-sm font-semibold text-muted-foreground mb-2 block">
                Additional Notes from Student
              </label>
              <div className="bg-background border border-border rounded-lg p-4">
                <p className="text-sm">{request.additionalNotes}</p>
              </div>
            </div>
          )}
        </div>

        {/* Decision Section */}
        {!action ? (
          <div className="space-y-4">
            <p className="text-sm font-semibold">Make Your Decision</p>
            <div className="grid grid-cols-2 gap-4">
              <button
                onClick={() => setAction('approve')}
                className="p-6 border-2 border-green-500 bg-green-50 dark:bg-green-900/20 rounded-lg hover:bg-green-100 dark:hover:bg-green-900/30 transition-colors"
              >
                <CheckCircle className="h-8 w-8 text-green-600 mx-auto mb-2" />
                <p className="font-semibold text-green-800 dark:text-green-400">Approve</p>
                <p className="text-xs text-green-700 dark:text-green-300 mt-1">
                  Accept this request and prepare to issue credential
                </p>
              </button>

              <button
                onClick={() => setAction('reject')}
                className="p-6 border-2 border-red-500 bg-red-50 dark:bg-red-900/20 rounded-lg hover:bg-red-100 dark:hover:bg-red-900/30 transition-colors"
              >
                <XCircle className="h-8 w-8 text-red-600 mx-auto mb-2" />
                <p className="font-semibold text-red-800 dark:text-red-400">Reject</p>
                <p className="text-xs text-red-700 dark:text-red-300 mt-1">
                  Decline this request with a reason
                </p>
              </button>
            </div>
          </div>
        ) : (
          <div className="space-y-4">
            {action === 'approve' ? (
              <div className="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
                <div className="flex items-start gap-3">
                  <CheckCircle className="h-5 w-5 text-green-600 dark:text-green-500 flex-shrink-0 mt-0.5" />
                  <div>
                    <p className="font-semibold text-green-800 dark:text-green-400">
                      Approve Request
                    </p>
                    <p className="text-sm text-green-700 dark:text-green-300 mt-1">
                      The student will be notified and you can proceed to issue their credential.
                    </p>
                  </div>
                </div>
              </div>
            ) : (
              <div className="space-y-3">
                <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
                  <div className="flex items-start gap-3">
                    <AlertCircle className="h-5 w-5 text-red-600 dark:text-red-500 flex-shrink-0 mt-0.5" />
                    <div>
                      <p className="font-semibold text-red-800 dark:text-red-400">
                        Reject Request
                      </p>
                      <p className="text-sm text-red-700 dark:text-red-300 mt-1">
                        Please provide a clear reason for rejection to help the student understand.
                      </p>
                    </div>
                  </div>
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-2">
                    Rejection Reason *
                  </label>
                  <textarea
                    value={rejectionReason}
                    onChange={(e) => setRejectionReason(e.target.value)}
                    placeholder="Explain why this request cannot be approved..."
                    className="flex min-h-[100px] w-full rounded-md border border-input bg-background px-3 py-2 text-sm"
                    maxLength={500}
                  />
                  <p className="text-xs text-muted-foreground mt-1">
                    {rejectionReason.length}/500 characters
                  </p>
                </div>
              </div>
            )}

            <div className="flex gap-3">
              <Button
                variant="outline"
                onClick={() => {
                  setAction(null);
                  setRejectionReason('');
                }}
                className="flex-1"
              >
                Change Decision
              </Button>
              <Button
                onClick={handleSubmitReview}
                disabled={processing || (action === 'reject' && !rejectionReason.trim())}
                className="flex-1"
              >
                {processing ? (
                  <>
                    <Loader2 className="h-4 w-4 mr-2 animate-spin" />
                    Processing...
                  </>
                ) : (
                  <>
                    Confirm {action === 'approve' ? 'Approval' : 'Rejection'}
                  </>
                )}
              </Button>
            </div>
          </div>
        )}
      </div>
    </Modal>
  );
}
</file>

<file path="src/components/ui/Badge.tsx">
import * as React from 'react';
import { cn } from '@/lib/utils/cn';

export interface BadgeProps extends React.HTMLAttributes<HTMLDivElement> {
  variant?: 'default' | 'success' | 'warning' | 'error' | 'outline' | 'secondary';
}

export const Badge = React.forwardRef<HTMLDivElement, BadgeProps>(
  ({ className, variant = 'default', ...props }, ref) => {
    return (
      <div
        ref={ref}
        className={cn(
          'inline-flex items-center rounded-md px-2 py-1 text-xs font-semibold',
          variant === 'default' && 'bg-gray-100 text-gray-900',
          variant === 'success' && 'bg-green-100 text-green-900',
          variant === 'warning' && 'bg-yellow-100 text-yellow-900',
          variant === 'error' && 'bg-red-100 text-red-900',
          variant === 'outline' && 'border border-gray-400 text-gray-800',
          variant === 'secondary' && 'bg-gray-200 text-gray-700',
          className
        )}
        {...props}
      />
    );
  }
);

Badge.displayName = 'Badge';
</file>

<file path="src/components/ui/Button.tsx">
import { ButtonHTMLAttributes, forwardRef } from 'react';
import { cva, type VariantProps } from 'class-variance-authority';
import { cn } from '@/lib/utils/cn';


const buttonVariants = cva(
  "inline-flex items-center justify-center rounded-md text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring disabled:pointer-events-none disabled:opacity-50",
  {
    variants: {
      variant: {
        default: "bg-primary text-primary-foreground hover:bg-primary/90",
        destructive: "bg-destructive text-destructive-foreground hover:bg-destructive/90",
        outline: "border border-input bg-background hover:bg-accent hover:text-accent-foreground",
        secondary: "bg-secondary text-secondary-foreground hover:bg-secondary/80",
        ghost: "hover:bg-accent hover:text-accent-foreground",
        link: "text-primary underline-offset-4 hover:underline",
      },
      size: {
        default: "h-10 px-4 py-2",
        sm: "h-9 rounded-md px-3",
        lg: "h-11 rounded-md px-8",
        icon: "h-10 w-10",
      },
    },
    defaultVariants: {
      variant: "default",
      size: "default",
    },
  }
);

export interface ButtonProps
  extends ButtonHTMLAttributes<HTMLButtonElement>,
    VariantProps<typeof buttonVariants> {}

const Button = forwardRef<HTMLButtonElement, ButtonProps>(
  ({ className, variant, size, ...props }, ref) => {
    return (
      <button
        className={cn(buttonVariants({ variant, size, className }))}
        ref={ref}
        {...props}
      />
    );
  }
);
Button.displayName = "Button";

export { Button, buttonVariants };
</file>

<file path="src/components/ui/Card.tsx">
// Card.tsx
import { HTMLAttributes, forwardRef } from 'react';
import { cn } from '@/lib/utils/cn';

const Card = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div
      ref={ref}
      className={cn(
        "rounded-lg border border-border bg-card text-card-foreground shadow-sm",
        className
      )}
      {...props}
    />
  )
);
Card.displayName = "Card";

const CardHeader = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div
      ref={ref}
      className={cn("flex flex-col space-y-1.5 p-6", className)}
      {...props}
    />
  )
);
CardHeader.displayName = "CardHeader";

const CardTitle = forwardRef<HTMLParagraphElement, HTMLAttributes<HTMLHeadingElement>>(
  ({ className, ...props }, ref) => (
    <h3
      ref={ref}
      className={cn("text-2xl font-semibold leading-none tracking-tight", className)}
      {...props}
    />
  )
);
CardTitle.displayName = "CardTitle";

const CardDescription = forwardRef<HTMLParagraphElement, HTMLAttributes<HTMLParagraphElement>>(
  ({ className, ...props }, ref) => (
    <p
      ref={ref}
      className={cn("text-sm text-muted-foreground", className)}
      {...props}
    />
  )
);
CardDescription.displayName = "CardDescription";

const CardContent = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div ref={ref} className={cn("p-6 pt-0", className)} {...props} />
  )
);
CardContent.displayName = "CardContent";

const CardFooter = forwardRef<HTMLDivElement, HTMLAttributes<HTMLDivElement>>(
  ({ className, ...props }, ref) => (
    <div
      ref={ref}
      className={cn("flex items-center p-6 pt-0", className)}
      {...props}
    />
  )
);
CardFooter.displayName = "CardFooter";

export { Card, CardHeader, CardFooter, CardTitle, CardDescription, CardContent };
</file>

<file path="src/components/ui/index.ts">
export * from './Button';
export * from './Card';
export * from './Badge';
export * from './Spinner';
export * from './Input';
export * from './Modal';
</file>

<file path="src/components/ui/Input.tsx">
import { InputHTMLAttributes, forwardRef } from 'react';
import { cn } from '@/lib/utils/cn';

export interface InputProps extends InputHTMLAttributes<HTMLInputElement> {}

const Input = forwardRef<HTMLInputElement, InputProps>(
  ({ className, type, ...props }, ref) => {
    return (
      <input
        type={type}
        className={cn(
          "flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium placeholder:text-muted-foreground focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50",
          className
        )}
        ref={ref}
        {...props}
      />
    );
  }
);
Input.displayName = "Input";

export { Input };
</file>

<file path="src/components/ui/Modal.tsx">
import { ReactNode, useEffect } from 'react';
import { X } from 'lucide-react';
import { cn } from '@/lib/utils/cn';
import { Button } from './Button';

interface ModalProps {
  isOpen: boolean;
  onClose: () => void;
  children: ReactNode;
  title?: string;
  description?: string;
  className?: string;
}

export function Modal({ isOpen, onClose, children, title, description, className }: ModalProps) {
  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === 'Escape') {
        onClose();
      }
    };

    if (isOpen) {
      document.addEventListener('keydown', handleEscape);
      document.body.style.overflow = 'hidden';
    }

    return () => {
      document.removeEventListener('keydown', handleEscape);
      document.body.style.overflow = 'unset';
    };
  }, [isOpen, onClose]);

  if (!isOpen) return null;

  return (
    <div className="fixed inset-0 z-50 flex items-center justify-center">
      {/* Backdrop */}
      <div 
        className="absolute inset-0 bg-background/80 backdrop-blur-sm"
        onClick={onClose}
      />
      
      {/* Modal */}
      <div 
        className={cn(
          "relative bg-card border border-border rounded-lg shadow-lg max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto",
          className
        )}
      >
        {/* Header */}
        {(title || description) && (
          <div className="px-6 py-4 border-b border-border">
            <div className="flex items-start justify-between">
              <div>
                {title && (
                  <h2 className="text-lg font-semibold">{title}</h2>
                )}
                {description && (
                  <p className="text-sm text-muted-foreground mt-1">{description}</p>
                )}
              </div>
              <Button
                variant="ghost"
                size="icon"
                onClick={onClose}
                className="h-6 w-6 rounded-full"
              >
                <X className="h-4 w-4" />
              </Button>
            </div>
          </div>
        )}
        
        {/* Content */}
        <div className="px-6 py-4">
          {children}
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/components/ui/Spinner.tsx">
import { cn } from '@/lib/utils/cn';

interface SpinnerProps {
  className?: string;
  size?: 'sm' | 'md' | 'lg';
}

const sizeClasses = {
  sm: 'h-4 w-4 border-2',
  md: 'h-8 w-8 border-3',
  lg: 'h-12 w-12 border-4',
};

export function Spinner({ className, size = 'md' }: SpinnerProps) {
  return (
    <div
      className={cn(
        'animate-spin rounded-full border-solid border-primary border-t-transparent',
        sizeClasses[size],
        className
      )}
    />
  );
}
</file>

<file path="src/hooks/blockchain/useBalance.ts">
// src/hooks/blockchain/useBalance.ts
import { useState, useEffect } from 'react';
import { usePolkadotContext } from '@/providers/PolkadotProvider';
import { useWalletStore } from '@/store/wallet.store';
import { formatBalance } from '@polkadot/util';

interface BalanceInfo {
  free: string;
  reserved: string;
  frozen: string;
  total: string;
  formatted: string;
}

export function useBalance() {
  const { api, isReady } = usePolkadotContext();
  const { account, setBalance } = useWalletStore();
  const [balance, setBalanceState] = useState<BalanceInfo | null>(null);
  const [loading, setLoading] = useState(false);

  useEffect(() => {
    if (!api || !isReady || !account?.address) {
      setBalanceState(null);
      return;
    }

    let unsubscribe: (() => void) | undefined;

    const fetchBalance = async () => {
      setLoading(true);
      try {
        // Subscribe to balance changes
        unsubscribe = await api.query.system.account(
          account.address,
          ({ data: { free, reserved, frozen } }) => {
            const freeBalance = free.toString();
            const reservedBalance = reserved.toString();
            const frozenBalance = frozen.toString();
            const totalBalance = (BigInt(freeBalance) + BigInt(reservedBalance)).toString();

            // Format for display
            const formatted = formatBalance(totalBalance, {
              decimals: 12,
              withUnit: 'AVC',
              forceUnit: '-',
            });

            const balanceInfo: BalanceInfo = {
              free: freeBalance,
              reserved: reservedBalance,
              frozen: frozenBalance,
              total: totalBalance,
              formatted,
            };

            setBalanceState(balanceInfo);
            setBalance(formatted);
          }
        );
      } catch (error) {
        console.error('Failed to fetch balance:', error);
      } finally {
        setLoading(false);
      }
    };

    fetchBalance();

    return () => {
      if (unsubscribe) {
        unsubscribe();
      }
    };
  }, [api, isReady, account?.address, setBalance]);

  return {
    balance,
    loading,
    refresh: () => {
      // Balance is automatically refreshed via subscription
    },
  };
}
</file>

<file path="src/hooks/blockchain/useBlockchain.ts">
// src/hooks/blockchain/useBlockchain.ts - UPDATED
import { useMemo } from 'react';
import { usePolkadotContext } from '@/providers/PolkadotProvider';
import { useWalletStore } from '@/store/wallet.store';
import { 
  DIDTransactions, 
  CredentialTransactions, 
  ReputationTransactions 
} from '@/lib/blockchain/transactions';
import { RealBlockchainQueries } from '@/lib/blockchain/realQueries';

/**
 * Main hook for blockchain interactions
 * Provides transaction and query helpers with REAL blockchain data
 */
export function useBlockchain() {
  const { api, isReady } = usePolkadotContext();
  const { account } = useWalletStore();

  const transactions = useMemo(() => {
    if (!api || !isReady) return null;

    return {
      did: new DIDTransactions(api),
      credential: new CredentialTransactions(api),
      reputation: new ReputationTransactions(api),
    };
  }, [api, isReady]);

  const queries = useMemo(() => {
    if (!api || !isReady) return null;

    return new RealBlockchainQueries(api);
  }, [api, isReady]);

  return {
    api,
    isReady,
    account,
    transactions,
    queries,
    isConnected: isReady && account !== null,
  };
}
</file>

<file path="src/hooks/blockchain/usePolkadotApi.ts">
import { useState, useEffect } from 'react';
import { usePolkadotContext } from '@/providers/PolkadotProvider';
import { CHAIN_CONFIG } from '@/lib/utils/constants';

export function usePolkadotApi() {
  const { api, isReady, error } = usePolkadotContext();
  const [blockNumber, setBlockNumber] = useState<number>(0);
  const [chainName, setChainName] = useState<string>(CHAIN_CONFIG.CHAIN_NAME);
  const [isConnected, setIsConnected] = useState<boolean>(false);

  useEffect(() => {
    if (!api || !isReady) {
      setIsConnected(false);
      return;
    }

    setIsConnected(true);

    // Get chain name
    api.rpc.system.chain().then((chain) => {
      setChainName(chain.toString());
    });

    // Subscribe to new blocks
    let unsubscribe: (() => void) | undefined;

    api.rpc.chain.subscribeNewHeads((header) => {
      setBlockNumber(header.number.toNumber());
    }).then((unsub) => {
      unsubscribe = unsub;
    });

    return () => {
      if (unsubscribe) {
        unsubscribe();
      }
    };
  }, [api, isReady]);

  return {
    api,
    isReady,
    isConnected,
    blockNumber,
    chainName,
    error,
  };
}
</file>

<file path="src/lib/blockchain/integration.ts">
// src/lib/blockchain/integration.ts
import type { ApiPromise } from '@polkadot/api';
import { hexToU8a, u8aToHex } from '@polkadot/util';
import { blake2AsHex } from '@polkadot/util-crypto';
import { CREDENTIAL_TYPE_DISPLAY_MAP } from '../utils/constants';

/**
 * Generate Blake2 hash from file
 */
export async function generateFileHash(file: File): Promise<string> {
  return new Promise((resolve, reject) => {
    const reader = new FileReader();
    
    reader.onload = (e) => {
      try {
        const arrayBuffer = e.target?.result as ArrayBuffer;
        const uint8Array = new Uint8Array(arrayBuffer);
        const hash = blake2AsHex(uint8Array, 256);
        resolve(hash);
      } catch (error) {
        reject(error);
      }
    };
    
    reader.onerror = () => reject(new Error('Failed to read file'));
    reader.readAsArrayBuffer(file);
  });
}

/**
 * Verify file matches hash
 */
export async function verifyFileHash(file: File, expectedHash: string): Promise<boolean> {
  try {
    const actualHash = await generateFileHash(file);
    return actualHash === expectedHash;
  } catch (error) {
    console.error('Error verifying file hash:', error);
    return false;
  }
}

/**
 * Format blockchain data for UI
 */
export function formatCredentialData(rawCredential: any) {
    return {
      id: rawCredential.credentialId,
      holder: rawCredential.holder,
      issuer: rawCredential.issuer,
      credentialHash: rawCredential.credentialHash,
      credentialType: formatCredentialType(rawCredential.credentialType), // Use helper
      metadata: rawCredential.metadata ? Buffer.from(rawCredential.metadata).toString('utf-8') : undefined,
      issuedAt: rawCredential.issuedAt,
      expiresAt: rawCredential.expiresAt || undefined,
      revoked: rawCredential.status === 'Revoked',
    };
  }

/**
 * Format credential type enum
 */
export function formatCredentialType(type: any): string {
    if (typeof type === 'string') {
      return CREDENTIAL_TYPE_DISPLAY_MAP[type] || type;
    }
    
    if (typeof type === 'object') {
      const key = Object.keys(type)[0];
      return CREDENTIAL_TYPE_DISPLAY_MAP[key] || key;
    }
    
    return 'Unknown';
  }

/**
 * Parse metadata string to object
 */
export function parseMetadata(metadata?: string): Record<string, any> {
  if (!metadata) return {};
  
  try {
    return JSON.parse(metadata);
  } catch {
    // If not JSON, return as simple object with text field
    return { text: metadata };
  }
}

/**
 * Encode metadata for blockchain
 */
export function encodeMetadata(data: Record<string, any>): string {
  return JSON.stringify(data);
}

/**
 * Check if API is connected and has pallet
 */
export async function checkPalletAvailability(api: ApiPromise, palletName: string): Promise<boolean> {
  try {
    // @ts-ignore - Dynamic pallet access
    return api.query[palletName] !== undefined;
  } catch {
    return false;
  }
}

/**
 * Wait for transaction to be included in block
 */
export async function waitForInBlock(
  api: ApiPromise,
  txHash: string,
  timeout = 30000
): Promise<boolean> {
  return new Promise((resolve, reject) => {
    const timeoutId = setTimeout(() => {
      reject(new Error('Transaction timeout'));
    }, timeout);

    const checkTransaction = async () => {
      try {
        const block = await api.rpc.chain.getBlock();
        const extrinsics = block.block.extrinsics;
        
        for (const ext of extrinsics) {
          if (ext.hash.toHex() === txHash) {
            clearTimeout(timeoutId);
            resolve(true);
            return;
          }
        }
        
        setTimeout(checkTransaction, 1000);
      } catch (error) {
        clearTimeout(timeoutId);
        reject(error);
      }
    };

    checkTransaction();
  });
}

/**
 * Get human-readable error from dispatch error
 */
export function getErrorMessage(api: ApiPromise, dispatchError: any): string {
  if (dispatchError.isModule) {
    try {
      const decoded = api.registry.findMetaError(dispatchError.asModule);
      return `${decoded.section}.${decoded.name}: ${decoded.docs.join(' ')}`;
    } catch (error) {
      return 'Unknown module error';
    }
  }
  
  return dispatchError.toString();
}

/**
 * Check if account has sufficient balance for transaction
 */
export async function checkSufficientBalance(
  api: ApiPromise,
  address: string,
  requiredAmount: bigint = BigInt(0)
): Promise<{ sufficient: boolean; balance: string }> {
  try {
    const { data: { free } } = await api.query.system.account(address);
    const freeBalance = BigInt(free.toString());
    
    return {
      sufficient: freeBalance > requiredAmount,
      balance: free.toString(),
    };
  } catch (error) {
    console.error('Error checking balance:', error);
    return { sufficient: false, balance: '0' };
  }
}

/**
 * Estimate transaction fee
 */
export async function estimateTransactionFee(
  api: ApiPromise,
  extrinsic: any,
  address: string
): Promise<string> {
  try {
    const paymentInfo = await extrinsic.paymentInfo(address);
    return paymentInfo.partialFee.toString();
  } catch (error) {
    console.error('Error estimating fee:', error);
    return '0';
  }
}

/**
 * Parse account from string or return as-is
 */
export function parseAccount(account: string | { address: string }): string {
  return typeof account === 'string' ? account : account.address;
}

/**
 * Store file reference (without IPFS for now, just returns hash)
 */
export async function storeFileReference(file: File): Promise<string> {
  // For now, just generate and return the hash
  // In future, integrate with IPFS or other storage
  const hash = await generateFileHash(file);
  
  // Store file metadata in localStorage for demo purposes
  const metadata = {
    name: file.name,
    size: file.size,
    type: file.type,
    hash,
    storedAt: Date.now(),
  };
  
  const stored = JSON.parse(localStorage.getItem('file_references') || '{}');
  stored[hash] = metadata;
  localStorage.setItem('file_references', JSON.stringify(stored));
  
  return hash;
}

/**
 * Get file reference metadata
 */
export function getFileReference(hash: string): any | null {
  try {
    const stored = JSON.parse(localStorage.getItem('file_references') || '{}');
    return stored[hash] || null;
  } catch {
    return null;
  }
}

/**
 * Batch query multiple items
 */
export async function batchQuery<T>(
  api: ApiPromise,
  queries: Array<Promise<T>>
): Promise<T[]> {
  try {
    return await Promise.all(queries);
  } catch (error) {
    console.error('Batch query error:', error);
    return [];
  }
}

/**
 * Subscribe to events for a specific pallet
 */
export function subscribeToEvents(
  api: ApiPromise,
  palletName: string,
  eventName: string,
  callback: (event: any) => void
): () => void {
  const unsubscribe = api.query.system.events((events: any) => {
    events.forEach((record: any) => {
      const { event } = record;
      
      if (event.section === palletName && event.method === eventName) {
        callback(event);
      }
    });
  });
  
  return () => unsubscribe.then(unsub => unsub());
}
</file>

<file path="src/lib/blockchain/queries.ts">
// src/lib/blockchain/queries.ts
import type { ApiPromise } from '@polkadot/api';

/**
 * Query DID information
 */
export class DIDQueries {
  constructor(private api: ApiPromise) {}

  async getDID(address: string) {
    try {
      const didDoc = await this.api.query.did.didDocuments(address);
      if (didDoc.isEmpty) {
        return null;
      }
      return didDoc.toJSON();
    } catch (error) {
      console.error('Error fetching DID:', error);
      return null;
    }
  }

  async getInstitution(address: string) {
    try {
      const institution = await this.api.query.did.institutions(address);
      if (institution.isEmpty) {
        return null;
      }
      return institution.toJSON();
    } catch (error) {
      console.error('Error fetching institution:', error);
      return null;
    }
  }

  async isInstitution(address: string): Promise<boolean> {
    const institution = await this.getInstitution(address);
    return institution !== null;
  }

  async isVerifiedInstitution(address: string): Promise<boolean> {
    const institution = await this.getInstitution(address);
    return institution?.verified === true;
  }
}

/**
 * Query Credential information
 */
export class CredentialQueries {
  constructor(private api: ApiPromise) {}

  async getCredential(credentialId: string) {
    try {
      const credential = await this.api.query.credential.credentials(credentialId);
      if (credential.isEmpty) {
        return null;
      }
      return credential.toJSON();
    } catch (error) {
      console.error('Error fetching credential:', error);
      return null;
    }
  }

  async getCredentialByHash(credentialHash: string) {
    try {
      const credentialId = await this.api.query.credential.credentialByHash(credentialHash);
      if (credentialId.isEmpty) {
        return null;
      }
      
      const id = credentialId.toString();
      return this.getCredential(id);
    } catch (error) {
      console.error('Error fetching credential by hash:', error);
      return null;
    }
  }

  async getCredentialsByHolder(holderAddress: string) {
    try {
      const credentials = await this.api.query.credential.credentialsByHolder(holderAddress);
      if (credentials.isEmpty) {
        return [];
      }
      
      const credentialRefs = credentials.toJSON() as any[];
      
      // Fetch full credentials
      const fullCredentials = await Promise.all(
        credentialRefs.map(ref => this.getCredential(ref.credentialId))
      );
      
      return fullCredentials.filter(c => c !== null);
    } catch (error) {
      console.error('Error fetching credentials by holder:', error);
      return [];
    }
  }

  async getCredentialsByIssuer(issuerAddress: string) {
    try {
      const credentialIds = await this.api.query.credential.credentialsByIssuer(issuerAddress);
      if (credentialIds.isEmpty) {
        return [];
      }
      
      const ids = credentialIds.toJSON() as string[];
      
      // Fetch full credentials
      const fullCredentials = await Promise.all(
        ids.map(id => this.getCredential(id))
      );
      
      return fullCredentials.filter(c => c !== null);
    } catch (error) {
      console.error('Error fetching credentials by issuer:', error);
      return [];
    }
  }
}

/**
 * Query Reputation information
 */
export class ReputationQueries {
  constructor(private api: ApiPromise) {}

  async getReputationScore(address: string) {
    try {
      const score = await this.api.query.reputation.reputationScores(address);
      if (score.isEmpty) {
        return {
          credentialsIssued: 0,
          credentialsVerified: 0,
          endorsementsReceived: 0,
          endorsementsGiven: 0,
          totalScore: 0,
        };
      }
      return score.toJSON();
    } catch (error) {
      console.error('Error fetching reputation score:', error);
      return null;
    }
  }

  async getEndorsementsReceived(address: string) {
    try {
      const endorsements = await this.api.query.reputation.endorsementsReceived(address);
      if (endorsements.isEmpty) {
        return [];
      }
      return endorsements.toJSON();
    } catch (error) {
      console.error('Error fetching endorsements received:', error);
      return [];
    }
  }

  async getEndorsementsGiven(address: string) {
    try {
      const endorsements = await this.api.query.reputation.endorsementsGiven(address);
      if (endorsements.isEmpty) {
        return [];
      }
      return endorsements.toJSON();
    } catch (error) {
      console.error('Error fetching endorsements given:', error);
      return [];
    }
  }
}

/**
 * Combined queries helper
 */
export class BlockchainQueries {
  did: DIDQueries;
  credential: CredentialQueries;
  reputation: ReputationQueries;

  constructor(api: ApiPromise) {
    this.did = new DIDQueries(api);
    this.credential = new CredentialQueries(api);
    this.reputation = new ReputationQueries(api);
  }
}
</file>

<file path="src/lib/blockchain/realQueries.ts">
// src/lib/blockchain/realQueries.ts
import type { ApiPromise } from '@polkadot/api';
import { formatCredentialData, parseMetadata, checkPalletAvailability } from './integration';

/**
 * Enhanced DID Queries with real blockchain data
 */
export class RealDIDQueries {
  constructor(private api: ApiPromise) {}

  async getDID(address: string) {
    try {
      const hasPallet = await checkPalletAvailability(this.api, 'did');
      if (!hasPallet) {
        console.warn('DID pallet not available');
        return null;
      }

      const didDoc = await this.api.query.did.didDocuments(address);
      
      if (didDoc.isEmpty) {
        return null;
      }
      
      const data = didDoc.toJSON() as any;
      
      return {
        controller: data.controller,
        publicKeys: data.publicKeys || [],
        createdAt: data.createdAt,
        updatedAt: data.updatedAt,
        active: data.active,
      };
    } catch (error) {
      console.error('Error fetching DID:', error);
      return null;
    }
  }

  async getInstitution(address: string) {
    try {
      const hasPallet = await checkPalletAvailability(this.api, 'did');
      if (!hasPallet) {
        console.warn('DID pallet not available');
        return null;
      }

      const institution = await this.api.query.did.institutions(address);
      
      if (institution.isEmpty) {
        return null;
      }
      
      const data = institution.toJSON() as any;
      
      return {
        name: data.name,
        did: data.did,
        verified: data.verified,
        registeredAt: data.registeredAt,
      };
    } catch (error) {
      console.error('Error fetching institution:', error);
      return null;
    }
  }

  async isInstitution(address: string): Promise<boolean> {
    const institution = await this.getInstitution(address);
    return institution !== null;
  }

  async isVerifiedInstitution(address: string): Promise<boolean> {
    const institution = await this.getInstitution(address);
    return institution?.verified === true;
  }

  async getAllInstitutions(): Promise<any[]> {
    try {
      const hasPallet = await checkPalletAvailability(this.api, 'did');
      if (!hasPallet) return [];

      const entries = await this.api.query.did.institutions.entries();
      
      return entries
        .map(([key, value]) => {
          if (value.isEmpty) return null;
          
          const address = key.args[0].toString();
          const data = value.toJSON() as any;
          
          return {
            address,
            name: data.name,
            verified: data.verified,
            registeredAt: data.registeredAt,
          };
        })
        .filter(Boolean);
    } catch (error) {
      console.error('Error fetching all institutions:', error);
      return [];
    }
  }
}

/**
 * Enhanced Credential Queries with real blockchain data
 */
export class RealCredentialQueries {
  constructor(private api: ApiPromise) {}

  async getCredential(credentialId: string) {
    try {
      const hasPallet = await checkPalletAvailability(this.api, 'credential');
      if (!hasPallet) {
        console.warn('Credential pallet not available');
        return null;
      }

      const credential = await this.api.query.credential.credentials(credentialId);
      
      if (credential.isEmpty) {
        return null;
      }
      
      const data = credential.toJSON() as any;
      return formatCredentialData(data);
    } catch (error) {
      console.error('Error fetching credential:', error);
      return null;
    }
  }

  async getCredentialByHash(credentialHash: string) {
    try {
      const hasPallet = await checkPalletAvailability(this.api, 'credential');
      if (!hasPallet) {
        console.warn('Credential pallet not available');
        return null;
      }

      const credentialId = await this.api.query.credential.credentialByHash(credentialHash);
      
      if (credentialId.isEmpty) {
        return null;
      }
      
      const id = credentialId.toString();
      return this.getCredential(id);
    } catch (error) {
      console.error('Error fetching credential by hash:', error);
      return null;
    }
  }

  async getCredentialsByHolder(holderAddress: string) {
    try {
      const hasPallet = await checkPalletAvailability(this.api, 'credential');
      if (!hasPallet) {
        console.warn('Credential pallet not available');
        return [];
      }

      const credentials = await this.api.query.credential.credentialsByHolder(holderAddress);
      
      if (credentials.isEmpty) {
        return [];
      }
      
      const credentialRefs = credentials.toJSON() as any[];
      
      // Fetch full credentials
      const fullCredentials = await Promise.all(
        credentialRefs.map(async (ref) => {
          try {
            return await this.getCredential(ref.credentialId);
          } catch (error) {
            console.error('Error fetching credential:', error);
            return null;
          }
        })
      );
      
      return fullCredentials.filter(c => c !== null);
    } catch (error) {
      console.error('Error fetching credentials by holder:', error);
      return [];
    }
  }

  async getCredentialsByIssuer(issuerAddress: string) {
    try {
      const hasPallet = await checkPalletAvailability(this.api, 'credential');
      if (!hasPallet) {
        console.warn('Credential pallet not available');
        return [];
      }

      const credentialIds = await this.api.query.credential.credentialsByIssuer(issuerAddress);
      
      if (credentialIds.isEmpty) {
        return [];
      }
      
      const ids = credentialIds.toJSON() as string[];
      
      // Fetch full credentials
      const fullCredentials = await Promise.all(
        ids.map(async (id) => {
          try {
            return await this.getCredential(id);
          } catch (error) {
            console.error('Error fetching credential:', error);
            return null;
          }
        })
      );
      
      return fullCredentials.filter(c => c !== null);
    } catch (error) {
      console.error('Error fetching credentials by issuer:', error);
      return [];
    }
  }

  async verifyCredentialExists(credentialHash: string): Promise<boolean> {
    try {
      const credential = await this.getCredentialByHash(credentialHash);
      return credential !== null;
    } catch (error) {
      console.error('Error verifying credential:', error);
      return false;
    }
  }
}

/**
 * Enhanced Reputation Queries with real blockchain data
 */
export class RealReputationQueries {
  constructor(private api: ApiPromise) {}

  async getReputationScore(address: string) {
    try {
      const hasPallet = await checkPalletAvailability(this.api, 'reputation');
      if (!hasPallet) {
        console.warn('Reputation pallet not available');
        return {
          credentialsIssued: 0,
          credentialsVerified: 0,
          endorsementsReceived: 0,
          endorsementsGiven: 0,
          totalScore: 0,
        };
      }

      const score = await this.api.query.reputation.reputationScores(address);
      
      if (score.isEmpty) {
        return {
          credentialsIssued: 0,
          credentialsVerified: 0,
          endorsementsReceived: 0,
          endorsementsGiven: 0,
          totalScore: 0,
        };
      }
      
      return score.toJSON() as any;
    } catch (error) {
      console.error('Error fetching reputation score:', error);
      return {
        credentialsIssued: 0,
        credentialsVerified: 0,
        endorsementsReceived: 0,
        endorsementsGiven: 0,
        totalScore: 0,
      };
    }
  }

  async getEndorsementsReceived(address: string) {
    try {
      const hasPallet = await checkPalletAvailability(this.api, 'reputation');
      if (!hasPallet) return [];

      const endorsements = await this.api.query.reputation.endorsementsReceived(address);
      
      if (endorsements.isEmpty) {
        return [];
      }
      
      return endorsements.toJSON() as any[];
    } catch (error) {
      console.error('Error fetching endorsements received:', error);
      return [];
    }
  }

  async getEndorsementsGiven(address: string) {
    try {
      const hasPallet = await checkPalletAvailability(this.api, 'reputation');
      if (!hasPallet) return [];

      const endorsements = await this.api.query.reputation.endorsementsGiven(address);
      
      if (endorsements.isEmpty) {
        return [];
      }
      
      return endorsements.toJSON() as any[];
    } catch (error) {
      console.error('Error fetching endorsements given:', error);
      return [];
    }
  }
}

/**
 * Combined Real Queries Helper
 */
export class RealBlockchainQueries {
  did: RealDIDQueries;
  credential: RealCredentialQueries;
  reputation: RealReputationQueries;

  constructor(api: ApiPromise) {
    this.did = new RealDIDQueries(api);
    this.credential = new RealCredentialQueries(api);
    this.reputation = new RealReputationQueries(api);
  }

  /**
   * Get comprehensive user data
   */
  async getUserData(address: string) {
    try {
      const [did, institution, credentials, reputation] = await Promise.all([
        this.did.getDID(address),
        this.did.getInstitution(address),
        this.credential.getCredentialsByHolder(address),
        this.reputation.getReputationScore(address),
      ]);

      return {
        did,
        institution,
        credentials,
        reputation,
        isInstitution: institution !== null,
        isVerified: institution?.verified || false,
      };
    } catch (error) {
      console.error('Error fetching user data:', error);
      return null;
    }
  }

  /**
   * Get institution data with issued credentials
   */
  async getInstitutionData(address: string) {
    try {
      const [institution, issuedCredentials, reputation, endorsementsReceived] = await Promise.all([
        this.did.getInstitution(address),
        this.credential.getCredentialsByIssuer(address),
        this.reputation.getReputationScore(address),
        this.reputation.getEndorsementsReceived(address),
      ]);

      return {
        institution,
        issuedCredentials,
        reputation,
        endorsementsReceived,
        isVerified: institution?.verified || false,
      };
    } catch (error) {
      console.error('Error fetching institution data:', error);
      return null;
    }
  }
}
</file>

<file path="src/lib/blockchain/transactions.ts">
// src/lib/blockchain/transactions.ts
import type { ApiPromise } from '@polkadot/api';
import type { InjectedAccountWithMeta } from '@polkadot/extension-inject/types';
import { web3FromAddress } from '@polkadot/extension-dapp';
import { toast } from 'sonner';

export interface TransactionStatus {
  status: 'idle' | 'signing' | 'submitting' | 'inBlock' | 'finalized' | 'error';
  message: string;
  blockHash?: string;
  error?: string;
}

export interface TransactionResult {
  success: boolean;
  blockHash?: string;
  transactionHash?: string;
  error?: string;
}

/**
 * Submit a transaction with proper error handling and status updates
 */
export function submitTransaction(
    api: ApiPromise,
    account: InjectedAccountWithMeta | { address: string },
    extrinsic: any,
    onStatusUpdate?: (status: TransactionStatus) => void
  ): Promise<TransactionResult> {
    return new Promise(async (resolve) => {
      try {
        onStatusUpdate?.({
          status: 'signing',
          message: 'Waiting for signature...',
        });
  
        const injector = await web3FromAddress(account.address);
  
        let unsub: (() => void) | undefined;
  
        unsub = await extrinsic.signAndSend(
          account.address,
          { signer: injector.signer },
          ({ status, events, dispatchError }) => {
            if (status.isReady) {
              onStatusUpdate?.({
                status: 'signing',
                message: 'Waiting for signature...',
              });
            }
  
            if (status.isInBlock) {
              onStatusUpdate?.({
                status: 'inBlock',
                message: 'Transaction included in block',
                blockHash: status.asInBlock.toHex(),
              });
            }
  
            if (dispatchError) {
              let errorMessage = dispatchError.toString();
  
              if (dispatchError.isModule) {
                const decoded = api.registry.findMetaError(
                  dispatchError.asModule
                );
                errorMessage = `${decoded.section}.${decoded.name}: ${decoded.docs.join(' ')}`;
              }
  
              onStatusUpdate?.({
                status: 'error',
                message: 'Transaction failed',
                error: errorMessage,
              });
  
              unsub?.();
              resolve({ success: false, error: errorMessage });
              return;
            }
  
            if (status.isFinalized) {
              onStatusUpdate?.({
                status: 'finalized',
                message: 'Transaction finalized',
                blockHash: status.asFinalized.toHex(),
              });
  
              unsub?.();
              resolve({
                success: true,
                blockHash: status.asFinalized.toHex(),
                transactionHash: extrinsic.hash.toHex(),
              });
            }
          }
        );
      } catch (error) {
        const message =
          error instanceof Error ? error.message : 'Unknown error';
  
        onStatusUpdate?.({
          status: 'error',
          message: 'Transaction failed',
          error: message,
        });
  
        resolve({ success: false, error: message });
      }
    });
  }
  
/**
 * DID Pallet Transactions
 */
export class DIDTransactions {
  constructor(private api: ApiPromise) {}

  async createDID(
    account: InjectedAccountWithMeta | { address: string },
    publicKey: Uint8Array,
    keyType: 'Ed25519' | 'Sr25519' | 'ECDSA',
    onStatusUpdate?: (status: TransactionStatus) => void
  ): Promise<TransactionResult> {
    const tx = this.api.tx.did.createDid(publicKey, keyType);
    return submitTransaction(this.api, account, tx, onStatusUpdate);
  }

  async registerInstitution(
    account: InjectedAccountWithMeta | { address: string },
    name: string,
    onStatusUpdate?: (status: TransactionStatus) => void
  ): Promise<TransactionResult> {
    const tx = this.api.tx.did.registerInstitution(name);
    return submitTransaction(this.api, account, tx, onStatusUpdate);
  }

  async addPublicKey(
    account: InjectedAccountWithMeta | { address: string },
    publicKey: Uint8Array,
    keyType: 'Ed25519' | 'Sr25519' | 'ECDSA',
    onStatusUpdate?: (status: TransactionStatus) => void
  ): Promise<TransactionResult> {
    const tx = this.api.tx.did.addPublicKey(publicKey, keyType);
    return submitTransaction(this.api, account, tx, onStatusUpdate);
  }
}

/**
 * Credential Pallet Transactions
 */
export class CredentialTransactions {
  constructor(private api: ApiPromise) {}

  async issueCredential(
    account: InjectedAccountWithMeta | { address: string },
    holder: string,
    credentialHash: string,
    credentialType: string,
    metadata: string,
    expiresAt: number | null,
    onStatusUpdate?: (status: TransactionStatus) => void
  ): Promise<TransactionResult> {
    // Map UI credential types to blockchain enum variants
    const typeMapping: Record<string, string> = {
      "Bachelor's Degree": "Degree",
      "Master's Degree": "MastersDegree",
      "Doctorate (PhD)": "Doctorate",
      "Certificate": "Certificate",
      "Transcript": "Transcript",
      "Professional Certification": "ProfessionalCertification",
      "Other": "Other",
    };
  
    const blockchainType = typeMapping[credentialType] || "Other";
    
    console.log(' Mapping credential type:', credentialType, '->', blockchainType);
  
    const tx = this.api.tx.credential.issueCredential(
      holder,
      credentialHash,
      blockchainType, // Use mapped type
      metadata,
      expiresAt
    );
    
    return submitTransaction(this.api, account, tx, onStatusUpdate);
  }

  async revokeCredential(
    account: InjectedAccountWithMeta | { address: string },
    credentialId: string,
    onStatusUpdate?: (status: TransactionStatus) => void
  ): Promise<TransactionResult> {
    const tx = this.api.tx.credential.revokeCredential(credentialId);
    return submitTransaction(this.api, account, tx, onStatusUpdate);
  }

  async verifyCredential(
    account: InjectedAccountWithMeta | { address: string },
    credentialHash: string,
    onStatusUpdate?: (status: TransactionStatus) => void
  ): Promise<TransactionResult> {
    const tx = this.api.tx.credential.verifyCredential(credentialHash);
    return submitTransaction(this.api, account, tx, onStatusUpdate);
  }
}

/**
 * Reputation Pallet Transactions
 */
export class ReputationTransactions {
  constructor(private api: ApiPromise) {}

  async endorse(
    account: InjectedAccountWithMeta | { address: string },
    endorsee: string,
    endorsementType: string,
    comment: string,
    weight: number,
    onStatusUpdate?: (status: TransactionStatus) => void
  ): Promise<TransactionResult> {
    const tx = this.api.tx.reputation.endorse(
      endorsee,
      endorsementType,
      comment,
      weight
    );
    return submitTransaction(this.api, account, tx, onStatusUpdate);
  }
}
</file>

<file path="src/lib/utils/bn-shim.ts">
// BN.js shim to handle import issues
// @ts-ignore
import BN from 'bn.js/lib/bn.js';

export default BN;
export { BN };
</file>

<file path="src/lib/utils/cn.ts">
// cn.ts - Class name utility
import { type ClassValue, clsx } from 'clsx';
import { twMerge } from 'tailwind-merge';

export function cn(...inputs: ClassValue[]) {
  return twMerge(clsx(inputs));
}
</file>

<file path="src/lib/utils/constants.ts">
// constants.ts - Application constants
export const APP_NAME = 'Academic Verify';
export const APP_VERSION = '1.0.0';

// Blockchain constants
export const CHAIN_CONFIG = {
  WS_PROVIDER: 'ws://127.0.0.1:9944', // Local node
  // WS_PROVIDER: 'wss://your-parachain.example.com', // Production
  CHAIN_NAME: 'Academic Verification Chain',
  DECIMALS: 12,
  TOKEN_SYMBOL: 'AVC',
};

// Transaction status
export const TX_STATUS = {
  IDLE: 'idle',
  SIGNING: 'signing',
  SUBMITTING: 'submitting',
  IN_BLOCK: 'inBlock',
  FINALIZED: 'finalized',
  ERROR: 'error',
} as const;

// DID status
export const DID_STATUS = {
  NONE: 'none',
  ACTIVE: 'active',
  INACTIVE: 'inactive',
  PENDING: 'pending',
} as const;

// Credential status
export const CREDENTIAL_STATUS = {
  ACTIVE: 'active',
  REVOKED: 'revoked',
  EXPIRED: 'expired',
} as const;

// Credential types
// export const CREDENTIAL_TYPES = [
//   'Bachelor\'s Degree',
//   'Master\'s Degree',
//   'Doctorate (PhD)',
//   'Certificate',
//   'Transcript',
//   'Professional Certification',
//   'Other',
// ] as const;

// Institution types
export const INSTITUTION_TYPES = [
  'University',
  'College',
  'Training Center',
  'Vocational School',
  'Online Academy',
  'Other',
] as const;

// Endorsement types
export const ENDORSEMENT_TYPES = [
  'Professional',
  'Academic',
  'Research',
  'Teaching',
  'Innovation',
] as const;

// Reputation score thresholds
export const REPUTATION_THRESHOLDS = {
  NEW: 0,
  ESTABLISHED: 201,
  REPUTABLE: 501,
  EXCELLENT: 751,
} as const;

// Local storage keys
export const STORAGE_KEYS = {
  CREDENTIALS: 'av_credentials',
  PREFERENCES: 'av_preferences',
  CACHED_DIDS: 'av_cached_dids',
  THEME: 'av_theme',
} as const;

// Pagination
export const PAGINATION = {
  DEFAULT_PAGE_SIZE: 10,
  MAX_PAGE_SIZE: 50,
} as const;

// File upload
export const FILE_UPLOAD = {
  MAX_SIZE: 10 * 1024 * 1024, // 10MB
  ACCEPTED_TYPES: ['application/pdf', 'image/png', 'image/jpeg'],
} as const;

export const CREDENTIAL_TYPES = [
  'Bachelor\'s Degree',
  'Master\'s Degree',
  'Doctorate (PhD)',
  'Certificate',
  'Transcript',
  'Professional Certification',
  'Other',
] as const;

// Blockchain enum mapping
export const CREDENTIAL_TYPE_ENUM_MAP: Record<string, string> = {
  "Bachelor's Degree": "Degree",
  "Master's Degree": "MastersDegree",
  "Doctorate (PhD)": "Doctorate",
  "Certificate": "Certificate",
  "Transcript": "Transcript",
  "Professional Certification": "ProfessionalCertification",
  "Other": "Other",
};

// Reverse mapping for displaying blockchain data
export const CREDENTIAL_TYPE_DISPLAY_MAP: Record<string, string> = {
  "Degree": "Bachelor's Degree",
  "MastersDegree": "Master's Degree",
  "Doctorate": "Doctorate (PhD)",
  "Certificate": "Certificate",
  "Transcript": "Transcript",
  "ProfessionalCertification": "Professional Certification",
  "Other": "Other",
};
</file>

<file path="src/lib/utils/env.ts">
// src/lib/utils/env.ts
/**
 * Environment configuration helper
 */

export const ENV = {
    // Blockchain
    WS_PROVIDER: import.meta.env.VITE_WS_PROVIDER || 'ws://127.0.0.1:9944',
    CHAIN_NAME: import.meta.env.VITE_CHAIN_NAME || 'Academic Verification Chain',
    TOKEN_SYMBOL: import.meta.env.VITE_TOKEN_SYMBOL || 'AVC',
    TOKEN_DECIMALS: parseInt(import.meta.env.VITE_TOKEN_DECIMALS || '12'),
  
    // App
    APP_NAME: import.meta.env.VITE_APP_NAME || 'Academic Verify',
    APP_VERSION: import.meta.env.VITE_APP_VERSION || '1.0.0',
  
    // Features
    ENABLE_DEMO_MODE: import.meta.env.VITE_ENABLE_DEMO_MODE === 'true',
    DEMO_CREDENTIALS: import.meta.env.VITE_DEMO_CREDENTIALS === 'true',
  
    // Development
    isDevelopment: import.meta.env.DEV,
    isProduction: import.meta.env.PROD,
    
    // Testnet endpoints (for future use)
    TESTNET_WS: import.meta.env.VITE_TESTNET_WS || '',
    TESTNET_EXPLORER: import.meta.env.VITE_TESTNET_EXPLORER || '',
  } as const;
  
  // Validate required environment variables
  export function validateEnv() {
    const required = ['WS_PROVIDER'];
    const missing = required.filter(key => !ENV[key as keyof typeof ENV]);
  
    if (missing.length > 0) {
      console.warn('Missing environment variables:', missing);
    }
  
    return missing.length === 0;
  }
  
  // Export typed env for use in app
  export type AppEnv = typeof ENV;
</file>

<file path="src/pages/AdminVerification.tsx">
// src/pages/admin/AdminVerification.tsx - FIXED VERSION
import { useState, useEffect } from 'react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/Card';
import { Button } from '@/components/ui/Button';
import { Badge } from '@/components/ui/Badge';
import { AlertCircle, CheckCircle, XCircle, Loader2, Building2, Shield } from 'lucide-react';
import { usePolkadotContext } from '@/providers/PolkadotProvider';
import { useWalletStore } from '@/store/wallet.store';
import { hexToString } from '@polkadot/util';
import { web3FromAddress } from '@polkadot/extension-dapp';
import { toast } from 'sonner';

interface PendingInstitution {
  address: string;
  name: string;
  registeredAt: number;
  verified: boolean;
}

export default function AdminVerification() {
  const { api, isReady } = usePolkadotContext();
  const { account } = useWalletStore();
  const [institutions, setInstitutions] = useState<PendingInstitution[]>([]);
  const [loading, setLoading] = useState(false);
  const [verifying, setVerifying] = useState<string | null>(null);
  const [revoking, setRevoking] = useState<string | null>(null);

  // Helper to decode institution names
  const decodeInstitutionName = (name: string | any): string => {
    try {
      if (typeof name === 'string' && !name.startsWith('0x')) {
        return name;
      }
      if (typeof name === 'string' && name.startsWith('0x')) {
        const decoded = hexToString(name);
        return decoded.replace(/\0/g, '');
      }
      if (name && (name instanceof Uint8Array || Array.isArray(name))) {
        const nameStr = String.fromCharCode(...Array.from(name));
        return nameStr.replace(/\0/g, '');
      }
      return String(name);
    } catch (error) {
      console.error('Error decoding institution name:', error);
      return String(name);
    }
  };

  // Fetch all institutions
  const fetchInstitutions = async () => {
    if (!api || !isReady) return;

    setLoading(true);
    try {
      const entries = await api.query.did.institutions.entries();
      
      const institutionsList: PendingInstitution[] = entries
        .map(([key, value]) => {
          if (value.isEmpty) return null;
          
          const address = key.args[0].toString();
          const data = value.toJSON() as any;
          
          return {
            address,
            name: decodeInstitutionName(data.name),
            registeredAt: data.registeredAt || Date.now(),
            verified: data.verified || false,
          };
        })
        .filter(Boolean) as PendingInstitution[];

      setInstitutions(institutionsList);
      console.log(' Fetched institutions:', institutionsList);
    } catch (error) {
      console.error(' Error fetching institutions:', error);
      toast.error('Failed to fetch institutions');
    } finally {
      setLoading(false);
    }
  };

  useEffect(() => {
    if (isReady && api) {
      fetchInstitutions();
    }
  }, [isReady, api]);

  // Handle verification with proper signer
  const handleVerify = async (institutionDid: string) => {
    if (!api || !account) {
      toast.error('Wallet not connected');
      return;
    }

    setVerifying(institutionDid);

    try {
      console.log(' Starting verification for:', institutionDid);

      // Get the signer
      const injector = await web3FromAddress(account.address);

      // IMPORTANT: Wrap with sudo.sudo() since this requires root origin
      const verifyTx = api.tx.did.verifyInstitution(institutionDid);
      const tx = api.tx.sudo.sudo(verifyTx);
      
      console.log(' Created SUDO transaction, requesting signature...');

      // Sign and send
      await tx.signAndSend(
        account.address,
        { signer: injector.signer },
        ({ status, events, dispatchError }) => {
          console.log(' Transaction status:', status.type);

          if (status.isFinalized) {
            console.log(' Transaction finalized:', status.asFinalized.toHex());

            if (dispatchError) {
              console.error(' Dispatch error:', dispatchError.toString());
              
              if (dispatchError.isModule) {
                const decoded = api.registry.findMetaError(dispatchError.asModule);
                throw new Error(`${decoded.section}.${decoded.name}: ${decoded.docs.join(' ')}`);
              } else {
                throw new Error(dispatchError.toString());
              }
            }

            // Success - update local state
            setInstitutions(prev =>
              prev.map(inst =>
                inst.did === institutionDid
                  ? { ...inst, verified: true }
                  : inst
              )
            );

            toast.success('Institution verified successfully!');
          }
        }
      );
    } catch (error: any) {
      console.error(' Verification failed:', error);
      toast.error(error.message || 'Failed to verify institution');
    } finally {
      setVerifying(null);
    }
  };

  // Handle revocation
  const handleRevoke = async (institutionAddress: string) => {
    if (!api || !account) {
      toast.error('Please connect your wallet');
      return;
    }

    if (!confirm('Are you sure you want to revoke this institution\'s verification?')) {
      return;
    }

    setRevoking(institutionAddress);

    try {
      console.log(' Starting revocation for:', institutionAddress);
      
      const injector = await web3FromAddress(account.address);
      const tx = api.tx.did.revokeInstitution(institutionAddress);
      
      await tx.signAndSend(
        account.address,
        { signer: injector.signer },
        ({ status, dispatchError }) => {
          if (status.isFinalized) {
            if (dispatchError) {
              toast.error('Revocation failed');
            } else {
              toast.success('Institution revoked successfully');
              fetchInstitutions();
            }
            setRevoking(null);
          }
        }
      );
    } catch (error: any) {
      console.error(' Revocation failed:', error);
      toast.error('Revocation failed', {
        description: error.message || 'Unknown error',
      });
      setRevoking(null);
    }
  };

  if (!isReady) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Card className="max-w-md">
          <CardContent className="py-12 text-center">
            <Loader2 className="h-8 w-8 animate-spin mx-auto mb-3 text-primary" />
            <p className="text-muted-foreground">Connecting to blockchain...</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  if (!account) {
    return (
      <div className="flex items-center justify-center min-h-screen">
        <Card className="max-w-md">
          <CardHeader>
            <CardTitle className="flex items-center text-yellow-600">
              <AlertCircle className="h-5 w-5 mr-2" />
              Authentication Required
            </CardTitle>
          </CardHeader>
          <CardContent>
            <p className="text-muted-foreground mb-4">
              Please connect your wallet to access admin functions
            </p>
            <p className="text-xs text-muted-foreground">
              Note: You need to use a sudo/root account to verify institutions
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  const pendingInstitutions = institutions.filter(i => !i.verified);
  const verifiedInstitutions = institutions.filter(i => i.verified);

  return (
    <div className="container mx-auto p-6 max-w-6xl">
      <div className="mb-8">
        <h1 className="text-3xl font-bold flex items-center mb-2">
          <Shield className="h-8 w-8 mr-3 text-primary" />
          Institution Verification
        </h1>
        <p className="text-muted-foreground">
          Review and verify academic institutions
        </p>
      </div>

      {/* Warning banner */}
      <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4 mb-6">
        <div className="flex items-start space-x-3">
          <AlertCircle className="h-5 w-5 text-yellow-600 dark:text-yellow-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm">
            <p className="font-semibold text-yellow-800 dark:text-yellow-400">Admin Access Required</p>
            <p className="text-yellow-700 dark:text-yellow-300 mt-1">
              You must be using a sudo/root account (Alice, Bob, Charlie, etc.) to verify institutions.
              Regular accounts cannot perform these operations.
            </p>
          </div>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-8">
        <Card>
          <CardContent className="pt-6">
            <div className="text-2xl font-bold">{institutions.length}</div>
            <p className="text-sm text-muted-foreground">Total Institutions</p>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="text-2xl font-bold text-yellow-600">{pendingInstitutions.length}</div>
            <p className="text-sm text-muted-foreground">Pending Verification</p>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="text-2xl font-bold text-green-600">{verifiedInstitutions.length}</div>
            <p className="text-sm text-muted-foreground">Verified</p>
          </CardContent>
        </Card>
      </div>

      <div className="flex justify-between items-center mb-4">
        <h2 className="text-xl font-semibold">Pending Institutions</h2>
        <Button
          variant="outline"
          onClick={fetchInstitutions}
          disabled={loading}
        >
          {loading ? (
            <Loader2 className="h-4 w-4 animate-spin" />
          ) : (
            'Refresh'
          )}
        </Button>
      </div>

      {loading ? (
        <Card>
          <CardContent className="py-12 text-center">
            <Loader2 className="h-8 w-8 animate-spin mx-auto mb-3 text-primary" />
            <p className="text-muted-foreground">Loading institutions...</p>
          </CardContent>
        </Card>
      ) : pendingInstitutions.length === 0 ? (
        <Card>
          <CardContent className="py-12 text-center">
            <CheckCircle className="h-12 w-12 mx-auto mb-3 text-green-500 opacity-50" />
            <p className="text-lg font-medium">No pending verifications</p>
            <p className="text-sm text-muted-foreground mt-1">
              All registered institutions have been reviewed
            </p>
          </CardContent>
        </Card>
      ) : (
        <div className="grid gap-4">
          {pendingInstitutions.map((institution) => (
            <Card key={institution.address} className="border-yellow-200 dark:border-yellow-800">
              <CardContent className="pt-6">
                <div className="flex items-start justify-between">
                  <div className="flex-1">
                    <div className="flex items-center space-x-2 mb-2">
                      <Building2 className="h-5 w-5 text-primary" />
                      <h3 className="font-semibold text-lg">{institution.name}</h3>
                      <Badge variant="warning">Pending</Badge>
                    </div>
                    <code className="text-xs text-muted-foreground block mb-2">
                      {institution.address}
                    </code>
                    <p className="text-sm text-muted-foreground">
                      Registered: {new Date(institution.registeredAt).toLocaleDateString()}
                    </p>
                  </div>
                  <div className="flex gap-2">
                    <Button
                      size="sm"
                      onClick={() => handleVerify(institution.address)}
                      disabled={verifying === institution.address}
                    >
                      {verifying === institution.address ? (
                        <><Loader2 className="h-3 w-3 mr-1 animate-spin" /> Verifying...</>
                      ) : (
                        <><CheckCircle className="h-3 w-3 mr-1" /> Verify</>
                      )}
                    </Button>
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}

      {/* Verified Institutions */}
      {verifiedInstitutions.length > 0 && (
        <>
          <h2 className="text-xl font-semibold mt-8 mb-4">Verified Institutions</h2>
          <div className="grid gap-4">
            {verifiedInstitutions.map((institution) => (
              <Card key={institution.address}>
                <CardContent className="pt-6">
                  <div className="flex items-start justify-between">
                    <div className="flex-1">
                      <div className="flex items-center space-x-2 mb-2">
                        <Building2 className="h-5 w-5 text-primary" />
                        <h3 className="font-semibold text-lg">{institution.name}</h3>
                        <Badge variant="success">Verified</Badge>
                      </div>
                      <code className="text-xs text-muted-foreground block">
                        {institution.address}
                      </code>
                    </div>
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => handleRevoke(institution.address)}
                      disabled={revoking === institution.address}
                      className="text-red-600"
                    >
                      {revoking === institution.address ? (
                        <><Loader2 className="h-3 w-3 mr-1 animate-spin" /> Revoking...</>
                      ) : (
                        <><XCircle className="h-3 w-3 mr-1" /> Revoke</>
                      )}
                    </Button>
                  </div>
                </CardContent>
              </Card>
            ))}
          </div>
        </>
      )}
    </div>
  );
}
</file>

<file path="src/pages/CreateDIDPage.tsx">
import { useNavigate } from 'react-router-dom';
import CreateDIDForm from '@/components/did/CreateDIDForm';

export default function CreateDIDPage() {
  const navigate = useNavigate();

  const handleSuccess = () => {
    // Navigate to dashboard after successful DID creation
    navigate('/dashboard');
  };

  return (
    <div className="max-w-4xl mx-auto py-8">
      <div className="mb-8 text-center">
        <h1 className="text-3xl font-bold mb-2">Welcome to Academic Verify</h1>
        <p className="text-muted-foreground">
          Let's create your decentralized identifier to get started
        </p>
      </div>
      
      <CreateDIDForm onSuccess={handleSuccess} />
    </div>
  );
}
</file>

<file path="src/pages/Credentials.tsx">
// src/pages/Credentials.tsx - UPDATED WITH REAL DATA
import { useEffect, useState } from 'react';
import { useWalletStore } from '@/store/wallet.store';
import { useDIDStore } from '@/store/did.store';
import { useCredentialsStore } from '@/store/credentials.store';
import { useBlockchain } from '@/hooks/blockchain/useBlockchain';
import CredentialsList from '@/components/credentials/CredentialsList';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/Card';
import { Button } from '@/components/ui/Button';
import { AlertCircle, Award, RefreshCw, Loader2 } from 'lucide-react';
import { useNavigate } from 'react-router-dom';
import { toast } from 'sonner';
import type { Credential } from '@/components/credentials/CredentialCard';

export default function Credentials() {
  const navigate = useNavigate();
  const { isConnected, account } = useWalletStore();
  const { hasDID, didAddress } = useDIDStore();
  const { credentials, setCredentials, loading, setLoading } = useCredentialsStore();
  const [refreshing, setRefreshing] = useState(false);
  const [fetchError, setFetchError] = useState<string | null>(null);
  
  const { queries, isReady } = useBlockchain();

  // Fetch credentials when component mounts
  useEffect(() => {
    if (isConnected && hasDID && didAddress && isReady && queries) {
      fetchCredentials();
    }
  }, [isConnected, hasDID, didAddress, isReady, queries]);

  const fetchCredentials = async () => {
    if (!queries || !didAddress) {
      console.log('Missing queries or didAddress');
      return;
    }

    setLoading(true);
    setFetchError(null);

    try {
      console.log(' Fetching credentials for:', didAddress);
      
      // Fetch real credentials from blockchain
      const blockchainCredentials = await queries.credential.getCredentialsByHolder(didAddress);
      
      console.log(' Fetched credentials:', blockchainCredentials);
      
      if (blockchainCredentials.length === 0) {
        console.log(' No credentials found on blockchain');
        setCredentials([]);
        setLoading(false);
        return;
      }

      // Fetch institution names for issuers
      const credentialsWithInstitutionNames = await Promise.all(
        blockchainCredentials.map(async (cred) => {
          try {
            const institution = await queries.did.getInstitution(cred.issuer);
            return {
              ...cred,
              issuerName: institution?.name || undefined,
              degreeName: extractDegreeName(cred.metadata),
              fieldOfStudy: extractFieldOfStudy(cred.metadata),
            } as Credential;
          } catch (error) {
            console.error('Error fetching institution for issuer:', cred.issuer, error);
            return {
              ...cred,
              degreeName: extractDegreeName(cred.metadata),
              fieldOfStudy: extractFieldOfStudy(cred.metadata),
            } as Credential;
          }
        })
      );

      console.log(' Processed credentials:', credentialsWithInstitutionNames);
      setCredentials(credentialsWithInstitutionNames);
      
      if (credentialsWithInstitutionNames.length > 0) {
        toast.success(`Found ${credentialsWithInstitutionNames.length} credential(s)`);
      }
    } catch (error: any) {
      console.error(' Failed to fetch credentials:', error);
      setFetchError(error.message || 'Failed to fetch credentials');
      toast.error('Failed to load credentials', {
        description: 'Check console for details',
      });
    } finally {
      setLoading(false);
    }
  };

  const handleRefresh = async () => {
    setRefreshing(true);
    await fetchCredentials();
    setRefreshing(false);
    toast.success('Credentials refreshed');
  };

  // Helper functions to extract data from metadata
  function extractDegreeName(metadata?: string): string | undefined {
    if (!metadata) return undefined;
    try {
      const parsed = JSON.parse(metadata);
      return parsed.degreeName || parsed.name || undefined;
    } catch {
      return metadata;
    }
  }

  function extractFieldOfStudy(metadata?: string): string | undefined {
    if (!metadata) return undefined;
    try {
      const parsed = JSON.parse(metadata);
      return parsed.fieldOfStudy || parsed.field || undefined;
    } catch {
      return undefined;
    }
  }

  // Not connected
  if (!isConnected) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardHeader>
            <div className="flex items-center space-x-2 text-yellow-600 mb-2">
              <AlertCircle className="h-5 w-5" />
              <CardTitle>Connect Your Wallet</CardTitle>
            </div>
            <CardDescription>
              Please connect your wallet to view your credentials
            </CardDescription>
          </CardHeader>
        </Card>
      </div>
    );
  }

  // No DID
  if (!hasDID) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardHeader>
            <div className="flex items-center space-x-2 text-yellow-600 mb-2">
              <AlertCircle className="h-5 w-5" />
              <CardTitle>DID Required</CardTitle>
            </div>
            <CardDescription>
              You need to create a Decentralized Identifier to receive and manage credentials
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => navigate('/dashboard')} className="w-full">
              Create DID
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Blockchain not ready
  if (!isReady) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardContent className="py-12 text-center">
            <Loader2 className="h-8 w-8 animate-spin mx-auto mb-3 text-primary" />
            <p className="text-muted-foreground">Connecting to blockchain...</p>
            <p className="text-xs text-muted-foreground mt-2">
              Make sure your local node is running
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold flex items-center">
            <Award className="h-8 w-8 mr-3 text-primary" />
            My Credentials
          </h1>
          <p className="text-muted-foreground mt-1">
            View and manage your academic credentials from the blockchain
          </p>
        </div>
        <Button
          onClick={handleRefresh}
          disabled={refreshing || loading}
          variant="outline"
        >
          <RefreshCw className={`h-4 w-4 mr-2 ${refreshing ? 'animate-spin' : ''}`} />
          Refresh
        </Button>
      </div>

      {/* Connection Status */}
      <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div className="flex items-start space-x-3">
          <Award className="h-5 w-5 text-blue-600 dark:text-blue-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm flex-1">
            <p className="font-semibold text-blue-800 dark:text-blue-400">
              Connected to Blockchain
            </p>
            <p className="text-blue-700 dark:text-blue-300 mt-1">
              All credentials are fetched directly from the blockchain. 
              Your DID: <code className="text-xs font-mono">{didAddress?.slice(0, 10)}...{didAddress?.slice(-8)}</code>
            </p>
          </div>
        </div>
      </div>

      {/* Error Message */}
      {fetchError && (
        <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
          <div className="flex items-start space-x-3">
            <AlertCircle className="h-5 w-5 text-red-600 dark:text-red-500 flex-shrink-0 mt-0.5" />
            <div className="text-sm flex-1">
              <p className="font-semibold text-red-800 dark:text-red-400">
                Error Loading Credentials
              </p>
              <p className="text-red-700 dark:text-red-300 mt-1">
                {fetchError}
              </p>
              <Button 
                variant="outline" 
                size="sm" 
                onClick={handleRefresh}
                className="mt-2"
              >
                Try Again
              </Button>
            </div>
          </div>
        </div>
      )}

      {/* Credentials List */}
      <CredentialsList 
        credentials={credentials}
        loading={loading}
        emptyMessage={
          isReady 
            ? "No credentials found on blockchain. Credentials issued to your DID will appear here."
            : "Waiting for blockchain connection..."
        }
      />
    </div>
  );
}
</file>

<file path="src/pages/Dashboard.tsx">
// src/pages/Dashboard.tsx
import { useWalletStore } from '@/store/wallet.store';
import { useDIDStore } from '@/store/did.store';
import { useBalance } from '@/hooks/blockchain/useBalance';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/Card';
import { Button } from '@/components/ui/Button';
import { Badge } from '@/components/ui/Badge';
import { Award, Building2, CheckCircle, Wallet, AlertCircle, Key } from 'lucide-react';
import { Link } from 'react-router-dom';
import CreateDIDPage from './CreateDIDPage';
import { useState } from 'react';
import { DID_STATUS } from '@/lib/utils/constants';
import CreateDIDModal from '@/components/did/CreateDIDModal';

export default function Dashboard() {
  const { isConnected, account } = useWalletStore();
  const { hasDID, isInstitution, didAddress, status } = useDIDStore();
  const { balance, loading: balanceLoading } = useBalance();
  const [showCreateDID, setShowCreateDID] = useState(false);

  // Not connected - show connection prompt
  if (!isConnected) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardHeader>
            <div className="flex items-center space-x-2 text-yellow-600 mb-2">
              <AlertCircle className="h-5 w-5" />
              <CardTitle>Connect Your Wallet</CardTitle>
            </div>
            <CardDescription>
              Please connect your Polkadot wallet to access the dashboard and manage your academic credentials
            </CardDescription>
          </CardHeader>
          <CardContent>
            <div className="space-y-4">
              <p className="text-sm text-muted-foreground">
                You'll need a Polkadot wallet extension to continue:
              </p>
              <ul className="text-sm space-y-2 list-disc list-inside text-muted-foreground">
                <li>Polkadot.js Extension</li>
                <li>Talisman</li>
                <li>SubWallet</li>
              </ul>
              <Button asChild className="w-full">
                <a href="https://polkadot.js.org/extension/" target="_blank" rel="noopener noreferrer">
                  Install Wallet Extension
                </a>
              </Button>
            </div>
          </CardContent>
        </Card>
      </div>
    );
  }

  // No DID - show create DID prompt
  if (!hasDID) {
    return (
      <>
        <div className="max-w-4xl mx-auto py-8">
          <div className="mb-8 text-center">
            <h1 className="text-3xl font-bold mb-2">Welcome to Academic Verify</h1>
            <p className="text-muted-foreground">
              Let's create your decentralized identifier to get started
            </p>
          </div>
          
          <Card>
            <CardHeader>
              <CardTitle className="flex items-center">
                <Key className="h-6 w-6 mr-2" />
                Create Your DID
              </CardTitle>
              <CardDescription>
                A Decentralized Identifier (DID) is required to receive and manage credentials
              </CardDescription>
            </CardHeader>
            <CardContent className="space-y-4">
              <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
                <p className="text-sm text-blue-800 dark:text-blue-400">
                  <strong>What is a DID?</strong>
                </p>
                <p className="text-sm text-blue-700 dark:text-blue-300 mt-2">
                  A DID is your unique identity on the blockchain. It allows institutions to issue 
                  credentials directly to you, and enables anyone to verify your credentials without 
                  needing to contact the issuing institution.
                </p>
              </div>
              
              <Button onClick={() => setShowCreateDID(true)} className="w-full">
                <Key className="h-4 w-4 mr-2" />
                Create DID Now
              </Button>
            </CardContent>
          </Card>
        </div>

        <CreateDIDModal
          isOpen={showCreateDID}
          onClose={() => setShowCreateDID(false)}
        />
      </>
    );
  }

  // Has DID - show full dashboard
  return (
    <div className="space-y-6">
      {/* Welcome Section */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold mb-2">
            Welcome back, {account?.name || 'there'}!
          </h1>
          <p className="text-muted-foreground">
            {isInstitution 
              ? 'Manage your institution and issue credentials' 
              : 'Manage your credentials and academic identity'
            }
          </p>
        </div>
        
        {/* Balance Display */}
        {balance && (
          <Card className="bg-gradient-to-br from-primary/10 to-purple-500/10">
            <CardContent className="pt-6">
              <div className="flex items-center space-x-2 mb-1">
                <Wallet className="h-4 w-4 text-muted-foreground" />
                <span className="text-xs text-muted-foreground">Balance</span>
              </div>
              <div className="text-2xl font-bold">
                {balanceLoading ? '...' : balance.formatted}
              </div>
            </CardContent>
          </Card>
        )}
      </div>

      {/* Account Info */}
      <Card>
        <CardContent className="pt-6">
          <div className="flex items-center justify-between">
            <div className="space-y-1">
              <p className="text-sm text-muted-foreground">DID Address</p>
              <code className="text-xs font-mono bg-muted px-2 py-1 rounded">
                {didAddress}
              </code>
            </div>
            <div className="flex gap-2">
              <Badge variant="success">Active</Badge>
              {isInstitution && <Badge variant="secondary">Institution</Badge>}
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Quick Stats */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              {isInstitution ? 'Issued Credentials' : 'Total Credentials'}
            </CardTitle>
            <Award className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">0</div>
            <p className="text-xs text-muted-foreground">
              {isInstitution ? 'Credentials issued' : 'Academic credentials'}
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              {isInstitution ? 'Active Recipients' : 'Verified'}
            </CardTitle>
            <CheckCircle className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">0</div>
            <p className="text-xs text-muted-foreground">
              {isInstitution ? 'Unique recipients' : 'Times verified'}
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
            <CardTitle className="text-sm font-medium">
              Reputation
            </CardTitle>
            <Building2 className="h-4 w-4 text-muted-foreground" />
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">0</div>
            <p className="text-xs text-muted-foreground">
              Reputation score
            </p>
          </CardContent>
        </Card>
      </div>

      {/* Quick Actions */}
      <Card>
        <CardHeader>
          <CardTitle>Quick Actions</CardTitle>
        </CardHeader>
        <CardContent className="grid grid-cols-1 md:grid-cols-2 gap-4">
          {isInstitution ? (
            <>
              <Link to="/institution/issue">
                <Button variant="outline" className="w-full justify-start h-auto py-4">
                  <div className="flex flex-col items-start w-full">
                    <div className="flex items-center space-x-2 mb-1">
                      <Award className="h-4 w-4" />
                      <span className="font-semibold">Issue Credential</span>
                    </div>
                    <span className="text-xs text-muted-foreground">
                      Issue a new credential to a student
                    </span>
                  </div>
                </Button>
              </Link>
              <Link to="/institution/issued">
                <Button variant="outline" className="w-full justify-start h-auto py-4">
                  <div className="flex flex-col items-start w-full">
                    <div className="flex items-center space-x-2 mb-1">
                      <CheckCircle className="h-4 w-4" />
                      <span className="font-semibold">View Issued</span>
                    </div>
                    <span className="text-xs text-muted-foreground">
                      See all credentials you've issued
                    </span>
                  </div>
                </Button>
              </Link>
            </>
          ) : (
            <>
              <Link to="/credentials">
                <Button variant="outline" className="w-full justify-start h-auto py-4">
                  <div className="flex flex-col items-start w-full">
                    <div className="flex items-center space-x-2 mb-1">
                      <Award className="h-4 w-4" />
                      <span className="font-semibold">My Credentials</span>
                    </div>
                    <span className="text-xs text-muted-foreground">
                      View and manage your credentials
                    </span>
                  </div>
                </Button>
              </Link>
              <Link to="/verify">
                <Button variant="outline" className="w-full justify-start h-auto py-4">
                  <div className="flex flex-col items-start w-full">
                    <div className="flex items-center space-x-2 mb-1">
                      <CheckCircle className="h-4 w-4" />
                      <span className="font-semibold">Verify Credential</span>
                    </div>
                    <span className="text-xs text-muted-foreground">
                      Verify any academic credential
                    </span>
                  </div>
                </Button>
              </Link>
            </>
          )}
        </CardContent>
      </Card>

      {/* Register as Institution */}
      {!isInstitution && (
        <Card className="border-primary/50">
          <CardContent className="pt-6">
            <div className="flex items-center justify-between">
              <div className="flex items-start space-x-4">
                <div className="h-12 w-12 rounded-lg bg-primary/10 flex items-center justify-center">
                  <Building2 className="h-6 w-6 text-primary" />
                </div>
                <div>
                  <h3 className="font-semibold mb-1">Are you an institution?</h3>
                  <p className="text-sm text-muted-foreground">
                    Register as an educational institution to issue credentials to students
                  </p>
                </div>
              </div>
              <Button asChild>
                <Link to="/institution/register">
                  Register Now
                </Link>
              </Button>
            </div>
          </CardContent>
        </Card>
      )}
    </div>
  );
}
</file>

<file path="src/pages/Home.tsx">
// Home.tsx
import { Link } from 'react-router-dom';
import { Award, Shield, Users, Zap } from 'lucide-react';
import { Button } from '@/components/ui/Button';
import { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/Card';

export default function Home() {
  return (
    <div className="space-y-12">
      {/* Hero Section */}
      <section className="text-center py-12">
        <h1 className="text-4xl md:text-6xl font-bold mb-6">
          Decentralized Academic
          <span className="text-primary"> Verification</span>
        </h1>
        <p className="text-xl text-muted-foreground mb-8 max-w-2xl mx-auto">
          Secure, transparent, and verifiable academic credentials powered by blockchain technology.
          Take control of your educational achievements.
        </p>
        <div className="flex justify-center space-x-4">
          <Link to="/dashboard">
            <Button size="lg">
              Get Started
            </Button>
          </Link>
          <Link to="/verify">
            <Button size="lg" variant="outline">
              Verify Credential
            </Button>
          </Link>
        </div>
      </section>

      {/* Features Section */}
      <section>
        <h2 className="text-3xl font-bold text-center mb-8">
          Why Choose Academic Verify?
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <Card>
            <CardHeader>
              <Shield className="h-12 w-12 text-primary mb-4" />
              <CardTitle className="text-xl">Secure</CardTitle>
              <CardDescription>
                Cryptographically secured credentials stored on blockchain
              </CardDescription>
            </CardHeader>
          </Card>

          <Card>
            <CardHeader>
              <Zap className="h-12 w-12 text-primary mb-4" />
              <CardTitle className="text-xl">Instant Verification</CardTitle>
              <CardDescription>
                Verify credentials in seconds without intermediaries
              </CardDescription>
            </CardHeader>
          </Card>

          <Card>
            <CardHeader>
              <Users className="h-12 w-12 text-primary mb-4" />
              <CardTitle className="text-xl">Self-Sovereign</CardTitle>
              <CardDescription>
                You own and control your academic credentials
              </CardDescription>
            </CardHeader>
          </Card>

          <Card>
            <CardHeader>
              <Award className="h-12 w-12 text-primary mb-4" />
              <CardTitle className="text-xl">Reputation System</CardTitle>
              <CardDescription>
                Transparent institution rankings and endorsements
              </CardDescription>
            </CardHeader>
          </Card>
        </div>
      </section>

      {/* How It Works */}
      <section className="bg-accent/50 rounded-lg p-8">
        <h2 className="text-3xl font-bold text-center mb-8">
          How It Works
        </h2>
        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
          <div className="text-center">
            <div className="h-12 w-12 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-xl font-bold mx-auto mb-4">
              1
            </div>
            <h3 className="text-xl font-semibold mb-2">Create Your DID</h3>
            <p className="text-muted-foreground">
              Set up your decentralized identity to receive and manage credentials
            </p>
          </div>

          <div className="text-center">
            <div className="h-12 w-12 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-xl font-bold mx-auto mb-4">
              2
            </div>
            <h3 className="text-xl font-semibold mb-2">Receive Credentials</h3>
            <p className="text-muted-foreground">
              Institutions issue verifiable credentials directly to your DID
            </p>
          </div>

          <div className="text-center">
            <div className="h-12 w-12 rounded-full bg-primary text-primary-foreground flex items-center justify-center text-xl font-bold mx-auto mb-4">
              3
            </div>
            <h3 className="text-xl font-semibold mb-2">Share & Verify</h3>
            <p className="text-muted-foreground">
              Share credentials with anyone who can instantly verify authenticity
            </p>
          </div>
        </div>
      </section>
    </div>
  );
}
</file>

<file path="src/pages/Institution.tsx">
// src/pages/Institution.tsx - REPLACE THIS FILE
import { useState, useEffect } from 'react';
import { useNavigate } from 'react-router-dom';
import { useDIDStore } from '@/store/did.store';
import { useWalletStore } from '@/store/wallet.store';
import { usePolkadotContext } from '@/providers/PolkadotProvider';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/Card';
import { Button } from '@/components/ui/Button';
import { Badge } from '@/components/ui/Badge';
import { 
  Building2, 
  FileText, 
  Users, 
  Award, 
  Plus, 
  RefreshCw, 
  Loader2,
  TrendingUp,
  CheckCircle,
  AlertCircle
} from 'lucide-react';
import { toast } from 'sonner';

interface InstitutionData {
  name: string;
  did: string;
  verified: boolean;
  registeredAt: number;
}

interface ReputationScore {
  credentialsIssued: number;
  credentialsVerified: number;
  endorsementsReceived: number;
  endorsementsGiven: number;
  totalScore: number;
}

export default function Institution() {
  const navigate = useNavigate();
  const { isInstitution, institutionName, didAddress } = useDIDStore();
  const { isConnected } = useWalletStore();
  const { api, isReady } = usePolkadotContext();

  const [institutionData, setInstitutionData] = useState<InstitutionData | null>(null);
  const [reputation, setReputation] = useState<ReputationScore | null>(null);
  const [issuedCount, setIssuedCount] = useState(0);
  const [loading, setLoading] = useState(true);
  const [refreshing, setRefreshing] = useState(false);

  // Fetch institution data from blockchain
  useEffect(() => {
    if (isConnected && isInstitution && didAddress && isReady && api) {
      fetchInstitutionData();
    }
  }, [isConnected, isInstitution, didAddress, isReady, api]);

  const fetchInstitutionData = async () => {
    if (!api || !didAddress) return;

    setLoading(true);
    try {
      console.log(' Fetching institution data for:', didAddress);

      // Fetch institution info
      const institutionInfo = await api.query.did.institutions(didAddress);
      
      if (institutionInfo.isEmpty) {
        console.warn('No institution data found');
        toast.error('Institution data not found');
        setLoading(false);
        return;
      }

      const instData = institutionInfo.toJSON() as any;
      console.log(' Institution data:', instData);

      // Decode institution name from hex
      let decodedName = institutionName || 'Institution';
      if (instData.name) {
        try {
          // Remove 0x prefix if present
          const hexString = instData.name.startsWith('0x') ? instData.name.slice(2) : instData.name;
          // Convert hex to string
          const bytes = new Uint8Array(hexString.match(/.{1,2}/g)?.map((byte: string) => parseInt(byte, 16)) || []);
          const decoded = new TextDecoder().decode(bytes);
          decodedName = decoded || decodedName;
          console.log(' Decoded institution name:', decodedName);
        } catch (error) {
          console.warn('Failed to decode institution name:', error);
        }
      }

      setInstitutionData({
        name: decodedName,
        did: instData.did || didAddress,
        verified: instData.verified || false,
        registeredAt: instData.registeredAt || Date.now(),
      });

      // Fetch reputation score
      const reputationData = await api.query.reputation.reputationScores(didAddress);
      
      if (!reputationData.isEmpty) {
        const repData = reputationData.toJSON() as any;
        console.log(' Reputation data:', repData);
        
        setReputation({
          credentialsIssued: repData.credentialsIssued || 0,
          credentialsVerified: repData.credentialsVerified || 0,
          endorsementsReceived: repData.endorsementsReceived || 0,
          endorsementsGiven: repData.endorsementsGiven || 0,
          totalScore: repData.totalScore || 0,
        });
      } else {
        setReputation({
          credentialsIssued: 0,
          credentialsVerified: 0,
          endorsementsReceived: 0,
          endorsementsGiven: 0,
          totalScore: 0,
        });
      }

      // Fetch issued credentials count
      const issuedCredentials = await api.query.credential.credentialsByIssuer(didAddress);
      
      if (!issuedCredentials.isEmpty) {
        const credentials = issuedCredentials.toJSON() as any[];
        console.log(' Issued credentials count:', credentials.length);
        setIssuedCount(credentials.length);
      } else {
        setIssuedCount(0);
      }

      toast.success('Institution data loaded from blockchain');
    } catch (error: any) {
      console.error(' Failed to fetch institution data:', error);
      toast.error('Failed to load institution data');
    } finally {
      setLoading(false);
    }
  };

  const handleRefresh = async () => {
    setRefreshing(true);
    await fetchInstitutionData();
    setRefreshing(false);
    toast.success('Data refreshed');
  };

  // Not connected
  if (!isConnected) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardHeader>
            <div className="flex items-center space-x-2 text-yellow-600 mb-2">
              <AlertCircle className="h-5 w-5" />
              <CardTitle>Connect Your Wallet</CardTitle>
            </div>
            <CardDescription>
              Please connect your wallet to view your institution profile
            </CardDescription>
          </CardHeader>
        </Card>
      </div>
    );
  }

  // Not an institution
  if (!isInstitution) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardHeader>
            <div className="flex items-center space-x-2 text-red-600 mb-2">
              <AlertCircle className="h-5 w-5" />
              <CardTitle>Institution Access Required</CardTitle>
            </div>
            <CardDescription>
              You need to register as an institution to access this page
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => navigate('/dashboard')} className="w-full">
              Go to Dashboard
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Loading
  if (loading) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardContent className="py-12 text-center">
            <Loader2 className="h-8 w-8 animate-spin mx-auto mb-3 text-primary" />
            <p className="text-muted-foreground">Loading institution data from blockchain...</p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold flex items-center">
            <Building2 className="h-8 w-8 mr-3 text-primary" />
            {institutionData?.name || 'Institution Profile'}
          </h1>
          <p className="text-muted-foreground mt-1">
            Manage your institution and issue credentials
          </p>
        </div>
        <div className="flex items-center space-x-3">
          <Button
            variant="outline"
            size="sm"
            onClick={handleRefresh}
            disabled={refreshing}
          >
            <RefreshCw className={`h-4 w-4 mr-2 ${refreshing ? 'animate-spin' : ''}`} />
            Refresh
          </Button>
          {institutionData?.verified ? (
            <Badge variant="success" className="text-sm px-3 py-1">
              <CheckCircle className="h-3 w-3 mr-1" />
              Verified Institution
            </Badge>
          ) : (
            <Badge variant="warning" className="text-sm px-3 py-1">
              <AlertCircle className="h-3 w-3 mr-1" />
              Pending Verification
            </Badge>
          )}
        </div>
      </div>

      {/* Institution Info */}
      <Card>
        <CardHeader>
          <CardTitle>Institution Information</CardTitle>
          <CardDescription>Your blockchain identity</CardDescription>
        </CardHeader>
        <CardContent className="space-y-3">
          <div className="flex justify-between">
            <span className="text-sm text-muted-foreground">DID Address</span>
            <code className="text-xs font-mono bg-muted px-2 py-1 rounded">
              {didAddress}
            </code>
          </div>
          <div className="flex justify-between">
            <span className="text-sm text-muted-foreground">Registered</span>
            <span className="text-sm">
              {institutionData ? new Date(institutionData.registeredAt).toLocaleDateString() : 'Unknown'}
            </span>
          </div>
          <div className="flex justify-between">
            <span className="text-sm text-muted-foreground">Status</span>
            <Badge variant={institutionData?.verified ? 'success' : 'warning'}>
              {institutionData?.verified ? 'Verified' : 'Pending'}
            </Badge>
          </div>
        </CardContent>
      </Card>

      {/* Stats from Blockchain */}
      <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-muted-foreground flex items-center">
              <FileText className="h-4 w-4 mr-2" />
              Credentials Issued
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{issuedCount}</div>
            <p className="text-xs text-muted-foreground mt-1">
              Total credentials on blockchain
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-muted-foreground flex items-center">
              <Users className="h-4 w-4 mr-2" />
              Endorsements
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{reputation?.endorsementsReceived || 0}</div>
            <p className="text-xs text-muted-foreground mt-1">
              Received from peers
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-muted-foreground flex items-center">
              <Award className="h-4 w-4 mr-2" />
              Reputation Score
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{reputation?.totalScore || 0}</div>
            <p className="text-xs text-muted-foreground mt-1">
              Out of 1000
            </p>
          </CardContent>
        </Card>

        <Card>
          <CardHeader className="pb-3">
            <CardTitle className="text-sm font-medium text-muted-foreground flex items-center">
              <TrendingUp className="h-4 w-4 mr-2" />
              Verifications
            </CardTitle>
          </CardHeader>
          <CardContent>
            <div className="text-2xl font-bold">{reputation?.credentialsVerified || 0}</div>
            <p className="text-xs text-muted-foreground mt-1">
              Credentials verified
            </p>
          </CardContent>
        </Card>
      </div>

      {/* Reputation Breakdown */}
      {reputation && reputation.totalScore > 0 && (
        <Card>
          <CardHeader>
            <CardTitle>Reputation Breakdown</CardTitle>
            <CardDescription>How your score is calculated</CardDescription>
          </CardHeader>
          <CardContent className="space-y-3">
            <div className="flex items-center justify-between">
              <span className="text-sm">Credentials Issued (10)</span>
              <span className="font-semibold">
                {reputation.credentialsIssued}  10 = {reputation.credentialsIssued * 10}
              </span>
            </div>
            <div className="flex items-center justify-between">
              <span className="text-sm">Endorsements Received (20)</span>
              <span className="font-semibold">
                {reputation.endorsementsReceived}  20 = {reputation.endorsementsReceived * 20}
              </span>
            </div>
            <div className="flex items-center justify-between">
              <span className="text-sm">Verifications Done (5)</span>
              <span className="font-semibold">
                {reputation.credentialsVerified}  5 = {reputation.credentialsVerified * 5}
              </span>
            </div>
            <div className="pt-3 border-t flex items-center justify-between">
              <span className="font-semibold">Total Score</span>
              <span className="text-2xl font-bold text-primary">{reputation.totalScore}</span>
            </div>
          </CardContent>
        </Card>
      )}

      {/* Quick Actions */}
      <Card>
        <CardHeader>
          <CardTitle>Quick Actions</CardTitle>
        </CardHeader>
        <CardContent className="grid grid-cols-1 md:grid-cols-3 gap-4">
          <Button 
            variant="outline" 
            className="justify-start h-auto py-4"
            onClick={() => navigate('/institution/issue')}
          >
            <div className="flex flex-col items-start w-full">
              <div className="flex items-center space-x-2 mb-1">
                <Plus className="h-4 w-4" />
                <span className="font-semibold">Issue Credential</span>
              </div>
              <span className="text-xs text-muted-foreground">
                Issue a new credential to a student
              </span>
            </div>
          </Button>

          <Button 
            variant="outline" 
            className="justify-start h-auto py-4"
            onClick={() => navigate('/institution/issued')}
          >
            <div className="flex flex-col items-start w-full">
              <div className="flex items-center space-x-2 mb-1">
                <FileText className="h-4 w-4" />
                <span className="font-semibold">View Issued</span>
              </div>
              <span className="text-xs text-muted-foreground">
                See all credentials you've issued
              </span>
            </div>
          </Button>

          <Button 
            variant="outline" 
            className="justify-start h-auto py-4"
            onClick={() => navigate('/institution/requests')}
          >
            <div className="flex flex-col items-start w-full">
              <div className="flex items-center space-x-2 mb-1">
                <Users className="h-4 w-4" />
                <span className="font-semibold">Requests</span>
              </div>
              <span className="text-xs text-muted-foreground">
                Review credential requests
              </span>
            </div>
          </Button>
        </CardContent>
      </Card>

      {/* Blockchain Status */}
      <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div className="flex items-start space-x-3">
          <CheckCircle className="h-5 w-5 text-blue-600 dark:text-blue-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm flex-1">
            <p className="font-semibold text-blue-800 dark:text-blue-400">
              Connected to Blockchain
            </p>
            <p className="text-blue-700 dark:text-blue-300 mt-1">
              All data is fetched directly from the blockchain in real-time. 
              Click refresh to update with the latest information.
            </p>
          </div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/pages/InstitutionRequests.tsx">
// src/pages/InstitutionRequests.tsx
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { FileText, RefreshCw, AlertCircle } from 'lucide-react';
import { Button } from '@/components/ui/Button';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/Card';
import RequestsList from '@/components/requests/RequestsList';
import ReviewRequestModal from '@/components/requests/ReviewRequestModal';
import { useWalletStore } from '@/store/wallet.store';
import { useDIDStore } from '@/store/did.store';
import { useCredentialRequestsStore } from '@/store/credentialRequests.store';
import type { CredentialRequest } from '@/types/credentialRequest.types';
import { toast } from 'sonner';

export default function InstitutionRequests() {
  const navigate = useNavigate();
  const { isConnected } = useWalletStore();
  const { hasDID, isInstitution, didAddress } = useDIDStore();
  const { 
    receivedRequests, 
    setReceivedRequests, 
    loading, 
    setLoading,
    getPendingCount
  } = useCredentialRequestsStore();
  
  const [selectedRequest, setSelectedRequest] = useState<CredentialRequest | null>(null);
  const [showReviewModal, setShowReviewModal] = useState(false);
  const [refreshing, setRefreshing] = useState(false);

  useEffect(() => {
    if (!isInstitution) {
      navigate('/institution');
      return;
    }

    if (isConnected && hasDID && didAddress) {
      fetchReceivedRequests();
    }
  }, [isConnected, hasDID, didAddress, isInstitution]);

  const fetchReceivedRequests = async () => {
    setLoading(true);
    try {
      // TODO: Query blockchain for requests where institution = didAddress
      await new Promise(resolve => setTimeout(resolve, 1000));

      // Mock data
      const mockRequests: CredentialRequest[] = [
        {
          id: 'req_3',
          requestId: 3,
          requester: '5DTestDqcsdhBM8Y1s5eHMvx1tyDWRxf8LxbCQ8eW3Lw1Kk',
          requesterName: 'John Doe',
          institution: didAddress!,
          credentialType: "Bachelor's Degree",
          programName: 'Bachelor of Science in Computer Science',
          fieldOfStudy: 'Computer Science',
          startDate: '2020-09-01',
          endDate: '2024-05-15',
          studentId: 'STU123456',
          major: 'Software Engineering',
          minor: 'Mathematics',
          expectedGPA: '3.92',
          additionalNotes: 'I participated in the honors program and completed a senior thesis on distributed systems.',
          status: 'pending',
          createdAt: Date.now() - 2 * 24 * 60 * 60 * 1000,
          updatedAt: Date.now() - 2 * 24 * 60 * 60 * 1000,
          supportingDocuments: [
            'QmTest1234567890abcdefghijklmnopqrstuvwxyz',
            'QmTest0987654321zyxwvutsrqponmlkjihgfedcba'
          ]
        },
        {
          id: 'req_4',
          requestId: 4,
          requester: '5ETestDqcsdhBM8Y1s5eHMvx1tyDWRxf8LxbCQ8eW3Lw2Kk',
          requesterName: 'Jane Smith',
          institution: didAddress!,
          credentialType: "Master's Degree",
          programName: 'Master of Science in Data Science',
          fieldOfStudy: 'Data Science',
          startDate: '2022-09-01',
          endDate: '2024-05-15',
          studentId: 'STU789012',
          expectedGPA: '3.85',
          status: 'pending',
          createdAt: Date.now() - 5 * 24 * 60 * 60 * 1000,
          updatedAt: Date.now() - 5 * 24 * 60 * 60 * 1000,
        },
        {
          id: 'req_5',
          requestId: 5,
          requester: '5FTestDqcsdhBM8Y1s5eHMvx1tyDWRxf8LxbCQ8eW3Lw3Kk',
          requesterName: 'Bob Johnson',
          institution: didAddress!,
          credentialType: 'Certificate',
          programName: 'Full Stack Web Development Bootcamp',
          fieldOfStudy: 'Web Development',
          startDate: '2024-01-01',
          endDate: '2024-04-30',
          status: 'approved',
          createdAt: Date.now() - 20 * 24 * 60 * 60 * 1000,
          updatedAt: Date.now() - 10 * 24 * 60 * 60 * 1000,
          reviewedAt: Date.now() - 10 * 24 * 60 * 60 * 1000,
        },
      ];

      setReceivedRequests(mockRequests);
    } catch (error) {
      console.error('Failed to fetch requests:', error);
      toast.error('Failed to load requests');
    } finally {
      setLoading(false);
    }
  };

  const handleRefresh = async () => {
    setRefreshing(true);
    await fetchReceivedRequests();
    setRefreshing(false);
    toast.success('Requests refreshed');
  };

  const handleViewDetails = (request: CredentialRequest) => {
    setSelectedRequest(request);
    // Could open a detail-only modal
    toast.info('Opening request details...');
  };

  const handleReview = (request: CredentialRequest) => {
    setSelectedRequest(request);
    setShowReviewModal(true);
  };

  if (!isConnected || !hasDID) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardHeader>
            <CardTitle>Access Required</CardTitle>
            <CardDescription>
              {!isConnected 
                ? 'Please connect your wallet to view credential requests'
                : 'You need a DID to manage requests'
              }
            </CardDescription>
          </CardHeader>
        </Card>
      </div>
    );
  }

  if (!isInstitution) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardHeader>
            <div className="flex items-center space-x-2 text-red-600 mb-2">
              <AlertCircle className="h-5 w-5" />
              <CardTitle>Institution Access Required</CardTitle>
            </div>
            <CardDescription>
              Only verified institutions can access this page
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => navigate('/institution')} className="w-full">
              Register as Institution
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  const pendingCount = getPendingCount();

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold flex items-center">
            <FileText className="h-8 w-8 mr-3 text-primary" />
            Credential Requests
          </h1>
          <p className="text-muted-foreground mt-1">
            Review and approve student credential requests
          </p>
        </div>
        <div className="flex gap-2">
          <Button
            variant="outline"
            onClick={handleRefresh}
            disabled={refreshing}
          >
            <RefreshCw className={`h-4 w-4 mr-2 ${refreshing ? 'animate-spin' : ''}`} />
            Refresh
          </Button>
        </div>
      </div>

      {/* Pending Alert */}
      {pendingCount > 0 && (
        <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
          <div className="flex items-start space-x-3">
            <AlertCircle className="h-5 w-5 text-yellow-600 dark:text-yellow-500 flex-shrink-0 mt-0.5" />
            <div className="text-sm">
              <p className="font-semibold text-yellow-800 dark:text-yellow-400">
                {pendingCount} Request{pendingCount !== 1 ? 's' : ''} Awaiting Review
              </p>
              <p className="text-yellow-700 dark:text-yellow-300 mt-1">
                Students are waiting for your response. Please review pending requests promptly.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Info Banner */}
      <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div className="flex items-start space-x-3">
          <FileText className="h-5 w-5 text-blue-600 dark:text-blue-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm">
            <p className="font-semibold text-blue-800 dark:text-blue-400">
              Review Guidelines
            </p>
            <ul className="text-blue-700 dark:text-blue-300 mt-2 space-y-1 list-disc list-inside">
              <li>Verify student information matches your records</li>
              <li>Check supporting documents carefully</li>
              <li>Provide clear rejection reasons if declining</li>
              <li>Approved requests can be fulfilled immediately</li>
            </ul>
          </div>
        </div>
      </div>

      {/* Requests List */}
      <RequestsList
        requests={receivedRequests}
        loading={loading}
        emptyMessage="No credential requests received yet"
        viewMode="institution"
        onViewDetails={handleViewDetails}
        onReview={handleReview}
      />

      {/* Review Modal */}
      <ReviewRequestModal
        isOpen={showReviewModal}
        onClose={() => {
          setShowReviewModal(false);
          setSelectedRequest(null);
        }}
        request={selectedRequest}
      />
    </div>
  );
}
</file>

<file path="src/pages/Institutions.tsx">
// src/pages/Institutions.tsx
import { Card, CardHeader, CardTitle, CardDescription } from '@/components/ui/Card';
import { Badge } from '@/components/ui/Badge';

export default function Institutions() {
  return (
    <div className="space-y-6">
      <h1 className="text-3xl font-bold">Institutions</h1>
      <Card>
        <CardHeader>
          <div className="flex items-center justify-between">
            <div>
              <CardTitle>Institution Directory</CardTitle>
              <CardDescription>
                Browse verified academic institutions
              </CardDescription>
            </div>
            <Badge variant="success">0 Verified</Badge>
          </div>
        </CardHeader>
      </Card>
    </div>
  );
}
</file>

<file path="src/pages/IssueCredential.tsx">
import { useNavigate } from 'react-router-dom';
import { useDIDStore } from '@/store/did.store';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/Card';
import { Button } from '@/components/ui/Button';
import { AlertCircle, ArrowLeft } from 'lucide-react';
import { lazy, Suspense, useEffect } from 'react';
import { Spinner } from '@/components/ui/Spinner';

// Lazy load the form component to prevent blocking the app
const IssueCredentialForm = lazy(() => import('@/components/credentials/IssueCredentialForm'));

export default function IssueCredential() {
  const navigate = useNavigate();
  const { isInstitution, hasDID } = useDIDStore();

  const handleSuccess = (credentialId: string) => {
    // Navigate to institution page after success
    navigate('/institution');
  };

  const handleCancel = () => {
    navigate('/institution');
  };

  // Check if user has DID
  if (!hasDID) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardHeader>
            <div className="flex items-center space-x-2 text-yellow-600 mb-2">
              <AlertCircle className="h-5 w-5" />
              <CardTitle>DID Required</CardTitle>
            </div>
            <CardDescription>
              You need to create a Decentralized Identifier (DID) before you can issue credentials.
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => navigate('/dashboard')} className="w-full">
              Create DID
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Check if user is an institution
  if (!isInstitution) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardHeader>
            <div className="flex items-center space-x-2 text-red-600 mb-2">
              <AlertCircle className="h-5 w-5" />
              <CardTitle>Institution Access Required</CardTitle>
            </div>
            <CardDescription>
              Only verified institutions can issue credentials. Please register as an institution first.
            </CardDescription>
          </CardHeader>
          <CardContent className="space-y-3">
            <Button onClick={() => navigate('/institution')} className="w-full">
              Register as Institution
            </Button>
            <Button onClick={() => navigate('/dashboard')} variant="outline" className="w-full">
              <ArrowLeft className="h-4 w-4 mr-2" />
              Back to Dashboard
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="py-8">
      <Suspense 
        fallback={
          <div className="flex items-center justify-center min-h-[60vh]">
            <div className="text-center">
              <Spinner size="lg" className="mx-auto mb-4" />
              <p className="text-muted-foreground">Loading form...</p>
            </div>
          </div>
        }
      >
        <IssueCredentialForm 
          onSuccess={handleSuccess}
          onCancel={handleCancel}
        />
      </Suspense>
    </div>
  );
}
</file>

<file path="src/pages/IssuedCredentials.tsx">
// src/pages/IssuedCredentials.tsx
import { useState, useEffect } from 'react';
import { useDIDStore } from '@/store/did.store';
import { useNavigate } from 'react-router-dom';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/Card';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { Badge } from '@/components/ui/Badge';
import { 
  FileText, 
  Search, 
  Plus,
  Download,
  Eye,
  XCircle,
  Calendar,
  User,
  Loader2,
  RefreshCw,
  AlertCircle
} from 'lucide-react';
import { toast } from 'sonner';
import { useBlockchain } from '@/hooks/blockchain/useBlockchain';
import { formatCredentialType } from '@/lib/blockchain/integration';

interface IssuedCredential {
  id: string;
  holder: string;
  holderName?: string;
  credentialType: string;
  degreeName: string;
  fieldOfStudy?: string;
  issuedAt: number;
  status: 'active' | 'revoked';
  credentialHash: string;
}

export default function IssuedCredentials() {
  const navigate = useNavigate();
  const { isInstitution, didAddress } = useDIDStore();
  const { queries, isReady, transactions, account } = useBlockchain();
  
  const [credentials, setCredentials] = useState<IssuedCredential[]>([]);
  const [loading, setLoading] = useState(true);
  const [searchQuery, setSearchQuery] = useState('');
  const [filterStatus, setFilterStatus] = useState<'all' | 'active' | 'revoked'>('all');
  const [refreshing, setRefreshing] = useState(false);
  const [revoking, setRevoking] = useState<string | null>(null);

  useEffect(() => {
    if (!isInstitution) {
      navigate('/institution');
      return;
    }

    if (isReady && queries && didAddress) {
      fetchIssuedCredentials();
    }
  }, [isInstitution, isReady, queries, didAddress]);

  const fetchIssuedCredentials = async () => {
    if (!queries || !didAddress) {
      console.log('Missing queries or didAddress');
      return;
    }

    setLoading(true);
    try {
      console.log(' Fetching issued credentials for institution:', didAddress);
      
      // Fetch credentials issued by this institution from blockchain
      const blockchainCredentials = await queries.credential.getCredentialsByIssuer(didAddress);
      
      console.log(' Fetched issued credentials:', blockchainCredentials);
      
      if (blockchainCredentials.length === 0) {
        console.log(' No credentials issued yet');
        setCredentials([]);
        setLoading(false);
        return;
      }

      // Process credentials and format for display
      const processedCredentials: IssuedCredential[] = blockchainCredentials.map((cred) => {
        const metadata = parseMetadata(cred.metadata);
        
        return {
          id: cred.id,
          holder: cred.holder,
          holderName: undefined, // We'll fetch this if needed
          credentialType: formatCredentialType(cred.credentialType),
          degreeName: metadata.degreeName || 'Academic Credential',
          fieldOfStudy: metadata.fieldOfStudy,
          issuedAt: cred.issuedAt,
          status: cred.revoked ? 'revoked' : 'active',
          credentialHash: cred.credentialHash,
        } as IssuedCredential;
      });

      console.log(' Processed credentials:', processedCredentials);
      setCredentials(processedCredentials);
      
      if (processedCredentials.length > 0) {
        toast.success(`Found ${processedCredentials.length} issued credential(s)`);
      }
    } catch (error: any) {
      console.error(' Failed to fetch issued credentials:', error);
      toast.error('Failed to load credentials', {
        description: error.message || 'Check console for details',
      });
    } finally {
      setLoading(false);
    }
  };

  const handleRefresh = async () => {
    setRefreshing(true);
    await fetchIssuedCredentials();
    setRefreshing(false);
    toast.success('Credentials refreshed');
  };

  const handleRevoke = async (credentialId: string) => {
    if (!confirm('Are you sure you want to revoke this credential? This action cannot be undone.')) {
      return;
    }

    if (!transactions || !account) {
      toast.error('Wallet not connected');
      return;
    }

    setRevoking(credentialId);

    try {
      console.log(' Revoking credential:', credentialId);
      
      const result = await transactions.credential.revokeCredential(
        account,
        credentialId,
        (status) => {
          console.log('Transaction status:', status);
          if (status.status === 'signing') {
            toast.info('Please sign the transaction');
          }
        }
      );

      if (result.success) {
        console.log(' Credential revoked successfully');
        
        // Update local state
        setCredentials(prev =>
          prev.map(cred =>
            cred.id === credentialId ? { ...cred, status: 'revoked' as const } : cred
          )
        );
        
        toast.success('Credential revoked successfully');
      } else {
        throw new Error(result.error || 'Transaction failed');
      }
    } catch (error: any) {
      console.error(' Failed to revoke credential:', error);
      toast.error('Failed to revoke credential', {
        description: error.message || 'Please try again',
      });
    } finally {
      setRevoking(null);
    }
  };

  // Helper function to parse metadata
  function parseMetadata(metadata?: string): Record<string, any> {
    if (!metadata) return {};
    try {
      return JSON.parse(metadata);
    } catch {
      return { text: metadata };
    }
  }

  const filteredCredentials = credentials.filter(cred => {
    const matchesSearch = !searchQuery || 
      cred.degreeName.toLowerCase().includes(searchQuery.toLowerCase()) ||
      cred.holderName?.toLowerCase().includes(searchQuery.toLowerCase()) ||
      cred.holder.toLowerCase().includes(searchQuery.toLowerCase()) ||
      cred.fieldOfStudy?.toLowerCase().includes(searchQuery.toLowerCase());
    
    const matchesStatus = filterStatus === 'all' || cred.status === filterStatus;
    
    return matchesSearch && matchesStatus;
  });

  const stats = {
    total: credentials.length,
    active: credentials.filter(c => c.status === 'active').length,
    revoked: credentials.filter(c => c.status === 'revoked').length,
  };

  // Not an institution - redirect
  if (!isInstitution) {
    return null;
  }

  // Blockchain not ready
  if (!isReady) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardContent className="py-12 text-center">
            <Loader2 className="h-8 w-8 animate-spin mx-auto mb-3 text-primary" />
            <p className="text-muted-foreground">Connecting to blockchain...</p>
            <p className="text-xs text-muted-foreground mt-2">
              Make sure your local node is running
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold flex items-center">
            <FileText className="h-8 w-8 mr-3 text-primary" />
            Issued Credentials
          </h1>
          <p className="text-muted-foreground mt-1">
            Manage credentials issued by your institution
          </p>
        </div>
        <div className="flex gap-2">
          <Button
            variant="outline"
            onClick={handleRefresh}
            disabled={refreshing || loading}
          >
            <RefreshCw className={`h-4 w-4 mr-2 ${refreshing ? 'animate-spin' : ''}`} />
            Refresh
          </Button>
          <Button onClick={() => navigate('/institution/issue')}>
            <Plus className="h-4 w-4 mr-2" />
            Issue Credential
          </Button>
        </div>
      </div>

      {/* Connection Status */}
      <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div className="flex items-start space-x-3">
          <FileText className="h-5 w-5 text-blue-600 dark:text-blue-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm flex-1">
            <p className="font-semibold text-blue-800 dark:text-blue-400">
              Connected to Blockchain
            </p>
            <p className="text-blue-700 dark:text-blue-300 mt-1">
              All credentials are fetched directly from the blockchain. 
              Your DID: <code className="text-xs font-mono">{didAddress?.slice(0, 10)}...{didAddress?.slice(-8)}</code>
            </p>
          </div>
        </div>
      </div>

      {/* Stats */}
      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
        <Card>
          <CardContent className="pt-6">
            <div className="text-2xl font-bold">{stats.total}</div>
            <p className="text-sm text-muted-foreground">Total Issued</p>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="text-2xl font-bold text-green-600">{stats.active}</div>
            <p className="text-sm text-muted-foreground">Active</p>
          </CardContent>
        </Card>
        <Card>
          <CardContent className="pt-6">
            <div className="text-2xl font-bold text-red-600">{stats.revoked}</div>
            <p className="text-sm text-muted-foreground">Revoked</p>
          </CardContent>
        </Card>
      </div>

      {/* Filters */}
      <Card>
        <CardContent className="pt-6">
          <div className="flex flex-col sm:flex-row gap-4">
            <div className="flex-1">
              <div className="relative">
                <Search className="absolute left-3 top-1/2 -translate-y-1/2 h-4 w-4 text-muted-foreground" />
                <Input
                  placeholder="Search by degree name, holder..."
                  value={searchQuery}
                  onChange={(e) => setSearchQuery(e.target.value)}
                  className="pl-10"
                />
              </div>
            </div>
            
            <div className="flex gap-2">
              <Button
                variant={filterStatus === 'all' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setFilterStatus('all')}
              >
                All ({stats.total})
              </Button>
              <Button
                variant={filterStatus === 'active' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setFilterStatus('active')}
              >
                Active ({stats.active})
              </Button>
              <Button
                variant={filterStatus === 'revoked' ? 'default' : 'outline'}
                size="sm"
                onClick={() => setFilterStatus('revoked')}
              >
                Revoked ({stats.revoked})
              </Button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Credentials List */}
      {loading ? (
        <Card>
          <CardContent className="py-12 text-center">
            <Loader2 className="h-8 w-8 animate-spin mx-auto mb-3 text-primary" />
            <p className="text-muted-foreground">Loading credentials from blockchain...</p>
          </CardContent>
        </Card>
      ) : filteredCredentials.length === 0 ? (
        <Card>
          <CardContent className="py-12 text-center">
            <FileText className="h-12 w-12 mx-auto mb-3 text-muted-foreground opacity-50" />
            <p className="text-lg font-medium mb-1">
              {searchQuery || filterStatus !== 'all'
                ? 'No credentials match your filters'
                : 'No credentials issued yet'
              }
            </p>
            <p className="text-sm text-muted-foreground">
              {searchQuery || filterStatus !== 'all'
                ? 'Try adjusting your search or filters'
                : 'Start by issuing your first credential'
              }
            </p>
            {!searchQuery && filterStatus === 'all' && (
              <Button
                onClick={() => navigate('/institution/issue')}
                className="mt-4"
              >
                <Plus className="h-4 w-4 mr-2" />
                Issue First Credential
              </Button>
            )}
          </CardContent>
        </Card>
      ) : (
        <div className="space-y-4">
          {filteredCredentials.map((credential) => (
            <Card key={credential.id}>
              <CardContent className="pt-6">
                <div className="flex items-start justify-between">
                  <div className="flex-1 min-w-0">
                    <div className="flex items-center space-x-2 mb-2">
                      <h3 className="text-lg font-semibold truncate">
                        {credential.degreeName}
                      </h3>
                      <Badge variant={credential.status === 'active' ? 'success' : 'error'}>
                        {credential.status === 'active' ? 'Active' : 'Revoked'}
                      </Badge>
                      <Badge variant="outline">{credential.credentialType}</Badge>
                    </div>
                    
                    {credential.fieldOfStudy && (
                      <p className="text-sm text-muted-foreground mb-2">
                        {credential.fieldOfStudy}
                      </p>
                    )}
                    
                    <div className="space-y-1 text-sm">
                      <div className="flex items-center text-muted-foreground">
                        <User className="h-3 w-3 mr-2" />
                        <span>
                          {credential.holderName || 'Holder'} 
                          <code className="ml-2 text-xs">
                            {credential.holder.slice(0, 8)}...{credential.holder.slice(-6)}
                          </code>
                        </span>
                      </div>
                      
                      <div className="flex items-center text-muted-foreground">
                        <Calendar className="h-3 w-3 mr-2" />
                        <span>
                          Issued {new Date(credential.issuedAt).toLocaleDateString()}
                        </span>
                      </div>
                    </div>
                  </div>

                  <div className="flex flex-col sm:flex-row gap-2 ml-4">
                    <Button 
                      variant="outline" 
                      size="sm"
                      onClick={() => window.open(`/verify?hash=${credential.credentialHash}`, '_blank')}
                    >
                      <Eye className="h-3 w-3 mr-1" />
                      View
                    </Button>
                    
                    {credential.status === 'active' && (
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => handleRevoke(credential.id)}
                        disabled={revoking === credential.id}
                        className="text-red-600 hover:text-red-700"
                      >
                        {revoking === credential.id ? (
                          <>
                            <Loader2 className="h-3 w-3 mr-1 animate-spin" />
                            Revoking...
                          </>
                        ) : (
                          <>
                            <XCircle className="h-3 w-3 mr-1" />
                            Revoke
                          </>
                        )}
                      </Button>
                    )}
                  </div>
                </div>
              </CardContent>
            </Card>
          ))}
        </div>
      )}
    </div>
  );
}
</file>

<file path="src/pages/MyRequests.tsx">
// src/pages/MyRequests.tsx - FIXED WITH REAL BLOCKCHAIN DATA
import { useEffect, useState } from 'react';
import { useNavigate } from 'react-router-dom';
import { Plus, FileText, RefreshCw, Loader2, AlertCircle } from 'lucide-react';
import { Button } from '@/components/ui/Button';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/Card';
import { Modal } from '@/components/ui/Modal';
import RequestsList from '@/components/requests/RequestsList';
import CreateRequestForm from '@/components/requests/CreateRequestForm';
import { useWalletStore } from '@/store/wallet.store';
import { useDIDStore } from '@/store/did.store';
import { useCredentialRequestsStore } from '@/store/credentialRequests.store';
import { useBlockchain } from '@/hooks/blockchain/useBlockchain';
import type { CredentialRequest } from '@/types/credentialRequest.types';
import { toast } from 'sonner';

export default function MyRequests() {
  const navigate = useNavigate();
  const { isConnected } = useWalletStore();
  const { hasDID, didAddress } = useDIDStore();
  const { queries, isReady } = useBlockchain();
  const { 
    myRequests, 
    setMyRequests, 
    loading, 
    setLoading 
  } = useCredentialRequestsStore();
  
  const [showCreateModal, setShowCreateModal] = useState(false);
  const [selectedRequest, setSelectedRequest] = useState<CredentialRequest | null>(null);
  const [showDetailModal, setShowDetailModal] = useState(false);
  const [refreshing, setRefreshing] = useState(false);
  const [fetchError, setFetchError] = useState<string | null>(null);

  useEffect(() => {
    if (isConnected && hasDID && didAddress && isReady && queries) {
      fetchMyRequests();
    }
  }, [isConnected, hasDID, didAddress, isReady, queries]);

  const fetchMyRequests = async () => {
    if (!queries || !didAddress) {
      console.log(' Missing queries or didAddress');
      return;
    }

    setLoading(true);
    setFetchError(null);

    try {
      console.log(' Fetching credential requests for:', didAddress);
      
      // Note: Since your pallets don't have a credential request system yet,
      // we'll need to add this functionality to your runtime
      // For now, this will return empty array until you add the request pallet
      
      // TODO: Add a credential request pallet to your runtime with:
      // - RequestsByRequester storage map
      // - Request struct with status, dates, etc.
      
      // Placeholder: Check if your API has the credential request query
      const api = queries.api;
      
      if (!api) {
        throw new Error('API not available');
      }

      // Check if credential request pallet exists
      // @ts-ignore - Dynamic pallet check
      if (!api.query.credentialRequest) {
        console.warn(' Credential request pallet not found in runtime');
        toast.info('Credential request feature not yet deployed', {
          description: 'This feature requires the request pallet to be added to the runtime',
        });
        setMyRequests([]);
        setLoading(false);
        return;
      }

      // If pallet exists, query requests
      // @ts-ignore - Dynamic pallet query
      const requestsData = await api.query.credentialRequest.requestsByRequester(didAddress);
      
      if (requestsData.isEmpty) {
        console.log(' No requests found for this user');
        setMyRequests([]);
        setLoading(false);
        return;
      }

      const requestsList = requestsData.toJSON() as any[];
      console.log(' Found requests:', requestsList);

      // Fetch institution names for each request
      const requestsWithDetails = await Promise.all(
        requestsList.map(async (req) => {
          try {
            const institution = await queries.did.getInstitution(req.institution);
            
            return {
              id: req.requestId.toString(),
              requestId: req.requestId,
              requester: req.requester,
              institution: req.institution,
              institutionName: institution?.name,
              credentialType: formatCredentialType(req.credentialType),
              programName: req.programName,
              fieldOfStudy: req.fieldOfStudy,
              startDate: req.startDate,
              endDate: req.endDate,
              major: req.major,
              minor: req.minor,
              expectedGPA: req.expectedGPA,
              studentId: req.studentId,
              expectedGraduationDate: req.expectedGraduationDate,
              additionalNotes: req.additionalNotes,
              supportingDocuments: req.supportingDocuments,
              status: mapRequestStatus(req.status),
              createdAt: req.createdAt,
              updatedAt: req.updatedAt,
              reviewedAt: req.reviewedAt,
              rejectionReason: req.rejectionReason,
            } as CredentialRequest;
          } catch (error) {
            console.error('Error processing request:', error);
            return null;
          }
        })
      );

      const validRequests = requestsWithDetails.filter(r => r !== null) as CredentialRequest[];
      console.log(' Processed requests:', validRequests);
      
      setMyRequests(validRequests);
      
      if (validRequests.length > 0) {
        toast.success(`Found ${validRequests.length} request(s)`);
      }
    } catch (error: any) {
      console.error(' Failed to fetch requests:', error);
      setFetchError(error.message || 'Failed to fetch requests');
      
      // Show helpful error message
      if (error.message?.includes('credentialRequest')) {
        toast.info('Feature coming soon', {
          description: 'Credential requests will be available once the request pallet is deployed',
        });
      } else {
        toast.error('Failed to load requests', {
          description: 'Check console for details',
        });
      }
      
      setMyRequests([]);
    } finally {
      setLoading(false);
    }
  };

  // Helper to format credential type from blockchain enum
  const formatCredentialType = (type: any): string => {
    const typeMap: Record<string, string> = {
      Degree: "Bachelor's Degree",
      MastersDegree: "Master's Degree",
      Doctorate: "Doctorate (PhD)",
      Certificate: "Certificate",
      Transcript: "Transcript",
      ProfessionalCertification: "Professional Certification",
      Other: "Other",
    };

    if (typeof type === 'string') {
      return typeMap[type] || type;
    }

    if (typeof type === 'object') {
      const key = Object.keys(type)[0];
      return typeMap[key] || key;
    }

    return 'Unknown';
  };

  // Helper to map blockchain status to UI status
  const mapRequestStatus = (status: any): CredentialRequest['status'] => {
    if (typeof status === 'string') {
      return status.toLowerCase() as CredentialRequest['status'];
    }
    
    if (typeof status === 'object') {
      const key = Object.keys(status)[0].toLowerCase();
      return key as CredentialRequest['status'];
    }
    
    return 'pending';
  };

  const handleRefresh = async () => {
    setRefreshing(true);
    await fetchMyRequests();
    setRefreshing(false);
    toast.success('Requests refreshed');
  };

  const handleViewDetails = (request: CredentialRequest) => {
    setSelectedRequest(request);
    setShowDetailModal(true);
  };

  const handleCreateSuccess = async () => {
    setShowCreateModal(false);
    // Wait a moment for the transaction to finalize
    await new Promise(resolve => setTimeout(resolve, 2000));
    await fetchMyRequests();
  };

  // Not connected
  if (!isConnected || !hasDID) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardHeader>
            <div className="flex items-center space-x-2 text-yellow-600 mb-2">
              <AlertCircle className="h-5 w-5" />
              <CardTitle>Access Required</CardTitle>
            </div>
            <CardDescription>
              {!isConnected 
                ? 'Please connect your wallet to view credential requests'
                : 'You need a DID to request credentials'
              }
            </CardDescription>
          </CardHeader>
          <CardContent>
            <Button onClick={() => navigate('/dashboard')} className="w-full">
              {!isConnected ? 'Connect Wallet' : 'Create DID'}
            </Button>
          </CardContent>
        </Card>
      </div>
    );
  }

  // Blockchain not ready
  if (!isReady) {
    return (
      <div className="flex items-center justify-center min-h-[60vh]">
        <Card className="max-w-md">
          <CardContent className="py-12 text-center">
            <Loader2 className="h-8 w-8 animate-spin mx-auto mb-3 text-primary" />
            <p className="text-muted-foreground">Connecting to blockchain...</p>
            <p className="text-xs text-muted-foreground mt-2">
              Make sure your local node is running
            </p>
          </CardContent>
        </Card>
      </div>
    );
  }

  return (
    <div className="space-y-6">
      {/* Header */}
      <div className="flex items-center justify-between">
        <div>
          <h1 className="text-3xl font-bold flex items-center">
            <FileText className="h-8 w-8 mr-3 text-primary" />
            My Requests
          </h1>
          <p className="text-muted-foreground mt-1">
            Track your credential requests to institutions (fetched from blockchain)
          </p>
        </div>
        <div className="flex gap-2">
          <Button
            variant="outline"
            onClick={handleRefresh}
            disabled={refreshing || loading}
          >
            <RefreshCw className={`h-4 w-4 mr-2 ${refreshing ? 'animate-spin' : ''}`} />
            Refresh
          </Button>
          <Button onClick={() => setShowCreateModal(true)}>
            <Plus className="h-4 w-4 mr-2" />
            New Request
          </Button>
        </div>
      </div>

      {/* Connection Status */}
      <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div className="flex items-start space-x-3">
          <FileText className="h-5 w-5 text-blue-600 dark:text-blue-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm flex-1">
            <p className="font-semibold text-blue-800 dark:text-blue-400">
              {isReady ? 'Connected to Blockchain' : 'Connecting...'}
            </p>
            <p className="text-blue-700 dark:text-blue-300 mt-1">
              All requests are fetched directly from the blockchain. 
              Your DID: <code className="text-xs font-mono">{didAddress?.slice(0, 10)}...{didAddress?.slice(-8)}</code>
            </p>
          </div>
        </div>
      </div>

      {/* Feature Status Warning */}
      {fetchError?.includes('credentialRequest') && (
        <div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-200 dark:border-yellow-800 rounded-lg p-4">
          <div className="flex items-start space-x-3">
            <AlertCircle className="h-5 w-5 text-yellow-600 dark:text-yellow-500 flex-shrink-0 mt-0.5" />
            <div className="text-sm">
              <p className="font-semibold text-yellow-800 dark:text-yellow-400">
                Feature Coming Soon
              </p>
              <p className="text-yellow-700 dark:text-yellow-300 mt-1">
                The credential request system requires adding a request pallet to your runtime. 
                Until then, students can still receive credentials directly from institutions.
              </p>
            </div>
          </div>
        </div>
      )}

      {/* Error Message */}
      {fetchError && !fetchError.includes('credentialRequest') && (
        <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
          <div className="flex items-start space-x-3">
            <AlertCircle className="h-5 w-5 text-red-600 dark:text-red-500 flex-shrink-0 mt-0.5" />
            <div className="text-sm flex-1">
              <p className="font-semibold text-red-800 dark:text-red-400">
                Error Loading Requests
              </p>
              <p className="text-red-700 dark:text-red-300 mt-1">
                {fetchError}
              </p>
              <Button 
                variant="outline" 
                size="sm" 
                onClick={handleRefresh}
                className="mt-2"
              >
                Try Again
              </Button>
            </div>
          </div>
        </div>
      )}

      {/* Info Banner */}
      <div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
        <div className="flex items-start space-x-3">
          <FileText className="h-5 w-5 text-blue-600 dark:text-blue-500 flex-shrink-0 mt-0.5" />
          <div className="text-sm">
            <p className="font-semibold text-blue-800 dark:text-blue-400">
              How It Works
            </p>
            <ul className="text-blue-700 dark:text-blue-300 mt-2 space-y-1 list-disc list-inside">
              <li>Submit a request to any verified institution</li>
              <li>The institution reviews your information</li>
              <li>If approved, they'll issue your credential</li>
              <li>Track all your requests in one place</li>
            </ul>
          </div>
        </div>
      </div>

      {/* Requests List */}
      <RequestsList
        requests={myRequests}
        loading={loading}
        emptyMessage={
          isReady 
            ? "You haven't submitted any requests yet. Requests will appear here once the request pallet is deployed."
            : "Waiting for blockchain connection..."
        }
        viewMode="student"
        onViewDetails={handleViewDetails}
      />

      {/* Create Request Modal */}
      <Modal
        isOpen={showCreateModal}
        onClose={() => setShowCreateModal(false)}
        className="max-w-4xl"
      >
        <CreateRequestForm
          onSuccess={handleCreateSuccess}
          onCancel={() => setShowCreateModal(false)}
        />
      </Modal>

      {/* Detail Modal */}
      <Modal
        isOpen={showDetailModal}
        onClose={() => setShowDetailModal(false)}
        className="max-w-2xl"
      >
        {selectedRequest && (
          <div className="p-6">
            <h2 className="text-2xl font-bold mb-4">Request Details</h2>
            <div className="space-y-4">
              <div>
                <label className="text-sm font-semibold text-muted-foreground">Program</label>
                <p className="text-lg">{selectedRequest.programName}</p>
              </div>
              <div>
                <label className="text-sm font-semibold text-muted-foreground">Institution</label>
                <p>{selectedRequest.institutionName || selectedRequest.institution}</p>
              </div>
              <div>
                <label className="text-sm font-semibold text-muted-foreground">Status</label>
                <p className="capitalize">{selectedRequest.status}</p>
              </div>
              {selectedRequest.rejectionReason && (
                <div className="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-3">
                  <p className="text-sm font-semibold text-red-800 dark:text-red-400">
                    Rejection Reason:
                  </p>
                  <p className="text-sm text-red-700 dark:text-red-300 mt-1">
                    {selectedRequest.rejectionReason}
                  </p>
                </div>
              )}
              {selectedRequest.additionalNotes && (
                <div>
                  <label className="text-sm font-semibold text-muted-foreground">Your Notes</label>
                  <p className="text-sm">{selectedRequest.additionalNotes}</p>
                </div>
              )}
            </div>
          </div>
        )}
      </Modal>
    </div>
  );
}
</file>

<file path="src/pages/Settings.tsx">
import { useState } from 'react';
import { Card, CardHeader, CardTitle, CardDescription, CardContent } from '@/components/ui/Card';
import { Button } from '@/components/ui/Button';
import { Input } from '@/components/ui/Input';
import { Badge } from '@/components/ui/Badge';
import { 
  User, 
  Bell, 
  Shield, 
  Palette, 
  Download,
  Trash2,
  Save,
  Moon,
  Sun,
  Monitor
} from 'lucide-react';
import { useWalletStore } from '@/store/wallet.store';
import { useDIDStore } from '@/store/did.store';
import { toast } from 'sonner';

export default function Settings() {
  const { account } = useWalletStore();
  const { didAddress } = useDIDStore();
  const [theme, setTheme] = useState<'light' | 'dark' | 'system'>('system');
  const [displayName, setDisplayName] = useState('');
  const [emailNotifications, setEmailNotifications] = useState(true);
  const [browserNotifications, setBrowserNotifications] = useState(false);

  const handleSaveProfile = () => {
    toast.success('Profile updated successfully');
  };

  const handleExportData = () => {
    const data = {
      account: account?.address,
      did: didAddress,
      exportedAt: new Date().toISOString(),
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'academic-verify-data.json';
    a.click();
    URL.revokeObjectURL(url);
    
    toast.success('Data exported successfully');
  };

  const handleClearCache = () => {
    localStorage.clear();
    toast.success('Cache cleared successfully');
  };

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      <div>
        <h1 className="text-3xl font-bold">Settings</h1>
        <p className="text-muted-foreground mt-1">
          Manage your account preferences and application settings
        </p>
      </div>

      {/* Profile Settings */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center">
            <User className="h-5 w-5 mr-2" />
            Profile
          </CardTitle>
          <CardDescription>
            Your public profile information
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <label className="block text-sm font-semibold mb-2">
              Display Name
            </label>
            <Input
              value={displayName}
              onChange={(e) => setDisplayName(e.target.value)}
              placeholder="Enter your display name"
            />
            <p className="text-xs text-muted-foreground mt-1">
              This name will be visible to other users
            </p>
          </div>

          <div>
            <label className="block text-sm font-semibold mb-2">
              DID Address
            </label>
            <Input
              value={didAddress || 'Not created yet'}
              readOnly
              className="font-mono text-sm"
            />
          </div>

          <div>
            <label className="block text-sm font-semibold mb-2">
              Wallet Address
            </label>
            <Input
              value={account?.address || 'Not connected'}
              readOnly
              className="font-mono text-sm"
            />
          </div>

          <Button onClick={handleSaveProfile}>
            <Save className="h-4 w-4 mr-2" />
            Save Profile
          </Button>
        </CardContent>
      </Card>

      {/* Appearance */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center">
            <Palette className="h-5 w-5 mr-2" />
            Appearance
          </CardTitle>
          <CardDescription>
            Customize how the application looks
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div>
            <label className="block text-sm font-semibold mb-3">
              Theme
            </label>
            <div className="grid grid-cols-3 gap-3">
              <button
                onClick={() => setTheme('light')}
                className={`p-4 border-2 rounded-lg flex flex-col items-center space-y-2 transition-colors ${
                  theme === 'light' ? 'border-primary bg-primary/5' : 'border-border hover:border-primary/50'
                }`}
              >
                <Sun className="h-6 w-6" />
                <span className="text-sm font-medium">Light</span>
              </button>
              
              <button
                onClick={() => setTheme('dark')}
                className={`p-4 border-2 rounded-lg flex flex-col items-center space-y-2 transition-colors ${
                  theme === 'dark' ? 'border-primary bg-primary/5' : 'border-border hover:border-primary/50'
                }`}
              >
                <Moon className="h-6 w-6" />
                <span className="text-sm font-medium">Dark</span>
              </button>
              
              <button
                onClick={() => setTheme('system')}
                className={`p-4 border-2 rounded-lg flex flex-col items-center space-y-2 transition-colors ${
                  theme === 'system' ? 'border-primary bg-primary/5' : 'border-border hover:border-primary/50'
                }`}
              >
                <Monitor className="h-6 w-6" />
                <span className="text-sm font-medium">System</span>
              </button>
            </div>
          </div>
        </CardContent>
      </Card>

      {/* Notifications */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center">
            <Bell className="h-5 w-5 mr-2" />
            Notifications
          </CardTitle>
          <CardDescription>
            Configure how you receive notifications
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <label className="flex items-center justify-between cursor-pointer">
            <div>
              <p className="font-medium">Email Notifications</p>
              <p className="text-sm text-muted-foreground">
                Receive updates via email
              </p>
            </div>
            <input
              type="checkbox"
              checked={emailNotifications}
              onChange={(e) => setEmailNotifications(e.target.checked)}
              className="h-5 w-5"
            />
          </label>

          <label className="flex items-center justify-between cursor-pointer">
            <div>
              <p className="font-medium">Browser Notifications</p>
              <p className="text-sm text-muted-foreground">
                Show notifications in your browser
              </p>
            </div>
            <input
              type="checkbox"
              checked={browserNotifications}
              onChange={(e) => setBrowserNotifications(e.target.checked)}
              className="h-5 w-5"
            />
          </label>
        </CardContent>
      </Card>

      {/* Privacy & Security */}
      <Card>
        <CardHeader>
          <CardTitle className="flex items-center">
            <Shield className="h-5 w-5 mr-2" />
            Privacy & Security
          </CardTitle>
          <CardDescription>
            Manage your data and security settings
          </CardDescription>
        </CardHeader>
        <CardContent className="space-y-4">
          <div className="flex items-center justify-between">
            <div>
              <p className="font-medium">Export Your Data</p>
              <p className="text-sm text-muted-foreground">
                Download all your account data
              </p>
            </div>
            <Button variant="outline" onClick={handleExportData}>
              <Download className="h-4 w-4 mr-2" />
              Export
            </Button>
          </div>

          <div className="flex items-center justify-between">
            <div>
              <p className="font-medium">Clear Cache</p>
              <p className="text-sm text-muted-foreground">
                Remove locally stored data
              </p>
            </div>
            <Button variant="outline" onClick={handleClearCache}>
              <Trash2 className="h-4 w-4 mr-2" />
              Clear
            </Button>
          </div>
        </CardContent>
      </Card>

      {/* About */}
      <Card>
        <CardHeader>
          <CardTitle>About</CardTitle>
        </CardHeader>
        <CardContent className="space-y-2 text-sm">
          <div className="flex justify-between">
            <span className="text-muted-foreground">Version</span>
            <span className="font-medium">1.0.0</span>
          </div>
          <div className="flex justify-between">
            <span className="text-muted-foreground">Chain</span>
            <Badge variant="outline">Academic Verify Network</Badge>
          </div>
          <div className="flex justify-between">
            <span className="text-muted-foreground">License</span>
            <span className="font-medium">MIT</span>
          </div>
        </CardContent>
      </Card>
    </div>
  );
}
</file>

<file path="src/pages/Verify.tsx">
// src/pages/Verify.tsx
import { useEffect, useState } from 'react';
import { useSearchParams } from 'react-router-dom';
import VerifyCredential from '@/components/credentials/VerifyCredential';
import { Shield } from 'lucide-react';

export default function Verify() {
  const [searchParams] = useSearchParams();
  const hashParam = searchParams.get('hash');

  return (
    <div className="max-w-4xl mx-auto space-y-6">
      {/* Page Header */}
      <div className="text-center">
        <div className="inline-flex items-center justify-center h-16 w-16 rounded-full bg-primary/10 mb-4">
          <Shield className="h-8 w-8 text-primary" />
        </div>
        <h1 className="text-3xl md:text-4xl font-bold mb-2">
          Verify Academic Credential
        </h1>
        <p className="text-muted-foreground max-w-2xl mx-auto">
          Instantly verify the authenticity of any academic credential issued on our blockchain.
          No account required.
        </p>
      </div>

      {/* Verification Component */}
      <VerifyCredential initialHash={hashParam || undefined} />

      {/* Trust Indicators */}
      <div className="mt-12 pt-8 border-t border-border">
        <p className="text-center text-sm text-muted-foreground mb-6">
          Trusted by institutions and employers worldwide
        </p>
        <div className="flex flex-wrap justify-center items-center gap-8 opacity-50">
          <div className="text-2xl font-bold">MIT</div>
          <div className="text-2xl font-bold">Stanford</div>
          <div className="text-2xl font-bold">Harvard</div>
          <div className="text-2xl font-bold">Oxford</div>
          <div className="text-2xl font-bold">Cambridge</div>
        </div>
      </div>
    </div>
  );
}
</file>

<file path="src/providers/PolkadotProvider.tsx">
import { createContext, useContext, useEffect, useState, ReactNode } from 'react';
import type { ApiPromise } from '@polkadot/api';
import { toast } from 'sonner';
import { CHAIN_CONFIG } from '@/lib/utils/constants';

interface PolkadotContextType {
  api: ApiPromise | null;
  isReady: boolean;
  error: string | null;
}

const PolkadotContext = createContext<PolkadotContextType>({
  api: null,
  isReady: false,
  error: null,
});

export const usePolkadotContext = () => useContext(PolkadotContext);

interface PolkadotProviderProps {
  children: ReactNode;
}

export function PolkadotProvider({ children }: PolkadotProviderProps) {
  const [api, setApi] = useState<ApiPromise | null>(null);
  const [isReady, setIsReady] = useState(false);
  const [error, setError] = useState<string | null>(null);

  useEffect(() => {
    let isMounted = true;
    let apiInstance: ApiPromise | null = null;

    async function initApi() {
      try {
        // Dynamic import to avoid build issues
        const { ApiPromise, WsProvider } = await import('@polkadot/api');
        
        console.log(' Connecting to blockchain...');
        console.log(' Endpoint:', CHAIN_CONFIG.WS_PROVIDER);
        
        const wsProvider = new WsProvider(CHAIN_CONFIG.WS_PROVIDER);
        
        // Connection timeout handler
        const timeout = setTimeout(() => {
          if (!isReady && isMounted) {
            console.warn(' Connection timeout - continuing without blockchain');
            setError('Could not connect to blockchain node (timeout)');
            toast.warning('Running in demo mode', {
              description: 'Connect to a node to enable blockchain features'
            });
          }
        }, 5000);

        // Create API instance
        apiInstance = await ApiPromise.create({ 
          provider: wsProvider,
          throwOnConnect: false,
        });

        clearTimeout(timeout);

        if (isMounted) {
          await apiInstance.isReady;
          setApi(apiInstance);
          setIsReady(true);
          console.log(' Connected to blockchain');
          toast.success('Connected to blockchain');
        }
      } catch (err) {
        console.error(' Blockchain connection error:', err);
        if (isMounted) {
          const errorMessage = err instanceof Error ? err.message : 'Failed to connect';
          setError(errorMessage);
          
          toast.info('Running in demo mode', {
            description: 'UI is functional, blockchain features disabled'
          });
        }
      }
    }

    // Delay initialization slightly to let UI render first
    const timer = setTimeout(() => {
      initApi();
    }, 1500);

    return () => {
      isMounted = false;
      clearTimeout(timer);
      if (apiInstance) {
        apiInstance.disconnect().catch(console.error);
      }
    };
  }, []);

  // Always render children, even if connection fails
  return (
    <PolkadotContext.Provider value={{ api, isReady, error }}>
      {children}
    </PolkadotContext.Provider>
  );
}
</file>

<file path="src/providers/WalletProvider.tsx">
// src/providers/WalletProvider.tsx - FIXED VERSION
import { createContext, useContext, ReactNode, useEffect } from 'react';
import { useWalletStore } from '@/store/wallet.store';
import { useDIDStore } from '@/store/did.store';
import { usePolkadotContext } from './PolkadotProvider';
import { toast } from 'sonner';
import { hexToString } from '@polkadot/util';

interface WalletContextType {
  enableWallet: () => Promise<void>;
  selectAccount: (address: string) => void;
}

const WalletContext = createContext<WalletContextType>({
  enableWallet: async () => {},
  selectAccount: () => {},
});

export const useWalletContext = () => useContext(WalletContext);

interface WalletProviderProps {
  children: ReactNode;
}

export function WalletProvider({ children }: WalletProviderProps) {
  const { api, isReady } = usePolkadotContext();
  
  // Check for previously connected wallet on mount
  useEffect(() => {
    const checkConnection = async () => {
      try {
        const { web3Enable, web3Accounts } = await import('@polkadot/extension-dapp');
        
        const extensions = await web3Enable('Academic Verify');
        
        if (extensions.length > 0) {
          const allAccounts = await web3Accounts();
          
          if (allAccounts.length > 0) {
            const savedAddress = localStorage.getItem('wallet_address');
            const account = savedAddress 
              ? allAccounts.find(acc => acc.address === savedAddress) || allAccounts[0]
              : allAccounts[0];
            
            useWalletStore.setState({
              isConnected: true,
              account: {
                address: account.address,
                name: account.meta.name as string | undefined,
                source: account.meta.source as string | undefined,
              },
              accounts: allAccounts.map(acc => ({
                address: acc.address,
                name: acc.meta.name as string | undefined,
                source: acc.meta.source as string | undefined,
              })),
            });

            if (isReady && api) {
              checkDIDOnBlockchain(account.address);
            }
          }
        }
      } catch (error) {
        console.log('No wallet extension found or not authorized');
      }
    };
    
    checkConnection();
  }, [isReady, api]);

  useEffect(() => {
    const { account } = useWalletStore.getState();
    if (isReady && api && account?.address) {
      checkDIDOnBlockchain(account.address);
    }
  }, [isReady, api]);

  // Helper function to decode hex-encoded institution names
  const decodeInstitutionName = (name: string | any): string => {
    try {
      // If it's already a string and doesn't start with 0x, return as-is
      if (typeof name === 'string' && !name.startsWith('0x')) {
        return name;
      }

      // If it's a hex string (starts with 0x)
      if (typeof name === 'string' && name.startsWith('0x')) {
        const decoded = hexToString(name);
        // Remove any null bytes
        return decoded.replace(/\0/g, '');
      }

      // If it's a Uint8Array or array-like
      if (name && (name instanceof Uint8Array || Array.isArray(name))) {
        const nameStr = String.fromCharCode(...Array.from(name));
        return nameStr.replace(/\0/g, '');
      }

      // Fallback
      return String(name);
    } catch (error) {
      console.error('Error decoding institution name:', error);
      return String(name);
    }
  };

  const checkDIDOnBlockchain = async (address: string) => {
    if (!api || !isReady) return;

    try {
      console.log(' Checking for existing DID on blockchain for:', address);

      const didDoc = await api.query.did?.didDocuments(address);
      
      if (didDoc && !didDoc.isEmpty) {
        const didData = didDoc.toJSON() as any;
        console.log(' Found existing DID on blockchain:', didData);

        const publicKeys = didData.publicKeys?.map((key: any, index: number) => ({
          id: key.keyId || `key_${index}`,
          keyType: key.keyType || 'Ed25519',
          publicKey: key.publicKey || '',
          addedAt: didData.createdAt || Date.now(),
        })) || [];

        useDIDStore.getState().setDID(address, publicKeys);
        useDIDStore.getState().setStatus(didData.active ? 'active' : 'inactive');

        // Check if this is an institution
        const institution = await api.query.did?.institutions(address);
        if (institution && !institution.isEmpty) {
          const instData = institution.toJSON() as any;
          console.log(' Found institution data (raw):', instData);
          
          // Decode the institution name properly
          const decodedName = decodeInstitutionName(instData.name);
          console.log(' Decoded institution name:', decodedName);
          
          useDIDStore.getState().setInstitution(decodedName);
          
          toast.success('Institution loaded', {
            description: `Welcome back, ${decodedName}`,
          });
        } else {
          toast.success('DID loaded from blockchain', {
            description: `Found your existing DID: ${address.slice(0, 8)}...`,
          });
        }
      } else {
        console.log(' No DID found on blockchain for this address');
        
        const localDID = useDIDStore.getState();
        if (localDID.didAddress === address && localDID.hasDID) {
          console.log(' Using DID from local storage');
          toast.info('Using locally stored DID', {
            description: 'Blockchain connection unavailable',
          });
        } else {
          useDIDStore.getState().clearDID();
        }
      }
    } catch (error) {
      console.error(' Error checking DID on blockchain:', error);
      
      const localDID = useDIDStore.getState();
      if (localDID.didAddress === address && localDID.hasDID) {
        console.log(' Using DID from local storage (blockchain query failed)');
      }
    }
  };

  const enableWallet = async () => {
    try {
      const { web3Accounts, web3Enable } = await import('@polkadot/extension-dapp');
      
      console.log(' Attempting to connect to wallet extension...');
      
      const extensions = await web3Enable('Academic Verify');
      
      if (extensions.length === 0) {
        toast.error('No wallet extension found', {
          description: 'Please install Polkadot.js, Talisman, or SubWallet extension',
          duration: 5000,
        });
        
        setTimeout(() => {
          window.open('https://polkadot.js.org/extension/', '_blank');
        }, 1000);
        return;
      }

      console.log(` Found ${extensions.length} wallet extension(s)`);

      const allAccounts = await web3Accounts();
      
      if (allAccounts.length === 0) {
        toast.error('No accounts found', {
          description: 'Please create an account in your wallet extension',
          duration: 5000,
        });
        return;
      }

      console.log(` Found ${allAccounts.length} account(s)`);

      const account = allAccounts[0];
      
      localStorage.setItem('wallet_address', account.address);
      
      useWalletStore.setState({
        isConnected: true,
        account: {
          address: account.address,
          name: account.meta.name as string | undefined,
          source: account.meta.source as string | undefined,
        },
        accounts: allAccounts.map(acc => ({
          address: acc.address,
          name: acc.meta.name as string | undefined,
          source: acc.meta.source as string | undefined,
        })),
      });

      toast.success('Wallet connected', {
        description: `Connected to ${account.meta.name || 'account'}`,
      });

      if (isReady && api) {
        await checkDIDOnBlockchain(account.address);
      }
    } catch (error) {
      console.error('Failed to enable wallet:', error);
      
      if (error instanceof Error) {
        if (error.message.includes('Rejected')) {
          toast.error('Connection rejected', {
            description: 'Please approve the connection request in your wallet',
          });
        } else if (error.message.includes('pending authorization')) {
          toast.warning('Authorization pending', {
            description: 'Please check your wallet extension',
          });
        } else {
          toast.error('Failed to connect wallet', {
            description: error.message,
          });
        }
      } else {
        toast.error('Failed to connect wallet', {
          description: 'Please make sure your wallet extension is unlocked',
        });
      }
    }
  };

  const selectAccount = (address: string) => {
    const { accounts } = useWalletStore.getState();
    const account = accounts.find(acc => acc.address === address);
    
    if (account) {
      localStorage.setItem('wallet_address', address);
      useWalletStore.setState({ account });
      toast.success('Account switched', {
        description: `Switched to ${account.name || address.slice(0, 8) + '...'}`,
      });

      if (isReady && api) {
        checkDIDOnBlockchain(address);
      }
    }
  };

  return (
    <WalletContext.Provider value={{ enableWallet, selectAccount }}>
      {children}
    </WalletContext.Provider>
  );
}
</file>

<file path="src/store/credentialRequests.store.ts">
// src/store/credentialRequests.store.ts
import { create } from 'zustand';
import type { CredentialRequest, RequestStatus } from '@/types/credentialRequest.types';

interface CredentialRequestsState {
  myRequests: CredentialRequest[];
  receivedRequests: CredentialRequest[];
  loading: boolean;

  setMyRequests: (requests: CredentialRequest[]) => void;
  setReceivedRequests: (requests: CredentialRequest[]) => void;
  addRequest: (request: CredentialRequest) => void;
  updateRequest: (id: string, updates: Partial<CredentialRequest>) => void;
  removeRequest: (id: string) => void;
  setLoading: (loading: boolean) => void;

  // Helper methods
  getPendingCount: () => number;
  getRequestById: (id: string) => CredentialRequest | undefined;
  getRequestsByStatus: (status: RequestStatus) => CredentialRequest[];
}

export const useCredentialRequestsStore = create<CredentialRequestsState>((set, get) => ({
  myRequests: [],
  receivedRequests: [],
  loading: false,

  setMyRequests: (requests) => {
    set({ myRequests: requests });
  },

  setReceivedRequests: (requests) => {
    set({ receivedRequests: requests });
  },

  addRequest: (request) => {
    set((state) => ({
      myRequests: [...state.myRequests, request],
    }));
  },

  updateRequest: (id, updates) => {
    set((state) => ({
      myRequests: state.myRequests.map((req) =>
        req.id === id ? { ...req, ...updates, updatedAt: Date.now() } : req
      ),
      receivedRequests: state.receivedRequests.map((req) =>
        req.id === id ? { ...req, ...updates, updatedAt: Date.now() } : req
      ),
    }));
  },

  removeRequest: (id) => {
    set((state) => ({
      myRequests: state.myRequests.filter((req) => req.id !== id),
      receivedRequests: state.receivedRequests.filter((req) => req.id !== id),
    }));
  },

  setLoading: (loading) => {
    set({ loading });
  },

  getPendingCount: () => {
    return get().receivedRequests.filter((req) => req.status === 'pending').length;
  },

  getRequestById: (id) => {
    const state = get();
    return state.myRequests.find((req) => req.id === id) ||
           state.receivedRequests.find((req) => req.id === id);
  },

  getRequestsByStatus: (status) => {
    const state = get();
    return [...state.myRequests, ...state.receivedRequests].filter(
      (req) => req.status === status
    );
  },
}));
</file>

<file path="src/store/credentials.store.ts">
// credentials.store.ts
import { create } from 'zustand';

interface Credential {
  id: string;
  holder: string;
  issuer: string;
  credentialHash: string;
  credentialType: string;
  issuedAt: number;
  expiresAt?: number;
  revoked: boolean;
  metadata?: string;
}

interface CredentialsState {
  credentials: Credential[];
  issuedCredentials: Credential[];
  loading: boolean;
  addCredential: (credential: Credential) => void;
  removeCredential: (id: string) => void;
  setCredentials: (credentials: Credential[]) => void;
  setIssuedCredentials: (credentials: Credential[]) => void;
  setLoading: (loading: boolean) => void;
}

export const useCredentialsStore = create<CredentialsState>((set) => ({
  credentials: [],
  issuedCredentials: [],
  loading: false,

  addCredential: (credential) => {
    set((state) => ({
      credentials: [...state.credentials, credential],
    }));
  },

  removeCredential: (id) => {
    set((state) => ({
      credentials: state.credentials.filter((c) => c.id !== id),
    }));
  },

  setCredentials: (credentials) => {
    set({ credentials });
  },

  setIssuedCredentials: (credentials) => {
    set({ issuedCredentials: credentials });
  },

  setLoading: (loading) => {
    set({ loading });
  },
}));
</file>

<file path="src/store/did.store.ts">
// src/store/did.store.ts - Updated with persistence
import { create } from 'zustand';
import { persist } from 'zustand/middleware';
import { DID_STATUS } from '@/lib/utils/constants';

interface PublicKey {
  id: string;
  keyType: string;
  publicKey: string;
  addedAt: number;
}

interface DIDState {
  hasDID: boolean;
  status: typeof DID_STATUS[keyof typeof DID_STATUS];
  didAddress: string | null;
  publicKeys: PublicKey[];
  isInstitution: boolean;
  institutionName: string | null;
  createdAt: number | null;
  setDID: (didAddress: string, publicKeys: PublicKey[]) => void;
  setInstitution: (name: string) => void;
  setStatus: (status: typeof DID_STATUS[keyof typeof DID_STATUS]) => void;
  addPublicKey: (key: PublicKey) => void;
  removePublicKey: (keyId: string) => void;
  clearDID: () => void;
  // New methods for checking DID existence
  checkDIDExists: () => boolean;
  loadDIDFromStorage: () => void;
}

export const useDIDStore = create<DIDState>()(
  persist(
    (set, get) => ({
      hasDID: false,
      status: DID_STATUS.NONE,
      didAddress: null,
      publicKeys: [],
      isInstitution: false,
      institutionName: null,
      createdAt: null,

      setDID: (didAddress, publicKeys) => {
        set({
          hasDID: true,
          didAddress,
          publicKeys,
          status: DID_STATUS.ACTIVE,
          createdAt: Date.now(),
        });
      },

      setInstitution: (name) => {
        set({
          isInstitution: true,
          institutionName: name,
        });
      },

      setStatus: (status) => {
        set({ status });
      },

      addPublicKey: (key) => {
        set((state) => ({
          publicKeys: [...state.publicKeys, key],
        }));
      },

      removePublicKey: (keyId) => {
        set((state) => ({
          publicKeys: state.publicKeys.filter(key => key.id !== keyId),
        }));
      },

      clearDID: () => {
        set({
          hasDID: false,
          status: DID_STATUS.NONE,
          didAddress: null,
          publicKeys: [],
          isInstitution: false,
          institutionName: null,
          createdAt: null,
        });
      },

      checkDIDExists: () => {
        const state = get();
        return state.hasDID && state.didAddress !== null;
      },

      loadDIDFromStorage: () => {
        // This will be called automatically by the persist middleware
        // but we can also call it manually if needed
        const state = get();
        if (state.didAddress) {
          console.log(' DID loaded from storage:', state.didAddress);
        }
      },
    }),
    {
      name: 'academic-verify-did-storage', // unique name for localStorage key
      // Optionally, you can customize what gets persisted
      partialize: (state) => ({
        hasDID: state.hasDID,
        status: state.status,
        didAddress: state.didAddress,
        publicKeys: state.publicKeys,
        isInstitution: state.isInstitution,
        institutionName: state.institutionName,
        createdAt: state.createdAt,
      }),
    }
  )
);
</file>

<file path="src/store/notifications.store.ts">
// src/store/notifications.store.ts
import { create } from 'zustand';

export type NotificationType = 
  | 'request_received'
  | 'request_approved'
  | 'request_rejected'
  | 'credential_issued'
  | 'credential_revoked'
  | 'endorsement_received'
  | 'system';

export interface Notification {
  id: string;
  type: NotificationType;
  title: string;
  message: string;
  read: boolean;
  createdAt: number;
  actionUrl?: string;
  metadata?: Record<string, any>;
}

interface NotificationsState {
  notifications: Notification[];
  unreadCount: number;
  
  addNotification: (notification: Omit<Notification, 'id' | 'read' | 'createdAt'>) => void;
  markAsRead: (id: string) => void;
  markAllAsRead: () => void;
  removeNotification: (id: string) => void;
  clearAll: () => void;
  getUnreadCount: () => number;
}

export const useNotificationsStore = create<NotificationsState>((set, get) => ({
  notifications: [],
  unreadCount: 0,

  addNotification: (notification) => {
    const newNotification: Notification = {
      ...notification,
      id: 'notif_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9),
      read: false,
      createdAt: Date.now(),
    };

    set((state) => ({
      notifications: [newNotification, ...state.notifications],
      unreadCount: state.unreadCount + 1,
    }));
  },

  markAsRead: (id) => {
    set((state) => ({
      notifications: state.notifications.map((n) =>
        n.id === id ? { ...n, read: true } : n
      ),
      unreadCount: Math.max(0, state.unreadCount - 1),
    }));
  },

  markAllAsRead: () => {
    set((state) => ({
      notifications: state.notifications.map((n) => ({ ...n, read: true })),
      unreadCount: 0,
    }));
  },

  removeNotification: (id) => {
    set((state) => {
      const notification = state.notifications.find((n) => n.id === id);
      const wasUnread = notification && !notification.read;
      
      return {
        notifications: state.notifications.filter((n) => n.id !== id),
        unreadCount: wasUnread ? Math.max(0, state.unreadCount - 1) : state.unreadCount,
      };
    });
  },

  clearAll: () => {
    set({ notifications: [], unreadCount: 0 });
  },

  getUnreadCount: () => {
    return get().unreadCount;
  },
}));

// Helper function to create notifications for common events
export const createNotification = {
  requestReceived: (requesterName: string, programName: string) => ({
    type: 'request_received' as const,
    title: 'New Credential Request',
    message: `${requesterName} has requested a credential for ${programName}`,
    actionUrl: '/institution/requests',
  }),

  requestApproved: (institutionName: string, programName: string) => ({
    type: 'request_approved' as const,
    title: 'Request Approved',
    message: `${institutionName} approved your request for ${programName}`,
    actionUrl: '/my-requests',
  }),

  requestRejected: (institutionName: string, programName: string) => ({
    type: 'request_rejected' as const,
    title: 'Request Rejected',
    message: `${institutionName} rejected your request for ${programName}`,
    actionUrl: '/my-requests',
  }),

  credentialIssued: (institutionName: string, credentialType: string) => ({
    type: 'credential_issued' as const,
    title: 'Credential Issued',
    message: `${institutionName} issued your ${credentialType}`,
    actionUrl: '/credentials',
  }),

  credentialRevoked: (institutionName: string, credentialType: string) => ({
    type: 'credential_revoked' as const,
    title: 'Credential Revoked',
    message: `Your ${credentialType} from ${institutionName} has been revoked`,
    actionUrl: '/credentials',
  }),

  endorsementReceived: (endorserName: string) => ({
    type: 'endorsement_received' as const,
    title: 'New Endorsement',
    message: `${endorserName} endorsed your institution`,
    actionUrl: '/institution',
  }),
};
</file>

<file path="src/store/ui.store.ts">
// ui.store.ts
import { create } from 'zustand';

interface UIState {
  theme: 'light' | 'dark' | 'system';
  sidebarOpen: boolean;
  setTheme: (theme: 'light' | 'dark' | 'system') => void;
  toggleSidebar: () => void;
  setSidebarOpen: (open: boolean) => void;
}

export const useUIStore = create<UIState>((set) => ({
  theme: 'system',
  sidebarOpen: true,

  setTheme: (theme) => {
    set({ theme });
    // Apply theme to document
    if (theme === 'dark') {
      document.documentElement.classList.add('dark');
    } else if (theme === 'light') {
      document.documentElement.classList.remove('dark');
    } else {
      // System theme
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (isDark) {
        document.documentElement.classList.add('dark');
      } else {
        document.documentElement.classList.remove('dark');
      }
    }
  },

  toggleSidebar: () => {
    set((state) => ({ sidebarOpen: !state.sidebarOpen }));
  },

  setSidebarOpen: (open) => {
    set({ sidebarOpen: open });
  },
}));
</file>

<file path="src/store/wallet.store.ts">
// src/store/wallet.store.ts
import { create } from 'zustand';

interface Account {
  address: string;
  name?: string;
  source?: string;
}

interface WalletState {
  isConnected: boolean;
  account: Account | null;
  accounts: Account[];
  balance: string;
  disconnectWallet: () => void;
  selectAccount: (address: string) => void;
  setBalance: (balance: string) => void;
}

export const useWalletStore = create<WalletState>()((set, get) => ({
  isConnected: false,
  account: null,
  accounts: [],
  balance: '0',

  disconnectWallet: () => {
    set({
      isConnected: false,
      account: null,
      accounts: [],
      balance: '0',
    });
    localStorage.removeItem('wallet_address');
  },

  selectAccount: (address: string) => {
    const account = get().accounts.find(acc => acc.address === address);
    if (account) {
      set({ account });
      localStorage.setItem('wallet_address', address);
    }
  },

  setBalance: (balance: string) => {
    set({ balance });
  },
}));
</file>

<file path="src/types/credentialRequest.types.ts">
// src/types/credentialRequest.types.ts

export type RequestStatus = 
  | 'pending' 
  | 'approved' 
  | 'rejected' 
  | 'fulfilled' 
  | 'cancelled';

export interface CredentialRequest {
  id: string;
  requestId: number; // On-chain ID
  requester: string; // DID address
  requesterName?: string;
  institution: string; // Institution DID
  institutionName?: string;
  
  // Request Details
  credentialType: string;
  programName: string;
  fieldOfStudy: string;
  startDate: string;
  endDate: string;
  expectedGraduationDate?: string;
  
  // Additional Info
  studentId?: string;
  major?: string;
  minor?: string;
  expectedGPA?: string;
  additionalNotes?: string;
  supportingDocuments?: string[]; // IPFS hashes
  
  // Status & Tracking
  status: RequestStatus;
  createdAt: number;
  updatedAt: number;
  reviewedAt?: number;
  reviewedBy?: string;
  rejectionReason?: string;
  
  // Blockchain Info
  blockNumber?: number;
  transactionHash?: string;
}

export interface CreateRequestFormData {
  institution: string;
  credentialType: string;
  programName: string;
  fieldOfStudy: string;
  startDate: string;
  endDate: string;
  expectedGraduationDate?: string;
  studentId?: string;
  major?: string;
  minor?: string;
  expectedGPA?: string;
  additionalNotes?: string;
  supportingDocuments?: File[];
}

export interface ReviewRequestData {
  requestId: string;
  action: 'approve' | 'reject';
  rejectionReason?: string;
  notes?: string;
}

export const REQUEST_STATUS_CONFIG = {
  pending: {
    label: 'Pending Review',
    color: 'yellow',
    icon: 'Clock',
    description: 'Waiting for institution review'
  },
  approved: {
    label: 'Approved',
    color: 'green',
    icon: 'CheckCircle',
    description: 'Approved, credential pending issuance'
  },
  rejected: {
    label: 'Rejected',
    color: 'red',
    icon: 'XCircle',
    description: 'Request was rejected'
  },
  fulfilled: {
    label: 'Fulfilled',
    color: 'blue',
    icon: 'Award',
    description: 'Credential has been issued'
  },
  cancelled: {
    label: 'Cancelled',
    color: 'gray',
    icon: 'Ban',
    description: 'Request was cancelled'
  }
} as const;
</file>

<file path="src/App.css">
#root {
  max-width: 1280px;
  margin: 0 auto;
  padding: 2rem;
  text-align: center;
}

.logo {
  height: 6em;
  padding: 1.5em;
  will-change: filter;
  transition: filter 300ms;
}
.logo:hover {
  filter: drop-shadow(0 0 2em #646cffaa);
}
.logo.react:hover {
  filter: drop-shadow(0 0 2em #61dafbaa);
}

@keyframes logo-spin {
  from {
    transform: rotate(0deg);
  }
  to {
    transform: rotate(360deg);
  }
}

@media (prefers-reduced-motion: no-preference) {
  a:nth-of-type(2) .logo {
    animation: logo-spin infinite 20s linear;
  }
}

.card {
  padding: 2em;
}

.read-the-docs {
  color: #888;
}
</file>

<file path="src/App.tsx">
// src/App.tsx - Complete with Admin Route
import { BrowserRouter as Router, Routes, Route } from 'react-router-dom';
import { QueryClient, QueryClientProvider } from '@tanstack/react-query';
import { Toaster } from 'sonner';
import { Suspense } from 'react';

// Layout
import MainLayout from './components/layout/MainLayout';

// Pages
import Home from './pages/Home';
import Dashboard from './pages/Dashboard';
import Credentials from './pages/Credentials';
import Institution from './pages/Institution';
import IssueCredential from './pages/IssueCredential';
import IssuedCredentials from './pages/IssuedCredentials';
import Verify from './pages/Verify';
import Institutions from './pages/Institutions';
import Settings from './pages/Settings';
import CreateDIDPage from './pages/CreateDIDPage';
import MyRequests from './pages/MyRequests';
import InstitutionRequests from './pages/InstitutionRequests';
import AdminVerification from './pages/AdminVerification';
import InstitutionRegistration from './components/did/InstitutionRegistration';

// Error Boundary
import ErrorBoundary from './components/error/ErrorBoundary';

// UI
import { Spinner } from './components/ui/Spinner';

// Providers
import { PolkadotProvider } from './providers/PolkadotProvider';
import { WalletProvider } from './providers/WalletProvider';

const queryClient = new QueryClient({
  defaultOptions: {
    queries: {
      refetchOnWindowFocus: false,
      retry: 1,
      staleTime: 5 * 60 * 1000,
    },
  },
});

// Loading fallback
const LoadingFallback = () => (
  <div className="flex items-center justify-center min-h-[60vh]">
    <div className="text-center">
      <Spinner size="lg" className="mx-auto mb-4" />
      <p className="text-muted-foreground">Loading...</p>
    </div>
  </div>
);

function App() {
  return (
    <ErrorBoundary>
      <QueryClientProvider client={queryClient}>
        <PolkadotProvider>
          <WalletProvider>
            <Router>
              <Suspense fallback={<LoadingFallback />}>
                <MainLayout>
                  <Routes>
                    {/* Public Routes */}
                    <Route path="/" element={<Home />} />
                    <Route path="/verify" element={<Verify />} />
                    <Route path="/institutions" element={<Institutions />} />
                    
                    {/* User Routes */}
                    <Route path="/dashboard" element={<Dashboard />} />
                    <Route path="/create-did" element={<CreateDIDPage />} />
                    <Route path="/credentials" element={<Credentials />} />
                    <Route path="/my-requests" element={<MyRequests />} />
                    <Route path="/settings" element={<Settings />} />
                    
                    {/* Institution Routes */}
                    <Route path="/institution" element={<Institution />} />
                    <Route path="/institution/register" element={<InstitutionRegistration />} />
                    <Route path="/institution/issue" element={<IssueCredential />} />
                    <Route path="/institution/issued" element={<IssuedCredentials />} />
                    <Route path="/institution/requests" element={<InstitutionRequests />} />
                    
                    {/* Admin Routes */}
                    <Route path="/admin/verify-institutions" element={<AdminVerification />} />
                  </Routes>
                </MainLayout>
              </Suspense>
            </Router>
            <Toaster position="top-right" richColors />
          </WalletProvider>
        </PolkadotProvider>
      </QueryClientProvider>
    </ErrorBoundary>
  );
}

export default App;
</file>

<file path="src/index.css">
@import "tailwindcss";

/* Custom theme configuration for Tailwind v4 */
@theme {
  --color-primary: #3b82f6;
  --color-primary-foreground: #ffffff;
  --color-secondary: #64748b;
  --color-secondary-foreground: #ffffff;
  --color-destructive: #ef4444;
  --color-destructive-foreground: #ffffff;
  --color-muted: #f1f5f9;
  --color-muted-foreground: #64748b;
  --color-accent: #f1f5f9;
  --color-accent-foreground: #0f172a;
  --color-card: #ffffff;
  --color-card-foreground: #0f172a;
  --color-background: #ffffff;
  --color-foreground: #0f172a;
  --color-border: #e2e8f0;
  --color-input: #e2e8f0;
  --color-ring: #3b82f6;
  
  --radius-lg: 0.5rem;
  --radius-md: calc(0.5rem - 2px);
  --radius-sm: calc(0.5rem - 4px);
}

/* Dark mode theme */
@media (prefers-color-scheme: dark) {
  @theme {
    --color-primary: #3b82f6;
    --color-primary-foreground: #ffffff;
    --color-secondary: #475569;
    --color-secondary-foreground: #ffffff;
    --color-destructive: #ef4444;
    --color-destructive-foreground: #ffffff;
    --color-muted: #1e293b;
    --color-muted-foreground: #94a3b8;
    --color-accent: #1e293b;
    --color-accent-foreground: #f1f5f9;
    --color-card: #0f172a;
    --color-card-foreground: #f1f5f9;
    --color-background: #020617;
    --color-foreground: #f1f5f9;
    --color-border: #1e293b;
    --color-input: #1e293b;
    --color-ring: #3b82f6;
  }
}

.dark {
  --color-primary: #3b82f6;
  --color-primary-foreground: #ffffff;
  --color-secondary: #475569;
  --color-secondary-foreground: #ffffff;
  --color-destructive: #ef4444;
  --color-destructive-foreground: #ffffff;
  --color-muted: #1e293b;
  --color-muted-foreground: #94a3b8;
  --color-accent: #1e293b;
  --color-accent-foreground: #f1f5f9;
  --color-card: #0f172a;
  --color-card-foreground: #f1f5f9;
  --color-background: #020617;
  --color-foreground: #f1f5f9;
  --color-border: #1e293b;
  --color-input: #1e293b;
  --color-ring: #3b82f6;
}

/* Base styles */
* {
  border-color: var(--color-border);
}

body {
  background-color: var(--color-background);
  color: var(--color-foreground);
  font-family: system-ui, -apple-system, sans-serif;
}
</file>

<file path="src/main.tsx">
import { StrictMode } from 'react'
import { createRoot } from 'react-dom/client'
import './index.css'
import App from './App.tsx'

createRoot(document.getElementById('root')!).render(
  <StrictMode>
    <App />
  </StrictMode>,
)
</file>

<file path="src/vite-env.d.ts">
/// <reference types="vite/client" />

declare module '*.css';
</file>

<file path=".env.example">
// .env.example
# Blockchain Connection
# For local development, use local node
VITE_WS_PROVIDER=ws://127.0.0.1:9944

# For testnet deployment (update when ready)
# VITE_WS_PROVIDER=wss://your-testnet-url.com

# Chain Configuration
VITE_CHAIN_NAME=Academic Verification Chain
VITE_TOKEN_SYMBOL=AVC
VITE_TOKEN_DECIMALS=12

# Application
VITE_APP_NAME=Academic Verify
VITE_APP_VERSION=1.0.0

# Features (enable/disable features)
VITE_ENABLE_DEMO_MODE=true
VITE_DEMO_CREDENTIALS=true
</file>

<file path=".gitignore">
# Logs
logs
*.log
npm-debug.log*
yarn-debug.log*
yarn-error.log*
pnpm-debug.log*
lerna-debug.log*

node_modules
dist
dist-ssr
*.local

# Editor directories and files
.vscode/*
!.vscode/extensions.json
.idea
.DS_Store
*.suo
*.ntvs*
*.njsproj
*.sln
*.sw?
</file>

